C51 COMPILER V9.54   MAIN                                                                  12/22/2017 10:20:18 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /********************************************************************************
   2          实验功能：第四界省赛程序设计
   3          时间：2017.12.23
   4          作者：吴康
   5          *********************************************************************************/
   6          #include <STC15F2K60S2.h>
   7          #include <intrins.h>
   8          #include <ds1302.h>
   9          #include <iic.h>
  10          
  11          #define uint unsigned int
  12          #define uchar unsigned char
  13          
  14          uchar code tab[]={0XC0,0XF9,0XA4,0XB0,0X99,0X92,0X82,0XF8,0X80,0X90,0XBF,0XFF};
  15          uchar dsbuff[8]={11,11,11,11,11,11,11,11};
  16          uchar s7=0,s6=0,s5=0,s4=0;  //按键设置标志位
  17          uchar discount = 0;         //数码管显示控制变量
  18          uchar jia=0,jian=0;         //在自动状态下，用作设置阈值的按键标志位
  19          uchar adc =0;               //读出来的数据存储变量
  20          uchar yuzhi=50;             //初始阈值
  21          
  22          /********************************************************************************
  23          函数名称：delayms
  24          功能：延时函数
  25          *********************************************************************************/
  26          void delayms(uint xms)
  27          {
  28   1        uint i,j;
  29   1        for(i=xms;i>0;i--)
  30   1        for(j=110;j>0;j--);
  31   1      }
  32          
  33          /********************************************************************************
  34          函数名称：allinit
  35          功能：板子整体初始化函数
  36          *********************************************************************************/
  37          void allinit()
  38          {
  39   1        P2=0xa0;P0=0x00;//关闭蜂鸣器继电器
  40   1        P2=0x80;P0=0xff;//关闭所有LED灯
  41   1        P2=0xc0;P0=0xff;//选中所有数码管
  42   1        P2=0xe0;P0=0xff;//关闭所有数码管
  43   1      }
  44          
  45          /********************************************************************************
  46          函数名称：display
  47          功能：显示函数
  48          *********************************************************************************/
  49          void display()
  50          {
  51   1        P2=0xef;
  52   1        P0=0xff;
  53   1        P2=0x1f;
  54   1        
C51 COMPILER V9.54   MAIN                                                                  12/22/2017 10:20:18 PAGE 2   

  55   1        P2=0xcf;
  56   1        P0=1<<discount;
  57   1        P2=0x1f;
  58   1        
  59   1        P2=0xef;
  60   1        P0=tab[dsbuff[discount]];
  61   1        P2=0x1f;
  62   1        
  63   1        if(++discount==8) discount=0;
  64   1      }
  65          
  66          /********************************************************************************
  67          函数名称：Timer0Init
  68          功能：定时器0初始化函数
  69          *********************************************************************************/
  70          void Timer0Init(void)   //2毫秒@11.0592MHz
  71          {
  72   1        AUXR |= 0x80;         //定时器时钟1T模式
  73   1        TMOD &= 0xF0;         //设置定时器模式
  74   1        TL0 = 0x9A;           //设置定时初值
  75   1        TH0 = 0xA9;           //设置定时初值
  76   1        TF0 = 0;              //清除TF0标志
  77   1        TR0 = 1;              //定时器0开始计时
  78   1        EA=1;
  79   1        ET0=1;
  80   1      }
  81          
  82          /********************************************************************************
  83          函数名称：key
  84          功能：按键初始化函数
  85          *********************************************************************************/
  86          void key()
  87          {
  88   1        if(P30==0)
  89   1          {
  90   2            delayms(10);
  91   2            if(P30==0)
  92   2              {
  93   3                if(s7==0) s7=1;       //s7=1手动状态，s7=0自动状态
  94   3                else if(s7==1) s7=0;
  95   3              }
  96   2            while(!P30);
  97   2          }
  98   1        
  99   1        if(P31==0)
 100   1          {
 101   2            delayms(10);
 102   2            if(P31==0)
 103   2            {
 104   3              if(s6==0) s6=1;
 105   3                else if(s6==1) 
 106   3                  {
 107   4                    s6=0;
 108   4                    write_date(0x22,yuzhi);//将设定的阈值存储在0x22地址里
 109   4                  }
 110   3            }
 111   2            while(!P31);
 112   2          }
 113   1        
 114   1        if(P32==0)
 115   1          {
 116   2            delayms(10);
C51 COMPILER V9.54   MAIN                                                                  12/22/2017 10:20:18 PAGE 3   

 117   2            if(P32==0)
 118   2              {
 119   3                s5=1;
 120   3                jia=1;
 121   3              }
 122   2            while(!P32);
 123   2          }
 124   1        
 125   1        if(P33==0)
 126   1          {
 127   2            delayms(10);
 128   2            if(P33==0)
 129   2              {
 130   3                s5=0;
 131   3                jian=1;
 132   3              }
 133   2            while(!P33);
 134   2          }
 135   1      }
 136          
 137          /********************************************************************************
 138          函数名称：main
 139          功能：主函数
 140          *********************************************************************************/
 141          void main()
 142          {
 143   1        allinit();
 144   1        Timer0Init();
 145   1        ds_write();
 146   1        yuzhi=read_date(0x22);
 147   1        while(1)
 148   1        {
 149   2          key();
 150   2          adc=read_adc(0x03);
 151   2          ds_read();
 152   2          if(s7==1)//手动状态
 153   2            {
 154   3              P2=0x80;
 155   3              P0=0xfd;
 156   3              dsbuff[7]=adc%10;
 157   3              dsbuff[6]=adc/10;
 158   3              dsbuff[5]=11;
 159   3              dsbuff[4]=shijian[1]%10;
 160   3              dsbuff[3]=shijian[1]/10;
 161   3              dsbuff[2]=10;
 162   3              dsbuff[1]=shijian[2]%10;
 163   3              dsbuff[0]=shijian[2]/10;
 164   3              if((s6==0)&&adc<yuzhi)
 165   3                {
 166   4                    P2=0xa0;
 167   4                    P0=0x40;
 168   4                    if(s5==1)             //如果s5按下，打开继电器
 169   4                      {
 170   5                        P2=0xa0;
 171   5                        P0=0x50;    
 172   5                      }
 173   4                    else 
 174   4                      {
 175   5                        P2=0xa0;
 176   5                        P0=0x40;
 177   5                      }
 178   4                }
C51 COMPILER V9.54   MAIN                                                                  12/22/2017 10:20:18 PAGE 4   

 179   3              else if((s6==0)&&(adc>=yuzhi))//判断按键是否按下，按下了将存储在0x22地址里的数据读出来进行比较
 180   3                {
 181   4                    P2=0xa0;
 182   4                    P0=0x00;
 183   4                  if(s5==1)
 184   4                    {
 185   5                      P2=0xa0;
 186   5                      P0=0x10;    
 187   5                    }
 188   4                  else 
 189   4                    {
 190   5                      P2=0xa0;
 191   5                      P0=0x00;
 192   5                    }
 193   4                }
 194   3                if(s6==1)
 195   3                    {
 196   4                      P2=0xa0;
 197   4                      P0=0x00;
 198   4                      if(s5==1)
 199   4                        {
 200   5                          P2=0xa0;
 201   5                          P0=0x10;      
 202   5                        }
 203   4                      else 
 204   4                        {
 205   5                          P2=0xa0;
 206   5                          P0=0x00;
 207   5                        }
 208   4                    }
 209   3          }
 210   2        else 
 211   2         {
 212   3          P2=0x80;
 213   3          P0=0xfe;
 214   3          if(adc<yuzhi)   //自动状态下，将存储的数据进行比较
 215   3            {
 216   4              P2=0xa0;
 217   4              P0=0x10;
 218   4            }
 219   3          else 
 220   3            {
 221   4              P2=0xa0;
 222   4              P0=0x00;
 223   4            }
 224   3          if(s6==1)
 225   3            {
 226   4              dsbuff[7]=yuzhi%10;
 227   4              dsbuff[6]=yuzhi/10;
 228   4              dsbuff[5]=11;
 229   4              dsbuff[4]=11;
 230   4              dsbuff[3]=11;
 231   4              dsbuff[2]=11;    
 232   4              dsbuff[1]=10;
 233   4              dsbuff[0]=10;
 234   4              if(jia==1)
 235   4                {
 236   5                  yuzhi+=1;
 237   5                  jia=0;
 238   5                }
 239   4              if(jian==1)
 240   4                {
C51 COMPILER V9.54   MAIN                                                                  12/22/2017 10:20:18 PAGE 5   

 241   5                  yuzhi-=1;
 242   5                  jian=0;
 243   5                }   
 244   4            }
 245   3          else 
 246   3            { 
 247   4              dsbuff[7]=adc%10;
 248   4              dsbuff[6]=adc/10;
 249   4              dsbuff[4]=shijian[1]%10;
 250   4              dsbuff[3]=shijian[1]/10;
 251   4              dsbuff[2]=10; 
 252   4              dsbuff[1]=shijian[2]%10;
 253   4              dsbuff[0]=shijian[2]/10;
 254   4            }
 255   3         }
 256   2        }
 257   1      }
 258          
 259          /********************************************************************************
 260          函数名称：Timer0
 261          功能：定时器0的中断服务函数
 262          *********************************************************************************/
 263          void Timer0() interrupt 1
 264          {
 265   1        display();
 266   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    635    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     17    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
