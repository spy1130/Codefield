C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.h>
   2          #include <delay.h>
   3          #include <key.h>
   4          #include <iic.h>
   5          
   6          #define uchar unsigned char 
   7          #define uint unsigned int
   8          
   9          #define TX P10
  10          #define RX P11
  11          
  12          uchar tab[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
  13          uchar dsbuff[8]={1,2,3,4,5,6,7,8};
  14          uchar ceju_flag=0;
  15          uchar count_2=0;
  16          uchar time_1,time_2;
  17          uchar led_state=0;
  18          uchar liang_1,liang_2;
  19          uint count_3=0,k; 
  20          uchar flag_1=0;
  21          uchar count_4=0,count_5;
  22          uchar liang4=0;
  23          uchar discount=0;
  24          uchar count_1=0;
  25          uchar ceju_finish=0;
  26          uchar s_liang;
  27          uchar vol,type; 
  28          uint distance;
  29          
  30          void allinit()
  31          {
  32   1        P2=0x80;P0=0xff;
  33   1        P2=0xa0;P0=0x00;
  34   1        P2=0xc0;P0=0xff;
  35   1        P2=0xe0;P0=0xff;
  36   1      }
  37          
  38          void led(uchar liang)
  39          {
  40   1        P2=P2&0x1f;
  41   1        P2=0x80;
  42   1        P0=liang;
  43   1        P2=P2&0x1f;
  44   1      }
  45          
  46          void display()
  47          {
  48   1        P2=(P2&0x1f)|0xe0;
  49   1        P0=0xff;
  50   1        P2=(P2&0x1f);
  51   1        
  52   1        P2=(P2&0x1f)|0xc0;
  53   1        P0=1<<discount;
  54   1        P2=(P2&0x1f);
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 2   

  55   1      
  56   1        P2=(P2&0x1f)|0xe0;
  57   1        P0=tab[dsbuff[discount]];
  58   1        P2=(P2&0x1f);
  59   1        
  60   1        if(++discount==8) discount=0;
  61   1      }
  62          
  63          void sendwave()
  64          {
  65   1        uchar i;
  66   1        for(i=0;i<1;i++)
  67   1        {
  68   2          TX=1;
  69   2          Delay12us();
  70   2          TX=0;
  71   2        }
  72   1      }
  73          
  74          unsigned int get_distance()
  75          {
  76   1        uint dis;
  77   1        RX=1;
  78   1        sendwave();
  79   1        TR1=1;
  80   1        while((RX)&&(!TF1));
  81   1        TR1=0;
  82   1        if(TF1==1)
  83   1        {
  84   2          TF1=0;
  85   2          dis=0;
  86   2        }
  87   1        else 
  88   1        {
  89   2          dis=(TH1<<8)|TL1;
  90   2          dis=dis*0.017;
  91   2        }
  92   1        TH1=TL1=0;  //≤ª“™Õ¸º«»Ìº˛«Â¡„
  93   1        return dis;
  94   1      }
  95          
  96          void key_handle()
  97          {
  98   1        if(s4==1)//s4∞¥º¸∞¥œ¬
  99   1        {
 100   2          if(time>0)//≈–∂œµπº∆ ± ±º‰ «∑ÒµΩ¡„
 101   2          {
 102   3            jidian(1);
 103   3            if(s5==0)//ΩÙº±∞¥º¸s5√ª”–∞¥œ¬
 104   3            {
 105   4              dsbuff[0]=2;
 106   4              dsbuff[1]=11;
 107   4              dsbuff[2]=11;
 108   4              dsbuff[3]=11;
 109   4              dsbuff[4]=11;
 110   4              dsbuff[5]=11;
 111   4              dsbuff[6]=time/10;
 112   4              dsbuff[7]=time%10;
 113   4            }
 114   3            else//ΩÙº±∞¥º¸s5∞¥œ¬¡À
 115   3            {
 116   4              jidian(0);
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 3   

 117   4              dsbuff[0]=2;
 118   4              dsbuff[1]=11;
 119   4              dsbuff[2]=11;
 120   4              dsbuff[3]=11;
 121   4              dsbuff[4]=11;
 122   4              dsbuff[5]=11;
 123   4              dsbuff[6]=time/10;
 124   4              dsbuff[7]=time%10;
 125   4            }
 126   3          }
 127   2          else jidian(0);   //µπº∆ ± ±º‰Ω· ¯∫Ûπÿ±’ºÃµÁ∆˜    
 128   2        }
 129   1        if(s6==1)//≈–∂œs6∞¥º¸∞¥œ¬¡À
 130   1        {
 131   2          if(ss==1)//≈–∂œ «“ª¿‡ªıŒÔ
 132   2          {
 133   3            if(s7==1)
 134   3            {
 135   4              s7=0;
 136   4              time_1++;
 137   4              if(time_1>10) time_1=1;
 138   4            }
 139   3          }
 140   2          if(ss==2)//≈–∂œ «∂˛¿‡ªıŒÔ
 141   2          {
 142   3            if(s7==1)
 143   3            {
 144   4              s7=0;
 145   4              time_2++;
 146   4              if(time_2>10) time_2=1;
 147   4            } 
 148   3          }
 149   2          if(ss==3)//±£¥ÊµΩeeprom£¨πÿ±’ ˝¬Îπ‹œ‘ æ
 150   2          {
 151   3            iicwrite(0x01,time_1);
 152   3            Delay2ms();
 153   3            iicwrite(0x02,time_2);
 154   3          }
 155   2        }
 156   1      }
 157          
 158          void type_identify()
 159          {
 160   1        if(ceju_flag==1)//
 161   1          {
 162   2            distance=get_distance();
 163   2            ceju_flag=0;
 164   2          }
 165   1        if(distance<=30)//≈–∂œ «“ª¿‡ªıŒÔ£¨ªπ «∂˛¿‡ªıŒÔ
 166   1        type=1;
 167   1        else type=2;
 168   1        if(s4==0)//≥ı ºªØœ‘ æΩÁ√Ê
 169   1        {
 170   2          dsbuff[0]=1;
 171   2          dsbuff[1]=11;
 172   2          dsbuff[2]=11;
 173   2          dsbuff[3]=distance/10;
 174   2          dsbuff[4]=distance%10;
 175   2          dsbuff[5]=11;//’‚¿Ôø…“‘œ‘ æ≤…ºØµƒµÁ—π
 176   2          dsbuff[6]=11;
 177   2          dsbuff[7]=type;
 178   2          
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 4   

 179   2      //    dsbuff[0]=1;
 180   2      //    dsbuff[1]=11;
 181   2      //    dsbuff[2]=distance/10;
 182   2      //    dsbuff[3]=distance%10;
 183   2      //    dsbuff[4]=vol/100;
 184   2      //    dsbuff[5]=vol%10/10;//’‚¿Ôø…“‘œ‘ æ≤…ºØµƒµÁ—π
 185   2      //    dsbuff[6]=vol%10;
 186   2      //    dsbuff[7]=type;
 187   2        }
 188   1        ceju_finish=1;        
 189   1      }
 190          void pressure_handle() //ø’‘ÿπ˝‘ÿºÏ≤‚∫Ø ˝
 191          {
 192   1        if(++k==1000)         //Ad≤…ºØ≤ªƒ‹¡¨–¯≤… ”√1000¥Œ≤…“ª¥Œ ±»ΩœŒ»∂®
 193   1        {
 194   2          vol=adread(0x03);
 195   2          k=0;
 196   2        }
 197   1        if(vol<51)//≈–∂œµÁ—π «∑Ò–°”⁄1V
 198   1        {   
 199   2          if(kongzai==0)  
 200   2          {
 201   3            led(0xfe);//L1µ„¡¡  
 202   3            fengming(0);
 203   3          }
 204   2          kongzai=1;
 205   2          normal=0;
 206   2          guozai=0;
 207   2          if(s6==0)//s6∞¥º¸√ª”–∞¥œ¬,œ®√À˘”– ˝¬Îπ‹
 208   2           {
 209   3              dsbuff[0]=11;
 210   3              dsbuff[1]=11;
 211   3              dsbuff[2]=11;
 212   3              dsbuff[3]=11;
 213   3              dsbuff[4]=11;
 214   3              dsbuff[5]=11;
 215   3              dsbuff[6]=11;
 216   3              dsbuff[7]=11;
 217   3           }
 218   2        }
 219   1        else if((vol>=51)&&(vol<204))//≈–∂œµÁ—π «∑Ò¥Û”⁄1V£¨–°”⁄4V
 220   1        { 
 221   2          kongzai=0; 
 222   2          guozai=0;
 223   2          if((normal==1)&&(s5==0))
 224   2            {
 225   3              led(0xfd);
 226   3              fengming(0);
 227   3            }
 228   2          normal=1;
 229   2        }
 230   1        else if(vol>=204)//≈–∂œµÁ—π «∑Ò¥Û”⁄4V
 231   1        { 
 232   2          kongzai=0;
 233   2          normal=1;
 234   2          s4=0;
 235   2          s6=0;
 236   2          if((guozai==0)&&(normal==1))
 237   2          fengming(1);
 238   2          guozai=1;
 239   2        }   
 240   1      }
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 5   

 241          
 242          void Timer0Init(void)   //2∫¡√Î@11.0592MHz
 243          {
 244   1        AUXR |= 0x80;         //∂® ±∆˜ ±÷”1Tƒ£ Ω
 245   1        TMOD &= 0xF0;         //…Ë÷√∂® ±∆˜ƒ£ Ω
 246   1        TL0 = 0x9A;           //…Ë÷√∂® ±≥ı÷µ
 247   1        TH0 = 0xA9;           //…Ë÷√∂® ±≥ı÷µ
 248   1        TF0 = 0;              //«Â≥˝TF0±Í÷æ
 249   1        TR0 = 1;              //∂® ±∆˜0ø™ ºº∆ ±
 250   1        EA=1;
 251   1        ET0=1;
 252   1      }
 253           
 254          void Timer1Init(void)   //0Œ¢√Î@11.0592MHz
 255          {
 256   1        AUXR &= 0xBF;         //∂® ±∆˜ ±÷”12Tƒ£ Ω
 257   1        TMOD &= 0x0F;         //…Ë÷√∂® ±∆˜ƒ£ Ω
 258   1        TL1 = 0x00;           //…Ë÷√∂® ±≥ı÷µ
 259   1        TH1 = 0x00;           //…Ë÷√∂® ±≥ı÷µ
 260   1        TF1 = 0;              //«Â≥˝TF1±Í÷æ
 261   1      }
 262          
 263          
 264          void main()
 265          {
 266   1        allinit();
 267   1        Timer0Init();
 268   1        Timer1Init();
 269   1        time_1=iicread(0x01);
 270   1        Delay2ms();
 271   1        time_2=iicread(0x02);
 272   1        Delay2ms();
 273   1        while(1)
 274   1        { 
 275   2          pressure_handle();
 276   2          keyscan();//∞¥º¸≈–∂œ  ˝¬Îπ‹≥ÂÕªŒ Ã‚øº¬«
 277   2          key_handle();
 278   2          if(normal==1)
 279   2          {
 280   3            type_identify();//ªıŒÔ¿‡–Õ ∂±
 281   3            if((ceju_finish==1) && (s4==0))
 282   3            {
 283   4              if(type==1) time=time_1;
 284   4              else time=time_2;     
 285   4            }
 286   3          }
 287   2        }
 288   1      }
 289          
 290          void time0() interrupt 1
 291          {
 292   1        display();
 293   1        if(s6==1)
 294   1        {
 295   2          if(++count_5==250)
 296   2          {
 297   3            count_5=0;
 298   3            if(ss==1)
 299   3            {
 300   4              if(liang_1==0)
 301   4              {
 302   5                liang_1=1;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 6   

 303   5                dsbuff[0]=3;
 304   5                dsbuff[1]=11;
 305   5                dsbuff[2]=11;
 306   5                dsbuff[3]=11;
 307   5                dsbuff[4]=11;
 308   5                dsbuff[5]=11;
 309   5                dsbuff[6]=time_2/10;
 310   5                dsbuff[7]=time_2%10;
 311   5              }
 312   4              else 
 313   4              {
 314   5                liang_1=0;          
 315   5                dsbuff[0]=3;
 316   5                dsbuff[1]=11;
 317   5                dsbuff[2]=11;
 318   5                dsbuff[3]=time_1/10;
 319   5                dsbuff[4]=time_1%10;
 320   5                dsbuff[5]=11;
 321   5                dsbuff[6]=time_2/10;
 322   5                dsbuff[7]=time_2%10;
 323   5              }
 324   4            }
 325   3            if(ss==2)
 326   3            { 
 327   4              if(liang_2==0)
 328   4              {
 329   5                liang_2=1;                
 330   5                dsbuff[0]=3;
 331   5                dsbuff[1]=11;
 332   5                dsbuff[2]=11;
 333   5                dsbuff[3]=time_1/10;
 334   5                dsbuff[4]=time_1%10;
 335   5                dsbuff[5]=11;
 336   5                dsbuff[6]=11;
 337   5                dsbuff[7]=11;
 338   5        
 339   5              }
 340   4              else 
 341   4              {
 342   5                liang_2=0;          
 343   5                dsbuff[0]=3;
 344   5                dsbuff[1]=11;
 345   5                dsbuff[2]=11;
 346   5                dsbuff[3]=time_1/10;
 347   5                dsbuff[4]=time_1%10;
 348   5                dsbuff[5]=11;
 349   5                dsbuff[6]=time_2/10;
 350   5                dsbuff[7]=time_2%10;
 351   5              }
 352   4            }
 353   3            if(ss==3) //  ∫œ≤πss≤ª—≠ª∑µƒ ±∫Ú ≤π◊Ó∫Û“ª∏ˆœ‘ æº¥ø…   //ss—≠ª∑ ± ”…”⁄¡Ω÷÷…¡◊¥Ã¨≤ª¡¡µƒ «ª•≤πµƒ ‘Ú≤ª–Ë“™≤
             -πœ‘ æ
 354   3            {
 355   4      //        if((dsbuff[6]==11)&&(dsbuff[7]==11))
 356   4      //        {
 357   4      //          dsbuff[6]=time_2/10;
 358   4      //          dsbuff[7]=time_2%10;
 359   4                dsbuff[0]=11;
 360   4                dsbuff[1]=11;
 361   4                dsbuff[2]=11;
 362   4                dsbuff[3]=11;
 363   4                dsbuff[4]=11;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 7   

 364   4                dsbuff[5]=11;
 365   4                dsbuff[6]=11;
 366   4                dsbuff[7]=11;
 367   4      //        }
 368   4            }
 369   3          }
 370   2        }
 371   1        if((s4==1)&&(s5==0))  //µπº∆ ±≥Ã–Ú
 372   1        {
 373   2          ++count_3;
 374   2          if(count_3==500)
 375   2          {
 376   3            count_3=0;
 377   3            if(time>=1)
 378   3            time--;
 379   3          } 
 380   2        }
 381   1        if(s5==1)  //ΩÙº±Õ£÷π…¡À∏
 382   1        {
 383   2          ++count_4;
 384   2          if(count_4==250)
 385   2          {
 386   3            count_4=0;
 387   3            if(liang4==0)
 388   3            {
 389   4              liang4=1;
 390   4              led(0xf7);
 391   4            }
 392   3            else 
 393   3            {
 394   4              liang4=0;
 395   4              led(0xff);
 396   4            }
 397   3          }
 398   2        }
 399   1        if(normal==1)//≥¨…˘≤®≤‚æ‡Ãıº˛
 400   1        {
 401   2          ++count_2;
 402   2          if(count_2==100)
 403   2          {
 404   3            count_2=0;
 405   3            ceju_flag=1;  
 406   3          }
 407   2        }
 408   1        if(guozai==1) //π˝‘ÿ…¡À∏
 409   1        {
 410   2          ++count_1;
 411   2          if(count_1==250)
 412   2          {
 413   3            count_1=0;
 414   3            if(s_liang==0)
 415   3            {
 416   4              s_liang=1;
 417   4              led(0xfb);
 418   4            }
 419   3            else 
 420   3            {
 421   4              s_liang=0;
 422   4              led(0xff);
 423   4            }
 424   3          } 
 425   2        }
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 19:52:50 PAGE 8   

 426   1      }
 427          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1085    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
