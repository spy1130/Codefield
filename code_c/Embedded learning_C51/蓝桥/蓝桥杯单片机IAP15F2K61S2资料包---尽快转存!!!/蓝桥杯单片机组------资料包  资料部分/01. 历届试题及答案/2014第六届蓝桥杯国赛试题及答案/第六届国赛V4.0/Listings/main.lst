C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*****************************************************************************************
   2           µ—Èπ¶ƒ‹£∫µ⁄¡˘ΩÏπ˙»¸ ‘Ã‚≥Ã–Ú…Ëº∆
   3           ±º‰£∫2017.12.28
   4          ◊˜’ﬂ£∫Œ‚øµ
   5          ******************************************************************************************/
   6          #include <STC15F2K60S2.h>
   7          #include <delay.h>
   8          #include <key.h>
   9          #include <iic.h>
  10          
  11          #define uchar unsigned char 
  12          #define uint unsigned int
  13          
  14          #define TX P10
  15          #define RX P11
  16          
  17          uchar tab[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
  18          uchar dsbuff[8]={1,2,3,4,5,6,7,8};
  19          uchar ceju_flag=0;          //≤‚¡øæ‡¿Î±Í÷æŒª
  20          uchar count_2=0;            //º∆ ˝
  21          uchar time_1,time_2;        //…Ë÷√1¿‡ªıŒÔ£¨2¿‡ªıŒÔµƒµπº∆ ± ±º‰
  22          uchar liang_1,liang_2;      //‘⁄…Ë÷√1¿‡ªıŒÔ£¨2¿‡ªıŒÔµƒµπº∆ ± ±º‰ ±£¨»√ ˝¬Îπ‹…¡À∏µƒ±Í÷æŒª
  23          uchar count_4=0,count_5;    //º∆ ˝
  24          uchar liang4=0;             //L4µ∆“‘º‰∏Ù0.5√Î…¡À∏±Í÷æŒª
  25          uchar discount=0;           // ˝¬Îπ‹œ‘ æ
  26          uchar count_1=0;            //º∆ ˝
  27          uchar ceju_finish=0;        //≤‚¡øΩ· ¯ ±…Ë÷√µƒ±Í÷æŒª
  28          uchar s_liang;              //L3µ∆“‘º‰∏Ù0.5√Î…¡À∏±Í÷æŒª
  29          uchar vol;                  //≤…ºØµƒµÁ—π
  30          uchar type;                 //œ‘ æ «ƒƒ¿‡ªıŒÔ±Í÷æŒª
  31          uint  distance;             //æ‡¿Î
  32          uint  count_3=0,k;          //º∆ ˝
  33          
  34          /*****************************************************************************************
  35          ∫Ø ˝√˚≥∆£∫allinit
  36          π¶ƒ‹£∫∞Â◊”≥ı ºªØ
  37          ******************************************************************************************/
  38          void allinit()
  39          {
  40   1        P2=0x80;P0=0xff;
  41   1        P2=0xa0;P0=0x00;
  42   1        P2=0xc0;P0=0xff;
  43   1        P2=0xe0;P0=0xff;
  44   1      }
  45          
  46          /*****************************************************************************************
  47          ∫Ø ˝√˚≥∆£∫led
  48          π¶ƒ‹£∫led¡¡√øÿ÷∆∫Ø ˝
  49          ******************************************************************************************/
  50          void led(uchar liang)
  51          {
  52   1        P2=P2&0x1f;
  53   1        P2=0x80;
  54   1        P0=liang;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 2   

  55   1        P2=P2&0x1f;
  56   1      }
  57          
  58          /*****************************************************************************************
  59          ∫Ø ˝√˚≥∆£∫display
  60          π¶ƒ‹£∫œ‘ æ∫Ø ˝
  61          ******************************************************************************************/
  62          void display()
  63          {
  64   1        P2=(P2&0x1f)|0xe0;
  65   1        P0=0xff;
  66   1        P2=(P2&0x1f);
  67   1        
  68   1        P2=(P2&0x1f)|0xc0;
  69   1        P0=1<<discount;
  70   1        P2=(P2&0x1f);
  71   1        
  72   1        P2=(P2&0x1f)|0xe0;
  73   1        P0=tab[dsbuff[discount]];
  74   1        P2=(P2&0x1f);
  75   1        
  76   1        if(++discount==8) discount=0;
  77   1      }
  78          
  79          /*****************************************************************************************
  80          ∫Ø ˝√˚≥∆£∫sendwave
  81          π¶ƒ‹£∫≤˙…˙40KHZµƒ≤®–Œ∫Ø ˝
  82          ******************************************************************************************/
  83          void sendwave()
  84          {
  85   1        uchar i;
  86   1        for(i=0;i<1;i++)
  87   1        {
  88   2          TX=1;
  89   2          Delay12us();
  90   2          TX=0;
  91   2        }
  92   1      }
  93          
  94          /*****************************************************************************************
  95          ∫Ø ˝√˚≥∆£∫get_distance
  96          π¶ƒ‹£∫æ‡¿Îº∆À„∫Ø ˝
  97          ******************************************************************************************/
  98          unsigned int get_distance()
  99          {
 100   1        uint dis;
 101   1        sendwave();         //∑¢ÀÕ“ª∏ˆ40KHZµƒ∑Ω≤®
 102   1        TR1=1;              //∆Ù∂Ø∂® ±∆˜
 103   1        while((RX)&&(!TF1));//≈–∂œ «∑ÒΩ” ’–≈∫≈£¨∂® ±∆˜”–√ª”–“Á≥ˆ
 104   1        TR1=0;              //πÿ±’∂® ±∆˜
 105   1        if(TF1==1)          //≈–∂œ“Á≥ˆœ‘ æ0
 106   1        {
 107   2          TF1=0;
 108   2          dis=0;
 109   2        }
 110   1        else 
 111   1        {
 112   2          dis=(TH1<<8)|TL1;
 113   2          dis=dis*0.017;
 114   2        }
 115   1        TH1=TL1=0;          //≤ª“™Õ¸º«»Ìº˛«Â¡„
 116   1        return dis;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 3   

 117   1      }
 118          
 119          /*****************************************************************************************
 120          ∫Ø ˝√˚≥∆£∫key_handle
 121          π¶ƒ‹£∫∞¥º¸¥¶¿Ì∫Ø ˝
 122          ******************************************************************************************/
 123          void key_handle()
 124          {
 125   1        if(s4==1)             //s4∞¥º¸∞¥œ¬
 126   1        {
 127   2          if(time>0)          //≈–∂œµπº∆ ± ±º‰ «∑ÒµΩ¡„
 128   2          {
 129   3            jidian(1);        //¥Úø™ºÃµÁ∆˜
 130   3            if(s5==0)         //ΩÙº±∞¥º¸s5√ª”–∞¥œ¬
 131   3            {
 132   4              dsbuff[0]=2;
 133   4              dsbuff[1]=11;
 134   4              dsbuff[2]=11;
 135   4              dsbuff[3]=11;
 136   4              dsbuff[4]=11;
 137   4              dsbuff[5]=11;
 138   4              dsbuff[6]=time/10;
 139   4              dsbuff[7]=time%10;
 140   4            }
 141   3            else              //ΩÙº±∞¥º¸s5∞¥œ¬¡À
 142   3            {
 143   4              jidian(0);
 144   4              dsbuff[0]=2;
 145   4              dsbuff[1]=11;
 146   4              dsbuff[2]=11;
 147   4              dsbuff[3]=11;
 148   4              dsbuff[4]=11;
 149   4              dsbuff[5]=11;
 150   4              dsbuff[6]=time/10;
 151   4              dsbuff[7]=time%10;
 152   4            }
 153   3          }
 154   2          else jidian(0);     //µπº∆ ± ±º‰Ω· ¯∫Ûπÿ±’ºÃµÁ∆˜    
 155   2        }
 156   1        if(s6==1)             //≈–∂œs6∞¥º¸∞¥œ¬¡À
 157   1        {
 158   2          if(ss==1)           //≈–∂œ «“ª¿‡ªıŒÔ
 159   2          {
 160   3            if(s7==1)
 161   3            {
 162   4              s7=0;
 163   4              time_1++;
 164   4              if(time_1>10) time_1=1;
 165   4            }
 166   3          }
 167   2          if(ss==2)           //≈–∂œ «∂˛¿‡ªıŒÔ
 168   2          {
 169   3            if(s7==1)
 170   3            {
 171   4              s7=0;
 172   4              time_2++;
 173   4              if(time_2>10) time_2=1;
 174   4            } 
 175   3          }
 176   2          if(ss==3)           //±£¥ÊµΩeeprom£¨πÿ±’ ˝¬Îπ‹œ‘ æ
 177   2          {
 178   3            iicwrite(0x01,time_1);
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 4   

 179   3            Delay2ms();
 180   3            iicwrite(0x02,time_2);
 181   3            dsbuff[0]=11;
 182   3            dsbuff[1]=11;
 183   3            dsbuff[2]=11;
 184   3            dsbuff[3]=11;
 185   3            dsbuff[4]=11;
 186   3            dsbuff[5]=11;
 187   3            dsbuff[6]=11;
 188   3            dsbuff[7]=11;
 189   3          }
 190   2        }
 191   1      }
 192          
 193          /*****************************************************************************************
 194          ∫Ø ˝√˚≥∆£∫type_identify
 195          π¶ƒ‹£∫ªıŒÔ¿‡–Õ≈–∂œ∫Ø ˝
 196          ******************************************************************************************/
 197          void type_identify()
 198          {
 199   1        if(ceju_flag==1)      //≤‚æ‡…®√Ë±Í÷æŒª
 200   1          {
 201   2            distance=get_distance();
 202   2            ceju_flag=0;
 203   2          }
 204   1        if(distance<=30)      //≈–∂œ «“ª¿‡ªıŒÔ£¨ªπ «∂˛¿‡ªıŒÔ
 205   1        type=1;
 206   1        else type=2;
 207   1        if(s4==0)             //≥ı ºªØœ‘ æΩÁ√Ê
 208   1        {
 209   2          dsbuff[0]=1;
 210   2          dsbuff[1]=11;
 211   2          dsbuff[2]=11;
 212   2          dsbuff[3]=distance/10;
 213   2          dsbuff[4]=distance%10;
 214   2          dsbuff[5]=11;
 215   2          dsbuff[6]=11;
 216   2          dsbuff[7]=type;
 217   2        }
 218   1        ceju_finish=1;        //≤‚æ‡ÕÍ≥…±Í÷æŒª
 219   1      }
 220          
 221          /*****************************************************************************************
 222          ∫Ø ˝√˚≥∆£∫pressure_handle
 223          π¶ƒ‹£∫ø’‘ÿπ˝‘ÿºÏ≤‚∫Ø ˝
 224          ******************************************************************************************/
 225          void pressure_handle() 
 226          {
 227   1        if(++k==1000)        //Ad≤…ºØ≤ªƒ‹¡¨–¯≤… ”√1000¥Œ≤…“ª¥Œ ±»ΩœŒ»∂®
 228   1        {
 229   2          vol=adread(0x03);
 230   2          k=0;
 231   2        }
 232   1        if(vol<51)          //≈–∂œµÁ—π «∑Ò–°”⁄1V
 233   1        {   
 234   2          if(kongzai==0)  
 235   2          {
 236   3            led(0xfe);      //L1µ„¡¡  
 237   3            fengming(0);    //πÿ±’ºÃµÁ∆˜
 238   3          }
 239   2          kongzai=1;
 240   2          normal=0;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 5   

 241   2          guozai=0;
 242   2          if(s6==0)         //s6∞¥º¸√ª”–∞¥œ¬,œ®√À˘”– ˝¬Îπ‹
 243   2           {
 244   3              dsbuff[0]=11;
 245   3              dsbuff[1]=11;
 246   3              dsbuff[2]=11;
 247   3              dsbuff[3]=11;
 248   3              dsbuff[4]=11;
 249   3              dsbuff[5]=11;
 250   3              dsbuff[6]=11;
 251   3              dsbuff[7]=11;
 252   3           }
 253   2        }
 254   1        else if((vol>=51)&&(vol<204))//≈–∂œµÁ—π «∑Ò¥Û”⁄1V£¨–°”⁄4V
 255   1        { 
 256   2          kongzai=0; 
 257   2          guozai=0;
 258   2          if((normal==1)&&(s5==0))
 259   2            {
 260   3              led(0xfd);            //L2µ„¡¡
 261   3              fengming(0);          //πÿ±’ºÃµÁ∆˜
 262   3            }
 263   2          normal=1;
 264   2        }
 265   1        else if(vol>=204)           //≈–∂œµÁ—π «∑Ò¥Û”⁄4V
 266   1        { 
 267   2          kongzai=0;
 268   2          normal=1;
 269   2          s4=0;
 270   2          s6=0;
 271   2          if((guozai==0)&&(normal==1))
 272   2          fengming(1);              //¥Úø™ºÃµÁ∆˜
 273   2          guozai=1;
 274   2        }   
 275   1      }
 276          
 277          /*****************************************************************************************
 278          ∫Ø ˝√˚≥∆£∫Timer0Init
 279          π¶ƒ‹£∫∂® ±∆˜0≥ı ºªØ∫Ø ˝
 280          ******************************************************************************************/
 281          void Timer0Init(void)   //2∫¡√Î@11.0592MHz
 282          {
 283   1        AUXR |= 0x80;         //∂® ±∆˜ ±÷”1Tƒ£ Ω
 284   1        TMOD &= 0xF0;         //…Ë÷√∂® ±∆˜ƒ£ Ω
 285   1        TL0 = 0x9A;           //…Ë÷√∂® ±≥ı÷µ
 286   1        TH0 = 0xA9;           //…Ë÷√∂® ±≥ı÷µ
 287   1        TF0 = 0;              //«Â≥˝TF0±Í÷æ
 288   1        TR0 = 1;              //∂® ±∆˜0ø™ ºº∆ ±
 289   1        EA=1;
 290   1        ET0=1;
 291   1      }
 292          
 293          /*****************************************************************************************
 294          ∫Ø ˝√˚≥∆£∫Timer1Init
 295          π¶ƒ‹£∫∂® ±∆˜1≥ı ºªØ∫Ø ˝
 296          ******************************************************************************************/
 297          void Timer1Init(void)   //0Œ¢√Î@11.0592MHz
 298          {
 299   1        AUXR &= 0xBF;         //∂® ±∆˜ ±÷”12Tƒ£ Ω
 300   1        TMOD &= 0x0F;         //…Ë÷√∂® ±∆˜ƒ£ Ω
 301   1        TL1 = 0x00;           //…Ë÷√∂® ±≥ı÷µ
 302   1        TH1 = 0x00;           //…Ë÷√∂® ±≥ı÷µ
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 6   

 303   1        TF1 = 0;              //«Â≥˝TF1±Í÷æ
 304   1      }
 305          
 306          /*****************************************************************************************
 307          ∫Ø ˝√˚≥∆£∫main
 308          π¶ƒ‹£∫÷˜∫Ø ˝
 309          ******************************************************************************************/
 310          void main()
 311          {
 312   1        allinit();                    //
 313   1        Timer0Init();
 314   1        Timer1Init();
 315   1        time_1=iicread(0x01);
 316   1        Delay2ms();
 317   1        time_2=iicread(0x02);
 318   1        Delay2ms();
 319   1        while(1)
 320   1        { 
 321   2          pressure_handle();
 322   2          keyscan();
 323   2          key_handle();
 324   2          if(normal==1)
 325   2          {
 326   3            type_identify();
 327   3            if((ceju_finish==1)&&(s4==0))
 328   3            {
 329   4              if(type==1) time=time_1;
 330   4              else time=time_2;     
 331   4            }
 332   3          }
 333   2        }
 334   1      }
 335          
 336          /*****************************************************************************************
 337          ∫Ø ˝√˚≥∆£∫Timer0Init
 338          π¶ƒ‹£∫∂® ±∆˜0÷–∂œ∑˛ŒÒ∫Ø ˝
 339          ******************************************************************************************/
 340          void time0() interrupt 1
 341          {
 342   1        display();
 343   1        if(s6==1)
 344   1        {
 345   2          if(++count_5==250)
 346   2          {
 347   3            count_5=0;
 348   3            if(ss==1)
 349   3            {
 350   4              if(liang_1==0)
 351   4              {
 352   5                liang_1=1;
 353   5                dsbuff[0]=3;
 354   5                dsbuff[1]=11;
 355   5                dsbuff[2]=11;
 356   5                dsbuff[3]=11;
 357   5                dsbuff[4]=11;
 358   5                dsbuff[5]=11;
 359   5                dsbuff[6]=time_2/10;
 360   5                dsbuff[7]=time_2%10;
 361   5              }
 362   4              else 
 363   4              {
 364   5                liang_1=0;          
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 7   

 365   5                dsbuff[0]=3;
 366   5                dsbuff[1]=11;
 367   5                dsbuff[2]=11;
 368   5                dsbuff[3]=time_1/10;
 369   5                dsbuff[4]=time_1%10;
 370   5                dsbuff[5]=11;
 371   5                dsbuff[6]=time_2/10;
 372   5                dsbuff[7]=time_2%10;
 373   5              }
 374   4            }
 375   3            if(ss==2)
 376   3            { 
 377   4              if(liang_2==0)
 378   4              {
 379   5                liang_2=1;                
 380   5                dsbuff[0]=3;
 381   5                dsbuff[1]=11;
 382   5                dsbuff[2]=11;
 383   5                dsbuff[3]=time_1/10;
 384   5                dsbuff[4]=time_1%10;
 385   5                dsbuff[5]=11;
 386   5                dsbuff[6]=11;
 387   5                dsbuff[7]=11;
 388   5        
 389   5              }
 390   4              else 
 391   4              {
 392   5                liang_2=0;          
 393   5                dsbuff[0]=3;
 394   5                dsbuff[1]=11;
 395   5                dsbuff[2]=11;
 396   5                dsbuff[3]=time_1/10;
 397   5                dsbuff[4]=time_1%10;
 398   5                dsbuff[5]=11;
 399   5                dsbuff[6]=time_2/10;
 400   5                dsbuff[7]=time_2%10;
 401   5              }
 402   4            }
 403   3            if(ss==3) //  ∫œ≤πss≤ª—≠ª∑µƒ ±∫Ú ≤π◊Ó∫Û“ª∏ˆœ‘ æº¥ø…   //ss—≠ª∑ ± ”…”⁄¡Ω÷÷…¡◊¥Ã¨≤ª¡¡µƒ «ª•≤πµƒ ‘Ú≤ª–Ë“™≤
             -πœ‘ æ
 404   3            {
 405   4              if((dsbuff[6]==11)&&(dsbuff[7]==11))
 406   4              {
 407   5                dsbuff[6]=time_2/10;
 408   5                dsbuff[7]=time_2%10;
 409   5              }
 410   4            }
 411   3          }
 412   2        }
 413   1        if((s4==1)&&(s5==0))  //µπº∆ ±≥Ã–Ú
 414   1        {
 415   2          ++count_3;
 416   2          if(count_3==500)
 417   2          {
 418   3            count_3=0;
 419   3            if(time>=1)
 420   3            time--;
 421   3          } 
 422   2        }
 423   1        if(s5==1)  //ΩÙº±Õ£÷π…¡À∏
 424   1        {
 425   2          ++count_4;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 20:40:30 PAGE 8   

 426   2          if(count_4==250)
 427   2          {
 428   3            count_4=0;
 429   3            if(liang4==0)
 430   3            {
 431   4              liang4=1;
 432   4              led(0xf7);
 433   4            }
 434   3            else 
 435   3            {
 436   4              liang4=0;
 437   4              led(0xff);
 438   4            }
 439   3          }
 440   2        }
 441   1        if(normal==1)//≥¨…˘≤®≤‚æ‡Ãıº˛
 442   1        {
 443   2          ++count_2;
 444   2          if(count_2==100)
 445   2          {
 446   3            count_2=0;
 447   3            ceju_flag=1;  
 448   3          }
 449   2        }
 450   1        if(guozai==1) //π˝‘ÿ…¡À∏
 451   1        {
 452   2          ++count_1;
 453   2          if(count_1==250)
 454   2          {
 455   3            count_1=0;
 456   3            if(s_liang==0)
 457   3            {
 458   4              s_liang=1;
 459   4              led(0xfb);
 460   4            }
 461   3            else 
 462   3            {
 463   4              s_liang=0;
 464   4              led(0xff);
 465   4            }
 466   3          } 
 467   2        }
 468   1      }
 469          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1111    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     41       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
