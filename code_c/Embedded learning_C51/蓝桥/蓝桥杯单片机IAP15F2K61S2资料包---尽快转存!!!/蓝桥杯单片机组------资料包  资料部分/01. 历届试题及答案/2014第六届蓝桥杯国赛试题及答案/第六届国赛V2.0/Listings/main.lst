C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.h>
   2          #include <delay.h>
   3          #include <key.h>
   4          #include <iic.h>
   5          
   6          #define uchar unsigned char 
   7          #define uint unsigned int
   8          
   9          #define TX P10
  10          #define RX P11
  11          
  12          uchar ceju_flag=0,count_2=0,time_1,time_2;
  13          uchar led_state=0;
  14          uchar liang_1,liang_2;
  15          uint count_3=0,k; 
  16          uchar flag_1=0;
  17          uchar count_4=0,count_5,liang4=0;
  18          uchar discount=0,count_1=0,ceju_finish=0;
  19          uchar s_liang;
  20          uchar tab[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
  21          uchar dsbuff[8]={1,2,3,4,5,6,7,8};
  22          uchar vol,type; 
  23          uint distance;
  24          
  25          void Timer0Init(void);
  26          void display();
  27          void pressure_handle();
  28          void type_identify();
  29          void Timer1Init(void); 
  30          void sendwave();
  31          uint get_distance();
  32          void key_handle();
  33          void led_shan(uchar liang);
  34          
  35          
  36          
  37          void allinit()
  38          {
  39   1        P2=0x80;P0=0xff;
  40   1        P2=0xa0;P0=0x00;
  41   1        P2=0xc0;P0=0xff;
  42   1        P2=0xe0;P0=0xff;
  43   1      }
  44          void led(uchar lednum,uchar demand)
  45          {
  46   1        uchar i;
  47   1        lednum--;
  48   1        i=led_state&(0x01<<lednum);
  49   1        if((i==0)&&(demand==1)) 
  50   1        {
  51   2          EA=0;
  52   2          P2=P2&0x1f; 
  53   2          P0=~(0x01<<lednum);
  54   2          P2|=0x80;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 2   

  55   2          P2=P2&0x1f;
  56   2          led_state=0x01<<lednum;
  57   2          EA=1;
  58   2        }
  59   1        else if((i>0)&&(demand==0))
  60   1        {
  61   2          EA=0;
  62   2          P2=P2&0x1f; 
  63   2          P0=0xff;
  64   2          P2|=0x80;
  65   2          P2=P2&0x1f; 
  66   2          led_state=0;
  67   2          EA=1; 
  68   2        }
  69   1      }
  70          
  71          
  72          void main()
  73          {
  74   1        allinit();
  75   1        Timer0Init();
  76   1        Timer1Init();
  77   1        time_1=iicread(0x01);
  78   1        Delay2ms();
  79   1        time_2=iicread(0x02);
  80   1        Delay2ms();
  81   1        while(1)
  82   1        { 
  83   2          pressure_handle();
  84   2          keyscan();//∞¥º¸≈–∂œ  ˝¬Îπ‹≥ÂÕªŒ Ã‚øº¬«
  85   2          if(normal==1)
  86   2          {
  87   3            type_identify();//ªıŒÔ¿‡–Õ ∂±
  88   3            if((ceju_finish==1) && (s4==0))
  89   3            {
  90   4              if(type==1) time = time_1;
  91   4              else time = time_2;     
  92   4            }
  93   3          }
  94   2          key_handle();
  95   2        }
  96   1      }
  97          
  98          void key_handle()
  99          {
 100   1        if(s4==1)
 101   1        {  
 102   2          if(time>0)
 103   2          {   
 104   3            jidian(1);
 105   3            if(s5==0)
 106   3            {
 107   4              dsbuff[0]=2;
 108   4              dsbuff[1]=11;
 109   4              dsbuff[2]=11;
 110   4              dsbuff[3]=11;
 111   4              dsbuff[4]=11;
 112   4              dsbuff[5]=11;
 113   4              dsbuff[6]=time/10;
 114   4              dsbuff[7]=time%10;
 115   4            }
 116   3            else
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 3   

 117   3            {
 118   4              jidian(0);
 119   4              dsbuff[0]=2;
 120   4              dsbuff[1]=11;
 121   4              dsbuff[2]=11;
 122   4              dsbuff[3]=11;
 123   4              dsbuff[4]=11;
 124   4              dsbuff[5]=11;
 125   4              dsbuff[6]=time/10;
 126   4              dsbuff[7]=time%10;
 127   4            }
 128   3          }
 129   2          else jidian(0);       
 130   2        }
 131   1        if(s6==1)
 132   1        {
 133   2          if(ss==1)
 134   2          {
 135   3            if(s7==1)
 136   3            {
 137   4              s7=0;
 138   4              time_1++;
 139   4              if(time_1>10) time_1=1;
 140   4            }
 141   3          }
 142   2          if(ss==2)
 143   2          {
 144   3            if(s7==1)
 145   3            {
 146   4              s7=0;
 147   4              time_2++;
 148   4              if(time_2>10) time_2=1;
 149   4            } 
 150   3          }
 151   2          if(ss==3)
 152   2          {
 153   3            iicwrite(0x01,time_1);
 154   3            Delay2ms();
 155   3            iicwrite(0x02,time_2);
 156   3          }
 157   2        }
 158   1      }
 159          void type_identify()
 160          {
 161   1        if(ceju_flag==1)
 162   1          {
 163   2            distance=get_distance();
 164   2            ceju_flag=0;
 165   2          }
 166   1        if(distance<=30) type=1;
 167   1        else type=2;
 168   1        if(s4==0)
 169   1        {
 170   2          dsbuff[0]=1;
 171   2          dsbuff[1]=11;
 172   2          dsbuff[2]=11;
 173   2          dsbuff[3]=distance/10;
 174   2          dsbuff[4]=distance%10;
 175   2          dsbuff[5]=11;//’‚¿Ôø…“‘œ‘ æ≤…ºØµƒµÁ—π
 176   2          dsbuff[6]=11;
 177   2          dsbuff[7]=type;
 178   2        } 
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 4   

 179   1        ceju_finish=1;        
 180   1      }
 181          void pressure_handle() //ø’‘ÿπ˝‘ÿºÏ≤‚∫Ø ˝
 182          {
 183   1        if(++k==1000)         //Ad≤…ºØ≤ªƒ‹¡¨–¯≤… ”√1000¥Œ≤…“ª¥Œ ±»ΩœŒ»∂®  ∞¥º¸ª·Ã¯ªÿ  «∑Ò «π©µÁµƒŒ Ã‚
 184   1        {
 185   2          vol = adread(0x03);
 186   2          k=0;
 187   2        }
 188   1        if(vol<51)
 189   1        {   
 190   2          if(kongzai==0)  
 191   2          {
 192   3            led(1,1);
 193   3            fengming(0);
 194   3          } 
 195   2          kongzai=1;
 196   2          normal=0;
 197   2          guozai=0;
 198   2          if(s6==0)
 199   2           {
 200   3            dsbuff[0]=11;dsbuff[1]=11;dsbuff[2]=11;dsbuff[3]=11;
 201   3            dsbuff[4]=11;dsbuff[5]=11;dsbuff[6]=11;dsbuff[7]=11;
 202   3           }
 203   2      
 204   2        }
 205   1        else if((vol>=51)&&(vol<204))
 206   1        { 
 207   2          kongzai=0; guozai=0;
 208   2          if((normal==0)&&(s5==0))
 209   2            {
 210   3              led(2,1);
 211   3              fengming(0);
 212   3            }
 213   2          normal=1;
 214   2        }
 215   1        else if(vol>=204)
 216   1        { 
 217   2          kongzai=0;normal=0;s4=0;s6=0;
 218   2          if((guozai==0)&&(normal==0))
 219   2          fengming(1);
 220   2          guozai=1;
 221   2        }
 222   1          
 223   1      }
 224          
 225          void time0() interrupt 1
 226          {
 227   1        display();
 228   1        if(s6==1)
 229   1        {
 230   2          if(++count_5==250)
 231   2          {
 232   3            count_5=0;
 233   3            if(ss==1)
 234   3            {
 235   4              if(liang_1==0)
 236   4              {
 237   5                liang_1=1;
 238   5                dsbuff[0]=3;
 239   5                dsbuff[1]=11;
 240   5                dsbuff[2]=11;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 5   

 241   5                dsbuff[3]=11;
 242   5                dsbuff[4]=11;
 243   5                dsbuff[5]=11;
 244   5                dsbuff[6]=time_2/10;
 245   5                dsbuff[7]=time_2%10;
 246   5              }
 247   4              else 
 248   4              {
 249   5                liang_1=0;          
 250   5                dsbuff[0]=3;
 251   5                dsbuff[1]=11;
 252   5                dsbuff[2]=11;
 253   5                dsbuff[3]=time_1/10;
 254   5                dsbuff[4]=time_1%10;
 255   5                dsbuff[5]=11;
 256   5                dsbuff[6]=time_2/10;
 257   5                dsbuff[7]=time_2%10;
 258   5              }
 259   4            }
 260   3            if(ss==2)
 261   3            { 
 262   4              if(liang_2==0)
 263   4              {
 264   5                liang_2=1;                
 265   5                dsbuff[0]=3;
 266   5                dsbuff[1]=11;
 267   5                dsbuff[2]=11;
 268   5                dsbuff[3]=time_1/10;
 269   5                dsbuff[4]=time_1%10;
 270   5                dsbuff[5]=11;
 271   5                dsbuff[6]=11;
 272   5                dsbuff[7]=11;
 273   5        
 274   5              }
 275   4              else 
 276   4              {
 277   5                liang_2=0;          
 278   5                dsbuff[0]=3;
 279   5                dsbuff[1]=11;
 280   5                dsbuff[2]=11;
 281   5                dsbuff[3]=time_1/10;
 282   5                dsbuff[4]=time_1%10;
 283   5                dsbuff[5]=11;
 284   5                dsbuff[6]=time_2/10;
 285   5                dsbuff[7]=time_2%10;
 286   5              }
 287   4            }
 288   3            if(ss==3) //  ∫œ≤πss≤ª—≠ª∑µƒ ±∫Ú ≤π◊Ó∫Û“ª∏ˆœ‘ æº¥ø…   //ss—≠ª∑ ± ”…”⁄¡Ω÷÷…¡◊¥Ã¨≤ª¡¡µƒ «ª•≤πµƒ ‘Ú≤ª–Ë“™≤
             -πœ‘ æ
 289   3            {
 290   4              if((dsbuff[6]==11)&&(dsbuff[7]==11))
 291   4              {
 292   5                dsbuff[6]=time_2/10;
 293   5                dsbuff[7]=time_2%10;
 294   5              }
 295   4            }
 296   3          }
 297   2        }
 298   1        if((s4==1)&&(s5==0))  //µπº∆ ±≥Ã–Ú
 299   1        {
 300   2          ++count_3;
 301   2          if(count_3==500)
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 6   

 302   2          {
 303   3            count_3=0;
 304   3            if(time>=1)
 305   3            time--;
 306   3          } 
 307   2        }
 308   1        if(s5==1)  //ΩÙº±Õ£÷π…¡À∏
 309   1        {
 310   2          ++count_4;
 311   2          if(count_4==250)
 312   2          {
 313   3            count_4=0;
 314   3            if(liang4==0)
 315   3            {
 316   4              liang4=1;
 317   4              led(4,1);
 318   4            }
 319   3            else {liang4=0;led(4,0);}
 320   3          }
 321   2        }
 322   1        if(normal==1)//≥¨…˘≤®≤‚æ‡Ãıº˛
 323   1        {
 324   2          ++count_2;
 325   2          if(count_2==100)
 326   2          {
 327   3            count_2=0;
 328   3            ceju_flag=1;  
 329   3          }
 330   2        }
 331   1        if(guozai==1) //π˝‘ÿ…¡À∏
 332   1        {
 333   2          ++count_1;
 334   2          if(count_1==250)
 335   2          {
 336   3            count_1=0;
 337   3            if(s_liang==0)
 338   3            {
 339   4              s_liang=1;
 340   4              led(3,1);
 341   4            }
 342   3            else 
 343   3            {
 344   4              s_liang=0;
 345   4              led(3,0);
 346   4            }
 347   3          } 
 348   2        }
 349   1      }
 350          void display()
 351          {
 352   1        P2=(P2&0x1f)|0xe0;
 353   1        P0=0xff;
 354   1        P2=(P2&0x1f);
 355   1        
 356   1        P2=(P2&0x1f)|0xc0;
 357   1        P0=1<<discount;
 358   1        P2=(P2&0x1f);
 359   1      
 360   1        P2=(P2&0x1f)|0xe0;
 361   1        P0=tab[dsbuff[discount]];
 362   1        P2=(P2&0x1f);
 363   1        
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 7   

 364   1        if(++discount == 8 ) discount = 0;
 365   1      }
 366          void sendwave()
 367          {
 368   1        uchar i;
 369   1        for(i=0;i<1;i++)
 370   1        {
 371   2          TX=1;
 372   2          Delay12us();
 373   2          TX=0;
 374   2        }
 375   1      }
 376          
 377          unsigned int get_distance()
 378          {
 379   1        uint dis;
 380   1        RX=1;
 381   1        sendwave();
 382   1        TR1=1;
 383   1        while((RX)&&(!TF1));
 384   1        TR1=0;
 385   1        if(TF1==1)
 386   1        {
 387   2          TF1=0;
 388   2          dis=0;
 389   2        }
 390   1        else 
 391   1        {
 392   2          dis=(TH1<<8)|TL1;
 393   2          dis=dis*0.017;
 394   2          
 395   2        }
 396   1        TH1=TL1=0;  //≤ª“™Õ¸º«»Ìº˛«Â¡„
 397   1        return dis;
 398   1      }
 399          
 400          void Timer0Init(void)   //2∫¡√Î@11.0592MHz
 401          {
 402   1        AUXR |= 0x80;         //∂® ±∆˜ ±÷”1Tƒ£ Ω
 403   1        TMOD &= 0xF0;         //…Ë÷√∂® ±∆˜ƒ£ Ω
 404   1        TL0 = 0x9A;           //…Ë÷√∂® ±≥ı÷µ
 405   1        TH0 = 0xA9;           //…Ë÷√∂® ±≥ı÷µ
 406   1        TF0 = 0;              //«Â≥˝TF0±Í÷æ
 407   1        TR0 = 1;              //∂® ±∆˜0ø™ ºº∆ ±
 408   1        EA=1;
 409   1        ET0=1;
 410   1      }
 411           
 412          void Timer1Init(void)   //0Œ¢√Î@11.0592MHz
 413          {
 414   1        AUXR &= 0xBF;         //∂® ±∆˜ ±÷”12Tƒ£ Ω
 415   1        TMOD &= 0x0F;         //…Ë÷√∂® ±∆˜ƒ£ Ω
 416   1        TL1 = 0x00;           //…Ë÷√∂® ±≥ı÷µ
 417   1        TH1 = 0x00;           //…Ë÷√∂® ±≥ı÷µ
 418   1        TF1 = 0;              //«Â≥˝TF1±Í÷æ
 419   1      }
 420          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1186    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 17:01:06 PAGE 8   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
