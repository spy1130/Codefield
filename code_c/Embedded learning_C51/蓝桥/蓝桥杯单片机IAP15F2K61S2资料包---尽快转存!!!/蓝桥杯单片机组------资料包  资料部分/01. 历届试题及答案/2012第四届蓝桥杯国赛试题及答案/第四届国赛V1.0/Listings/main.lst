C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.h>
   2          #include <delay.h>
   3          #include <ds1302.h>
   4          
   5          #define uchar unsigned char  
   6          #define uint unsigned int 
   7          
   8          uchar code tab[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
   9          uchar shizhong_flag=0,gongneng_flag=0,jia_flag=0,jian_flag=0;
  10          uchar hour=0,minute=0,second=0,moshi_flag=0;  
  11          uchar s_liang=0,f_liang=0,m_liang=0;
  12          uchar count_1=0,count_2=0,count_3=0;
  13          uchar dsbuff[8]={1,2,3,4,5,6,7,8};
  14          uchar discount=0;
  15          
  16          void allinit()
  17          {
  18   1        P2=0x80;P0=0xff;
  19   1        P2=0xa0;P0=0x00;
  20   1        P2=0xc0;P0=0xff;
  21   1        P2=0xe0;P0=0xff;
  22   1      }
  23          
  24          void display()
  25          {
  26   1        P2=0xef;
  27   1        P0=0xff;
  28   1        P2=0x1f;
  29   1      
  30   1        P2=0xc0;
  31   1        P0=1<<discount;
  32   1        P2=0x1f;
  33   1      
  34   1        P2=0xef;
  35   1        P0=tab[dsbuff[discount]];
  36   1        P2=0x1f;
  37   1      
  38   1        if(++discount == 8)
  39   1         discount = 0;
  40   1      }
  41          
  42          void Timer1Init(void)   //5毫秒@11.0592MHz
  43          {
  44   1        AUXR |= 0x40;         //定时器时钟1T模式
  45   1        TMOD &= 0x0F;         //设置定时器模式
  46   1        TL1 = 0x00;           //设置定时初值
  47   1        TH1 = 0x28;           //设置定时初值
  48   1        TF1 = 0;              //清除TF1标志
  49   1        TR1 = 1;              //定时器1开始计时
  50   1        EA=1;
  51   1        ET1=1;
  52   1      }
  53          
  54          void Timer0Init(void)   //2毫秒@11.0592MHz
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 2   

  55          {
  56   1        AUXR |= 0x80;         //定时器时钟1T模式
  57   1        TMOD &= 0xF0;         //设置定时器模式
  58   1        TL0 = 0x9A;           //设置定时初值
  59   1        TH0 = 0xA9;           //设置定时初值
  60   1        TF0 = 0;              //清除TF0标志
  61   1        TR0 = 1;              //定时器0开始计时
  62   1        ET0=1;
  63   1        EA=1;
  64   1      }
  65          
  66          //void keyscan()
  67          //{
  68          //  uchar temp;
  69          //  P3=0x7f;P44=0;P42=1;
  70          //  temp=P3;
  71          //  temp=P3&0x0f;
  72          //  if(temp!=0x0f)
  73          //  {
  74          //    Delay5ms();
  75          //    if(temp!=0x0f)
  76          //    {
  77          //      temp=P3;
  78          //      temp=P3&0x0f;
  79          //      switch(temp)
  80          //      {
  81          //        case 0x0e: 
  82          //        {
  83          //          if(gongneng_flag==1) gongneng_flag=0;   
  84          //          shizhong_flag=1;moshi_flag=0;
  85          //        }
  86          //        break;
  87          //        case 0x0d:    break;
  88          //        case 0x0b:    break;
  89          //        case 0x07:gongneng_flag=1;moshi_flag++;break;
  90          //      } 
  91          //      while(P3!=0x7f);
  92          //    }
  93          //    
  94          //  }
  95          //  
  96          //  P3=0xbf;P44=1;P42=0;
  97          //  temp=P3;
  98          //  temp=P3&0x0f;
  99          //  if(temp!=0x0f)
 100          //  {
 101          //    Delay5ms();
 102          //    if(temp!=0x0f)
 103          //    {
 104          //      temp=P3;
 105          //      temp=P3&0x0f;
 106          //      switch(temp)
 107          //      {
 108          //        case 0x0e: jia_flag=1;  break;
 109          //        case 0x0d: jian_flag=1; break;
 110          //        case 0x0b:              break;
 111          //        case 0x07:              break;
 112          //      }
 113          //    }
 114          //    while(P3!=0xbf);
 115          //  }
 116          //}
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 3   

 117          
 118          void keyscan()
 119          {
 120   1        if(P30==0)
 121   1        {
 122   2          Delay5ms();
 123   2          if(P30==0)
 124   2          {
 125   3            if(gongneng_flag==1) gongneng_flag=0;   
 126   3                shizhong_flag=1;moshi_flag=0;
 127   3          }
 128   2          while(!P30);
 129   2        }
 130   1        
 131   1        if(P31==0)
 132   1        {
 133   2          Delay5ms();
 134   2          if(P31==0)
 135   2          {
 136   3            gongneng_flag=1;
 137   3            moshi_flag++;
 138   3          }
 139   2          while(!P31);
 140   2        }
 141   1        
 142   1        if(P32==0)
 143   1        {
 144   2          Delay5ms();
 145   2          if(P32==0)
 146   2          {
 147   3          jia_flag=1;
 148   3          }
 149   2          while(!P30);
 150   2        }
 151   1        
 152   1        if(P33==0)
 153   1        {
 154   2          Delay5ms();
 155   2          if(P33==0)
 156   2          {
 157   3            jian_flag=1;
 158   3          }
 159   2          while(!P33);
 160   2        }
 161   1      }
 162          void time_chuli()
 163          {
 164   1        if(gongneng_flag==0)
 165   1            {
 166   2              dsbuff[0]=shijian[2]/10;
 167   2              dsbuff[1]=shijian[2]%10;
 168   2              dsbuff[2]=10;
 169   2              dsbuff[3]=shijian[1]/10;
 170   2              dsbuff[4]=shijian[1]%10;
 171   2              dsbuff[5]=10;
 172   2              dsbuff[6]=shijian[0]/10;
 173   2              dsbuff[7]=shijian[0]%10;
 174   2            }
 175   1            else 
 176   1            {
 177   2              switch(moshi_flag)// 进入闪烁状态 不能在主函数里写数码管显示 而应都放在中断中显示 
 178   2              {
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 4   

 179   3                case 1:hour=1;minute=0;second=0;break;
 180   3                case 2:minute=1;hour=0;second=0;break;
 181   3                case 3:second=1;hour=0;minute=0;break;
 182   3                case 4:moshi_flag=1;break;
 183   3              }
 184   2                if(hour==1)
 185   2                {
 186   3                  if(jia_flag==1)
 187   3                  {
 188   4                    if(shijian[2]<=23)
 189   4                      { 
 190   5                        shijian[2]=shijian[2]+1;
 191   5                      }
 192   4                    jia_flag=0;
 193   4                    dswrite();
 194   4                  }
 195   3                  if(jian_flag==1)
 196   3                  {
 197   4                    if(shijian[2]>=1)
 198   4                      {
 199   5                        shijian[2]-=1; 
 200   5                      }
 201   4                    jian_flag=0;
 202   4                    dswrite();
 203   4                  } 
 204   3                }
 205   2                else if(minute==1)
 206   2                {
 207   3                  if(jia_flag==1)
 208   3                  {
 209   4                    if(shijian[1]<=58)
 210   4                      shijian[1]+=1;
 211   4                    jia_flag=0;
 212   4                    dswrite();
 213   4                  }
 214   3                  if(jian_flag==1)
 215   3                  {
 216   4                    if(shijian[1]>=1)
 217   4                      shijian[1]-=1;
 218   4                    jian_flag=0;
 219   4                    dswrite();
 220   4                  } 
 221   3                }
 222   2                else if(second==1)
 223   2                {
 224   3                  if(jia_flag==1)
 225   3                  {
 226   4                    if(shijian[0]<=58)
 227   4                      shijian[0]+=1;
 228   4                    jia_flag=0;
 229   4                    dswrite();
 230   4                  }
 231   3                  if(jian_flag==1)
 232   3                  {
 233   4                    if(shijian[0]>=1)
 234   4                      shijian[0]-=1;
 235   4                    jian_flag=0;
 236   4                    dswrite();
 237   4                  }
 238   3                }
 239   2            }
 240   1      }
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 5   

 241          
 242          void time_shan()
 243          {
 244   1          if(hour==1)
 245   1          {
 246   2            count_1++;
 247   2            if(count_1==200)
 248   2            {
 249   3              count_1=0;
 250   3              if(s_liang==0)
 251   3              {
 252   4                s_liang=1;
 253   4                dsbuff[0]=11;
 254   4                dsbuff[1]=11;
 255   4                dsbuff[2]=10;
 256   4                dsbuff[3]=shijian[1]/10;
 257   4                dsbuff[4]=shijian[1]%10;
 258   4                dsbuff[5]=10;
 259   4                dsbuff[6]=shijian[0]/10;
 260   4                dsbuff[7]=shijian[0]%10;    
 261   4              }
 262   3              else 
 263   3              {
 264   4                s_liang=0; 
 265   4                dsbuff[0]=shijian[2]/10;
 266   4                dsbuff[1]=shijian[2]%10;
 267   4                dsbuff[2]=10;
 268   4                dsbuff[3]=shijian[1]/10;
 269   4                dsbuff[4]=shijian[1]%10;
 270   4                dsbuff[5]=10;
 271   4                dsbuff[6]=shijian[0]/10;
 272   4                dsbuff[7]=shijian[0]%10;
 273   4              }
 274   3            }
 275   2          }
 276   1          else if(minute==1)
 277   1          {
 278   2            count_2++;
 279   2            if(count_2==200)
 280   2            {
 281   3              count_2=0;
 282   3              if(f_liang==0)
 283   3              {
 284   4                f_liang=1;
 285   4                dsbuff[0]=shijian[2]/10;
 286   4                dsbuff[1]=shijian[2]%10;
 287   4                dsbuff[2]=10;
 288   4                dsbuff[3]=11;
 289   4                dsbuff[4]=11;
 290   4                dsbuff[5]=10;
 291   4                dsbuff[6]=shijian[0]/10;
 292   4                dsbuff[7]=shijian[0]%10;    
 293   4              }
 294   3              else 
 295   3              {
 296   4                f_liang=0;
 297   4                dsbuff[0]=shijian[2]/10;
 298   4                dsbuff[1]=shijian[2]%10;
 299   4                dsbuff[2]=10;
 300   4                dsbuff[3]=shijian[1]/10;
 301   4                dsbuff[4]=shijian[1]%10;
 302   4                dsbuff[5]=10;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 6   

 303   4                dsbuff[6]=shijian[0]/10;
 304   4                dsbuff[7]=shijian[0]%10;
 305   4              }
 306   3            }
 307   2          }
 308   1          else if(second==1)
 309   1          {
 310   2            count_3++;
 311   2            if(count_3==200)
 312   2            {
 313   3              count_3=0;
 314   3              if(m_liang==0)
 315   3              {
 316   4                m_liang=1;
 317   4                dsbuff[0]=shijian[2]/10;
 318   4                dsbuff[1]=shijian[2]%10;
 319   4                dsbuff[2]=10;
 320   4                dsbuff[3]=shijian[1]/10;
 321   4                dsbuff[4]=shijian[1]%10;
 322   4                dsbuff[5]=10;
 323   4                dsbuff[6]=11;
 324   4                dsbuff[7]=11;   
 325   4              }
 326   3              else 
 327   3              {
 328   4                m_liang=0;
 329   4                dsbuff[0]=shijian[2]/10;
 330   4                dsbuff[1]=shijian[2]%10;
 331   4                dsbuff[2]=10;
 332   4                dsbuff[3]=shijian[1]/10;
 333   4                dsbuff[4]=shijian[1]%10;
 334   4                dsbuff[5]=10;
 335   4                dsbuff[6]=shijian[0]/10;
 336   4                dsbuff[7]=shijian[0]%10;
 337   4              }
 338   3            }
 339   2          } 
 340   1      }
 341          
 342          void main()
 343          {
 344   1        allinit();
 345   1        Timer0Init();
 346   1        Timer1Init();
 347   1        dswrite();
 348   1        while(1)
 349   1        {
 350   2          keyscan();
 351   2          dsread();
 352   2      //    if(shizhong_flag==1)
 353   2      //    {
 354   2            time_chuli(); 
 355   2      //    }    
 356   2        }
 357   1      }
 358          
 359          void time0() interrupt 1
 360          {
 361   1        display();
 362   1      }
 363          
 364          void time1() interrupt 3
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:22:09 PAGE 7   

 365          {
 366   1        if((shizhong_flag==1)&&(gongneng_flag==1))
 367   1        {
 368   2          time_shan();
 369   2        }
 370   1      }
 371          
 372          
 373          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    810    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
