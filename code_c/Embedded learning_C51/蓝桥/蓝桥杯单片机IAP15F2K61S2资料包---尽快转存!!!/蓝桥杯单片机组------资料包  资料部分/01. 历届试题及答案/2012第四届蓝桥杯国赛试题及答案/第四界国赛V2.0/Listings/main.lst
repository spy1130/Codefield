C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.h>
   2          #include <delay.h>
   3          #include <ds1302.h>
   4          
   5          #define TX P10
   6          #define RX P11
   7          #define uchar unsigned char
   8          #define uint unsigned int
   9          #define somenop1 {_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();}
  10          
  11          uint ss1,distance;
  12          uchar discount,open=0;
  13          uchar code tab[13]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff,0x00};
  14          uchar dsbuff[8]={11,11,11,11,11,11,11,11};
  15          uchar s4,s5,s6,s7;
  16          uchar shi_shan,fen_shan,miao_shan;
  17          uchar ss2,ss3,ss4,ceju_flag,s_liang,f_liang,m_liang;
  18          uchar dis_flag,baocun_flag,beep_distance=20;
  19          uchar led_shan_flag,l_liang;
  20          uchar flag_1=1;
  21          
  22          void Timer0Init(void);
  23          void Timer1Init(void);
  24          void display();
  25          void keyscan();
  26          void ledctrl(uchar liang);
  27          void fengming(uchar demand);
  28          void shizhong_shan();
  29          void shizhong_handle();
  30          void distance_handle();
  31          uint dis_get();
  32          void sendwave();
  33          
  34          void allinit()
  35          {
  36   1        P2=0x80;P0=0xff;
  37   1        P2=0xa0;P0=0x00;
  38   1        P2=0xc0;P0=0xff;
  39   1        P2=0xe0;P0=0xff;
  40   1      }
  41          
  42          void main()
  43          {   
  44   1        Timer0Init(); 
  45   1        Timer1Init();
  46   1        EA=1;
  47   1        ET0=1;  
  48   1        dswrite(); 
  49   1        while(1)
  50   1        {
  51   2          if(open==0)
  52   2          {
  53   3            ledctrl(0xfe);
  54   3            dsbuff[0]=12;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 2   

  55   3            dsbuff[1]=12;
  56   3            dsbuff[2]=12;
  57   3            dsbuff[3]=12;
  58   3            dsbuff[4]=12;
  59   3            dsbuff[5]=12;
  60   3            dsbuff[6]=12;
  61   3            dsbuff[7]=12;
  62   3            fengming(1);    
  63   3          }
  64   2          else if(open==1)
  65   2          {
  66   3            if(flag_1==1)
  67   3            {
  68   4              allinit();
  69   4              flag_1=0;
  70   4            } 
  71   3              keyscan();
  72   3              dsread();
  73   3            if(s7==0)
  74   3            {
  75   4              shizhong_handle();
  76   4            }
  77   3            if(s7==1)
  78   3            {
  79   4              distance_handle();
  80   4            }
  81   3          }
  82   2        }     
  83   1      }
  84          
  85          void distance_handle()
  86          {
  87   1        switch(s6)
  88   1        {
  89   2          case 1:dis_flag=1;break;
  90   2          case 2:dis_flag=0;baocun_flag=1;s6=0;break;
  91   2        }
  92   1        if(ceju_flag==1)
  93   1        {
  94   2          distance=dis_get();
  95   2          if(distance<beep_distance)
  96   2          {
  97   3            fengming(1);
  98   3            led_shan_flag=0;
  99   3          }
 100   2          else if((distance<1.2*beep_distance)&&(distance>=beep_distance))
 101   2          {
 102   3            fengming(0);
 103   3            led_shan_flag=1;
 104   3          }
 105   2          else if(distance>=1.2*beep_distance)   //注意条件
 106   2          {
 107   3            fengming(0);
 108   3            ledctrl(0xff);
 109   3            led_shan_flag=0;
 110   3          }
 111   2          ceju_flag=0;
 112   2        }
 113   1        if(s6==0)
 114   1        {
 115   2          dsbuff[0]=11;
 116   2          dsbuff[1]=11;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 3   

 117   2          dsbuff[2]=11;
 118   2          dsbuff[3]=11;
 119   2          dsbuff[4]=11;
 120   2          dsbuff[5]=distance/100;
 121   2          dsbuff[6]=distance%100/10;
 122   2          dsbuff[7]=distance%10;
 123   2        }
 124   1        else 
 125   1        {
 126   2          if(dis_flag==1)
 127   2          {
 128   3            dsbuff[0]=11;
 129   3            dsbuff[1]=11;
 130   3            dsbuff[2]=11;
 131   3            dsbuff[3]=11;
 132   3            dsbuff[4]=11;
 133   3            dsbuff[5]=11;
 134   3            dsbuff[6]=beep_distance/10;
 135   3            dsbuff[7]=beep_distance%10;
 136   3            if(s5==1)
 137   3            {
 138   4              s5=0;
 139   4              beep_distance+=1;
 140   4            }
 141   3            else if(s4==1)
 142   3            {
 143   4              s4=0;
 144   4              beep_distance-=1;
 145   4            } 
 146   3          }
 147   2        } 
 148   1        if(baocun_flag==1)
 149   1        {
 150   2          baocun_flag=0;
 151   2        }
 152   1      }
 153          
 154          uint dis_get()
 155          {
 156   1        uint dis;
 157   1        sendwave();
 158   1        TR1=1;
 159   1        while((RX)&&(TF1==0));
 160   1        TR1=0;
 161   1        if(TF1)
 162   1        {
 163   2          TF1=0;
 164   2          dis=999;
 165   2        }
 166   1        else 
 167   1        {
 168   2          dis=(TH1<<8)|(TL1);
 169   2          dis=dis*0.017; 
 170   2        }
 171   1        TH1=TL1=0;
 172   1        return dis;
 173   1      }
 174          
 175          void sendwave()
 176          {
 177   1        TX=1;
 178   1        somenop1;somenop1;somenop1;somenop1;somenop1;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 4   

 179   1        somenop1;somenop1;somenop1;somenop1;somenop1;
 180   1        TX=0;                   
 181   1      }
 182          
 183          void time_0() interrupt 1
 184          {
 185   1        display();
 186   1        if(ss1<500)
 187   1        ++ss1;
 188   1        if(ss1==500)
 189   1        {
 190   2          open=1;
 191   2          ss1=501;
 192   2        }
 193   1        shizhong_shan();
 194   1        if(++ss3==200)
 195   1        { 
 196   2          ss3=0;
 197   2          ceju_flag=1;
 198   2        }
 199   1        if(led_shan_flag==1)
 200   1        {
 201   2          if(++ss4==200)
 202   2          {
 203   3            ss4=0;
 204   3            if(l_liang==0)
 205   3            {
 206   4              l_liang=1;
 207   4              ledctrl(0xfe);
 208   4            }
 209   3            else 
 210   3            {
 211   4              l_liang=0;
 212   4              ledctrl(0xff);
 213   4            }
 214   3          }
 215   2        }
 216   1        
 217   1      }
 218          
 219          
 220          void keyscan()
 221          {
 222   1        if(P33==0)
 223   1        {
 224   2          Delay5ms();
 225   2          if(P33==0)
 226   2          {
 227   3            if(s6>0)
 228   3            s4=1;
 229   3          }
 230   2          while(!P33);
 231   2        }
 232   1        else if(P32==0)
 233   1        {
 234   2          Delay5ms();
 235   2          if(P32==0)
 236   2          {
 237   3            if(s6>0)
 238   3            s5=1;
 239   3          }
 240   2          while(!P32);
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 5   

 241   2        }
 242   1        else if(P31==0)
 243   1        {
 244   2          Delay5ms();
 245   2          if(P31==0)
 246   2          {
 247   3            s6++;
 248   3          }
 249   2          while(!P31);
 250   2        }
 251   1        else if(P30==0)
 252   1        {
 253   2          Delay5ms();
 254   2          if(P30==0)
 255   2          {
 256   3            if(s7==0) {s7=1;s6=0;}
 257   3            else {s7=0;s6=0;}
 258   3          }
 259   2          while(!P30);
 260   2        }
 261   1      }
 262          void display()
 263          {
 264   1        P2=(P2&0x1f)|0xe0;
 265   1        P0=0xff;
 266   1        P2=P2&0x1f;
 267   1      
 268   1        P2=(P2&0x1f)|0xc0;
 269   1        P0=1<<discount;
 270   1        P2=P2&0x1f;
 271   1      
 272   1        P2=(P2&0x1f)|0xe0;
 273   1        P0=tab[dsbuff[discount]];
 274   1        P2=P2&0x1f;
 275   1      
 276   1        if(++discount==8) discount=0;
 277   1      }
 278          void Timer0Init(void)   //2毫秒@11.0592MHz
 279          {
 280   1        AUXR |= 0x80;         //定时器时钟1T模式
 281   1        TMOD &= 0xF0;         //设置定时器模式
 282   1        TL0 = 0x9A;           //设置定时初值
 283   1        TH0 = 0xA9;           //设置定时初值
 284   1        TF0 = 0;              //清除TF0标志
 285   1        TR0 = 1;              //定时器0开始计时
 286   1      }
 287          //void ledctrl(uchar lednum,uchar demand)
 288          //{
 289          //  uchar i;
 290          //  static uchar led_state=0;
 291          //  lednum--;
 292          //  i=led_state&(0x01<<lednum);
 293          //  if((i==0)&&(demand==1))
 294          //  {
 295          //    EA=0;
 296          //    led_state=0x01<<lednum;
 297          //    P2=(P2&0x1f)|0x80;
 298          //    P0=~(0x01<<lednum);
 299          //    P2=P2&0x1f;
 300          //    EA=1;
 301          //  }
 302          //  else if((i>0)&&(demand==0))
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 6   

 303          //  {
 304          //    EA=0;
 305          //    led_state=0;
 306          //    P2=(P2&0x1f)|0x80;
 307          //    P0=0xff;
 308          //    P2=P2&0x1f;
 309          //    EA=1;
 310          //  } 
 311          //}
 312          void ledctrl(uchar liang)
 313          {
 314   1        P2=P2&0x1f;
 315   1        P2=0x80;
 316   1        P0=liang;
 317   1        P2=P2&0x1f;
 318   1      }
 319          
 320          void fengming(uchar demand)
 321          {
 322   1        static xiang_state=0; 
 323   1        if((demand==1)&&(xiang_state==0))
 324   1        {
 325   2          P0=0x00;
 326   2          EA=0;
 327   2          P2=(P2&0x1f)|0xa0;
 328   2          P0=0x40;
 329   2          P2=P2&0x1f;
 330   2          xiang_state=1;
 331   2          EA=1; 
 332   2        }
 333   1        else if((demand==0)&&(xiang_state==1))
 334   1        {
 335   2          xiang_state=0;
 336   2          P2=(P2&0x1f)|0xa0;
 337   2          P0=0x00;
 338   2          P2=P2&0x1f;
 339   2        }
 340   1      }
 341          void shizhong_shan()
 342          {
 343   1        if(shi_shan==1)
 344   1        {
 345   2          if(++ss2==200)
 346   2          {
 347   3            ss2=0;
 348   3            if(s_liang==1)
 349   3            {
 350   4              s_liang=0;
 351   4              dsbuff[0]=shijian[2]/10;
 352   4              dsbuff[1]=shijian[2]%10;
 353   4              dsbuff[2]=10;
 354   4              dsbuff[3]=shijian[1]/10;
 355   4              dsbuff[4]=shijian[1]%10;
 356   4              dsbuff[5]=10;
 357   4              dsbuff[6]=shijian[0]/10;
 358   4              dsbuff[7]=shijian[0]%10;
 359   4            }
 360   3            else 
 361   3            {
 362   4              s_liang=1;
 363   4              dsbuff[0]=11;
 364   4              dsbuff[1]=11;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 7   

 365   4              dsbuff[2]=10;
 366   4              dsbuff[3]=shijian[1]/10;
 367   4              dsbuff[4]=shijian[1]%10;
 368   4              dsbuff[5]=10;
 369   4              dsbuff[6]=shijian[0]/10;
 370   4              dsbuff[7]=shijian[0]%10;
 371   4            }
 372   3          }
 373   2        }
 374   1        else if(fen_shan==1)
 375   1        {
 376   2          if(++ss2==200)
 377   2          {
 378   3            ss2=0;
 379   3            if(f_liang==1)
 380   3            {
 381   4              f_liang=0;
 382   4              dsbuff[0]=shijian[2]/10;
 383   4              dsbuff[1]=shijian[2]%10;
 384   4              dsbuff[2]=10;
 385   4              dsbuff[3]=shijian[1]/10;
 386   4              dsbuff[4]=shijian[1]%10;
 387   4              dsbuff[5]=10;
 388   4              dsbuff[6]=shijian[0]/10;
 389   4              dsbuff[7]=shijian[0]%10;
 390   4            }
 391   3            else 
 392   3            {
 393   4              f_liang=1;
 394   4              dsbuff[0]=shijian[2]/10;
 395   4              dsbuff[1]=shijian[2]%10;
 396   4              dsbuff[2]=10;
 397   4              dsbuff[3]=11;
 398   4              dsbuff[4]=11;
 399   4              dsbuff[5]=10;
 400   4              dsbuff[6]=shijian[0]/10;
 401   4              dsbuff[7]=shijian[0]%10;
 402   4            }
 403   3          }
 404   2        }
 405   1        else if(miao_shan==1)
 406   1        {
 407   2          if(++ss2==200)
 408   2          {
 409   3            ss2=0;
 410   3            if(m_liang==1)
 411   3            {
 412   4              m_liang=0;
 413   4              dsbuff[0]=shijian[2]/10;
 414   4              dsbuff[1]=shijian[2]%10;
 415   4              dsbuff[2]=10;
 416   4              dsbuff[3]=shijian[1]/10;
 417   4              dsbuff[4]=shijian[1]%10;
 418   4              dsbuff[5]=10;
 419   4              dsbuff[6]=shijian[0]/10;
 420   4              dsbuff[7]=shijian[0]%10;
 421   4            }
 422   3            else 
 423   3            {
 424   4              m_liang=1;
 425   4              dsbuff[0]=shijian[2]/10;
 426   4              dsbuff[1]=shijian[2]%10;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 8   

 427   4              dsbuff[2]=10;
 428   4              dsbuff[3]=shijian[1]/10;
 429   4              dsbuff[4]=shijian[1]%10;
 430   4              dsbuff[5]=10;
 431   4              dsbuff[6]=11;
 432   4              dsbuff[7]=11;
 433   4            }
 434   3          }
 435   2        }
 436   1      }
 437           
 438          void shizhong_handle()
 439          {
 440   1        switch(s6)
 441   1        {
 442   2          case 1:shi_shan=1;fen_shan=0;miao_shan=0;break;
 443   2          case 2:shi_shan=0;fen_shan=1;miao_shan=0;break;
 444   2          case 3:shi_shan=0;fen_shan=0;miao_shan=1;break;
 445   2          case 4:s6=0;break;
 446   2        }
 447   1        if(s6==0)
 448   1        {
 449   2          dsbuff[0]=shijian[2]/10;
 450   2          dsbuff[1]=shijian[2]%10;
 451   2          dsbuff[2]=10;
 452   2          dsbuff[3]=shijian[1]/10;
 453   2          dsbuff[4]=shijian[1]%10;
 454   2          dsbuff[5]=10;
 455   2          dsbuff[6]=shijian[0]/10;
 456   2          dsbuff[7]=shijian[0]%10;
 457   2        }
 458   1        if(shi_shan==1)
 459   1        {
 460   2          if(s5==1)
 461   2          {
 462   3            s5=0;
 463   3            if(shijian[2]<=22)
 464   3            shijian[2]=shijian[2]+1;
 465   3            dswrite();
 466   3          }
 467   2          else if(s4==1)
 468   2          {
 469   3            s4=0;
 470   3            if(shijian[2]>0)
 471   3            shijian[2]=shijian[2]-1;
 472   3            dswrite();
 473   3          } 
 474   2        }
 475   1        else if(fen_shan==1)    //考虑循环时分秒显示 边界判断
 476   1        {
 477   2          if(s5==1)
 478   2          {
 479   3            s5=0;
 480   3            if(shijian[1]<=58)
 481   3            shijian[1]=shijian[1]+1;
 482   3            dswrite();
 483   3          }
 484   2          else if(s4==1)
 485   2          {
 486   3            s4=0;
 487   3            if(shijian[1]>0)
 488   3            shijian[1]=shijian[1]-1;
C51 COMPILER V9.54   MAIN                                                                  12/25/2017 21:40:05 PAGE 9   

 489   3            dswrite();
 490   3          } 
 491   2        }
 492   1        else if(miao_shan==1)
 493   1        {
 494   2          if(s5==1)
 495   2          {
 496   3            s5=0;
 497   3            if(shijian[0]<=58)
 498   3            shijian[0]=shijian[0]+1;
 499   3            dswrite();
 500   3          }
 501   2          else if(s4==1)
 502   2          {
 503   3            s4=0;
 504   3            if(shijian[0]>0)
 505   3            shijian[0]=shijian[0]-1;
 506   3            dswrite();
 507   3          } 
 508   2        } 
 509   1      }
 510          
 511          void Timer1Init(void)   //0微秒@11.0592MHz
 512          {
 513   1        AUXR &= 0xBF;         //定时器时钟12T模式
 514   1        TMOD &= 0x0F;         //设置定时器模式
 515   1        TL1 = 0x00;           //设置定时初值
 516   1        TH1 = 0x00;           //设置定时初值
 517   1        TF1 = 0;              //清除TF1标志
 518   1        TR1 = 0;              //定时器1开始计时
 519   1      }
 520            


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1598    ----
   CONSTANT SIZE    =     13    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     36       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
