C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /**************************************************************************
   2          实验功能：第三届省赛试题程序设计
   3          时间：2017.12.21
   4          作者：吴康
   5          ***************************************************************************/
   6          #include <STC15F2K60S2.H>
   7          #include <intrins.h>
   8          
   9          #define uchar unsigned char 
  10          #define uint unsigned int 
  11            
  12          sbit scl=P2^0;
  13          sbit sda=P2^1;
  14          
  15          uchar code tab[]={0XC0,0XF9,0XA4,0XB0,0X99,0X92,0X82,0XF8,0X80,0X90,0XFF};
  16          uchar code dot[]={0X40,0x79,0x24,0x30,0x19,0x12,0x20,0x78,0x00,0x10};
  17          
  18          uchar yi,er,san,si,wu ,liu,qi,ba;
  19          uchar tt=0;
  20          uint ML=0;
  21          uint money=0;
  22          uchar guan=0;
  23          
  24          /**************************************************************************
  25          函数名称：delayms
  26          功能：延时函数
  27          ***************************************************************************/
  28          void delayms(int ms)
  29          {
  30   1        int i,j;
  31   1        for(i=ms;i>0;i--)
  32   1          for(j=845;j>0;j--);
  33   1      }
  34          
  35          /**************************************************************************
  36          函数名称：allinit
  37          功能：板子整体初始化函数
  38          ***************************************************************************/
  39          void allinit()
  40          {
  41   1        P2=0XA0;
  42   1        P0=0X00;//关闭蜂鸣器，继电器
  43   1        
  44   1        P2=0X80;
  45   1        P0=0XFF;//关闭LED灯
  46   1        
  47   1        P2=0XC0;
  48   1        P0=0XFF;//选择所有数码管
  49   1        P2=0XFF;
  50   1        P0=0XFF;//关闭所有数码管
  51   1      }
  52          
  53          /**************************************************************************
  54          函数名称：display
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 2   

  55          功能：显示函数
  56          ***************************************************************************/
  57          void display1(uchar yi,uchar er)
  58          {
  59   1          P2=0XC0;//打开位选573   U8
  60   1          P0=0X01;//选择第一个数码管
  61   1          P2=0XFF;//打开段选573   U7
  62   1          P0=tab[yi];
  63   1          delayms(1);
  64   1          
  65   1          P2=0XC0;//打开位选573   U8
  66   1          P0=0X02;//选择第二个数码管
  67   1          P2=0XFF;//打开段选573   U7
  68   1          P0=dot[er];
  69   1          delayms(1);
  70   1      } 
  71          
  72          void display2(uchar san,uchar si)
  73          {
  74   1          P2=0XC0;//打开位选573   U8
  75   1          P0=0X04;//选择第三个数码管
  76   1          P2=0XFF;//打开段选573   U7
  77   1          P0=tab[san];
  78   1          delayms(1);
  79   1          
  80   1          P2=0XC0;//打开位选573   U8
  81   1          P0=0X08;//选择第四个数码管
  82   1          P2=0XFF;//打开段选573   U7
  83   1          P0=tab[si];
  84   1          delayms(1);
  85   1      }
  86          
  87          void display3(uchar wu,uchar liu)
  88          {
  89   1          P2=0XC0;//打开位选573   U8
  90   1          P0=0X10;//选择第一个数码管
  91   1          P2=0XFF;//打开段选573   U7
  92   1          P0=tab[wu];
  93   1          delayms(1);
  94   1          
  95   1          P2=0XC0;//打开位选573   U8
  96   1          P0=0X20;//选择第一个数码管
  97   1          P2=0XFF;//打开段选573   U7
  98   1          P0=dot[liu];
  99   1          delayms(1);
 100   1      }
 101          
 102          void display4(uchar qi,uchar ba)
 103          {
 104   1          P2=0XC0;//打开位选573   U8
 105   1          P0=0X40;//选择第一个数码管
 106   1          P2=0XFF;//打开段选573   U7
 107   1          P0=tab[qi];
 108   1          delayms(1);
 109   1          
 110   1          P2=0XC0;//打开位选573   U8
 111   1          P0=0X80;//选择第一个数码管
 112   1          P2=0XFF;//打开段选573   U7
 113   1          P0=tab[ba];
 114   1          delayms(1);
 115   1      }
 116          
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 3   

 117          /**************************************************************************
 118          函数名称：Timer0Init
 119          功能：定时器0初始化函数
 120          ***************************************************************************/
 121          void Timer0Init(void)   //5毫秒@11.0592MHz
 122          {
 123   1        AUXR |= 0x80;   //定时器时钟1T模式
 124   1        TMOD &= 0xF0;   //设置定时器模式
 125   1        TL0 = 0x00;   //设置定时初值
 126   1        TH0 = 0x28;   //设置定时初值
 127   1        TF0 = 0;    //清除TF0标志
 128   1        TR0 = 1;    //定时器0开始计时
 129   1      }
 130          
 131          /**************************************************************************
 132          函数名称：rel
 133          功能：初始化函数
 134          ***************************************************************************/
 135          void rel(uchar dong)
 136          {
 137   1        if(dong==0)
 138   1        {
 139   2          P2=0XA0;P0=0X00;//全关
 140   2        }
 141   1        else if(dong==1)
 142   1        {
 143   2          P2=0XA0;P0=0X40;//开蜂鸣器 
 144   2        }
 145   1        else if(dong==2)
 146   1        {
 147   2          P2=0XA0;P0=0X10;//开继电器
 148   2        }
 149   1        else if(dong==3)
 150   1        {
 151   2          P2=0XA0;P0=0Xff;//全开
 152   2        }
 153   1      }
 154          
 155          /**************************************************************************
 156          函数名称：keyscan
 157          功能：按键扫描函数
 158          ***************************************************************************/
 159          void keyscan()
 160          {
 161   1        if(P30==0)
 162   1        {
 163   2          delayms(5);
 164   2          if(P30==0)
 165   2          {
 166   3            rel(2);
 167   3            wu=0;
 168   3            liu=0;
 169   3            qi=0;
 170   3            ba=0;
 171   3            EA=1;
 172   3            ET0=1;
 173   3          }
 174   2          while(!P30);
 175   2        }
 176   1        else if(P31==0)
 177   1        {
 178   2          delayms(5);
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 4   

 179   2          if(P31==0)
 180   2          {
 181   3            EA=0;
 182   3            ET0=0;
 183   3            rel(0);
 184   3            money=ML*5;
 185   3            wu=money/100000;
 186   3            liu=money%100000/10000;
 187   3            qi=money%10000/1000;
 188   3            ba=money%1000/100;
 189   3            ML=0; 
 190   3          }
 191   2          while(!P31);
 192   2        }
 193   1      }
 194          
 195          void iicdelay(uchar m)
 196          {
 197   1        do
 198   1        {
 199   2          _nop_();
 200   2        }
 201   1        while(m--);
 202   1      }
 203          
 204          void iicstrat()
 205          {
 206   1        sda=1;
 207   1        _nop_();
 208   1        scl=1;
 209   1        _nop_();
 210   1        sda=0;
 211   1        _nop_();
 212   1        scl=0;
 213   1        _nop_();
 214   1      }
 215          
 216          
 217          void iicstop()
 218          {
 219   1        sda=0;
 220   1        _nop_();
 221   1        scl=1;
 222   1        _nop_();
 223   1        sda=1;
 224   1        _nop_();
 225   1      }
 226          
 227          void writebyte(uchar dat)
 228          {
 229   1        uchar i;
 230   1        for(i=0;i<8;i++)
 231   1        {
 232   2          scl=0;
 233   2          sda=dat&0x80;
 234   2          scl=1;
 235   2          dat<<=1;
 236   2        }
 237   1        scl=0;
 238   1      }
 239          
 240          
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 5   

 241          uchar iicreadbyte()
 242          {
 243   1        uchar dat;
 244   1        uchar i;
 245   1        for(i=0;i<8;i++)
 246   1        {
 247   2          scl=1;
 248   2          iicdelay(5);
 249   2          dat<<=1;
 250   2          if(sda)
 251   2          {
 252   3            dat|=0x01;
 253   3          }
 254   2          scl=0;
 255   2        }
 256   1        
 257   1        return dat;
 258   1      }
 259          
 260          uchar ack()
 261          {
 262   1        scl=1;
 263   1        iicdelay(5);
 264   1        if(sda==1)
 265   1        {
 266   2          scl=0;
 267   2          iicstop();
 268   2          return 0;
 269   2        }
 270   1        else 
 271   1        {
 272   2          scl=0;
 273   2          return 1;
 274   2        }
 275   1      }
 276          
 277          uchar iicread(uchar add)
 278          {
 279   1        uchar temp;
 280   1        
 281   1        iicstrat();
 282   1        writebyte(0x90);
 283   1        ack();
 284   1        writebyte(add);
 285   1        ack();
 286   1        iicstop();
 287   1        
 288   1        iicstrat();
 289   1        writebyte(0x91);
 290   1        ack();
 291   1        temp=iicreadbyte();
 292   1        iicstop();
 293   1        
 294   1        temp=0.39*temp;
 295   1        
 296   1        return temp;
 297   1      }
 298          
 299          /**************************************************************************
 300          函数名称：adrun
 301          功能：采集光敏电阻电压函数
 302          ***************************************************************************/
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 6   

 303          void adrun()
 304          {
 305   1        uchar num;
 306   1        num=iicread(0x01);
 307   1        if(num<25)
 308   1        {
 309   2          P2=0X80;P0=0XFE;
 310   2        }
 311   1        else 
 312   1        {
 313   2          P2=0X80;P0=0XFF;
 314   2        }
 315   1      }
 316          
 317          /**************************************************************************
 318          函数名称：main
 319          功能：主函数
 320          ***************************************************************************/
 321          void main()
 322          {
 323   1        allinit();
 324   1        Timer0Init();
 325   1        
 326   1        yi=10;er=0;san=5;si=0;wu=0;liu=0;qi=0;ba=0;
 327   1        while(1)
 328   1        {
 329   2          adrun();
 330   2          keyscan();
 331   2          display1(yi,er);
 332   2          display2(san,si);
 333   2          display3(wu,liu);
 334   2          display4(qi,ba);
 335   2        }
 336   1      }
 337          
 338          /**************************************************************************
 339          函数名称：time0
 340          功能：中断服务函数
 341          ***************************************************************************/
 342          void time0() interrupt 1
 343          {
 344   1        tt++;
 345   1        if(tt==20)
 346   1        {
 347   2          tt=0;
 348   2          ML=ML+10;
 349   2          wu=ML/10000;
 350   2          liu=ML%10000/1000;
 351   2          qi=ML%1000/100;
 352   2          ba=ML%100/10;//qiu=ML%10;
 353   2          if(ML>99990)
 354   2          {
 355   3            EA=0;
 356   3            ET0=0;
 357   3            rel(0);
 358   3            money=ML*5;
 359   3            wu=money/100000;
 360   3            liu=money%100000/10000;
 361   3            qi=money%10000/1000;
 362   3            ba=money%1000/100;
 363   3            ML=0; 
 364   3          }
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 15:54:19 PAGE 7   

 365   2        }
 366   1      }
 367          
 368          
 369          
 370          
 371          
 372          
 373          
 374          
 375          
 376          
 377          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1012    ----
   CONSTANT SIZE    =     21    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     14    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
