C51 COMPILER V9.54   MAIN                                                                  12/21/2017 16:37:24 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /**************************************************************************
   2          实验功能：第三届省赛试题程序设计
   3          时间：2017.12.21
   4          作者：吴康
   5          ***************************************************************************/
   6          #include <STC15F2K60S2.H>
   7          #include <intrins.h>
   8          #include <iic.h>
   9          
  10          #define uchar unsigned char 
  11          #define uint unsigned int 
  12          
  13          uchar code tab[]={0XC0,0XF9,0XA4,0XB0,0X99,0X92,0X82,0XF8,0X80,0X90,0XFF};
  14          uchar dsbuff[8]={11,0,5,0,0,0,0,0};
  15          uchar tt=0;       //定时时间变量
  16          uint ML=0;        //出水量存储变量
  17          uint money=0;     //根据出水量计算出费用
  18          uchar guan=0;     //采集的光敏电阻两端电压
  19          uchar discount;   //数码管移位变量
  20          
  21          /**************************************************************************
  22          函数名称：delayms
  23          功能：延时函数
  24          ***************************************************************************/
  25          void delayms(int ms)
  26          {
  27   1        int i,j;
  28   1        for(i=ms;i>0;i--)
  29   1          for(j=845;j>0;j--);
  30   1      }
  31          
  32          /**************************************************************************
  33          函数名称：allinit
  34          功能：板子整体初始化函数
  35          ***************************************************************************/
  36          void allinit()
  37          {
  38   1        P2=0XA0;
  39   1        P0=0X00;//关闭蜂鸣器，继电器
  40   1        
  41   1        P2=0X80;
  42   1        P0=0XFF;//关闭LED灯
  43   1        
  44   1        P2=0XC0;
  45   1        P0=0XFF;//选择所有数码管
  46   1        P2=0XFF;
  47   1        P0=0XFF;//关闭所有数码管
  48   1      }
  49          
  50          /**************************************************************************
  51          函数名称：display
  52          功能：显示函数
  53          ***************************************************************************/
  54          void display()
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 16:37:24 PAGE 2   

  55          {
  56   1        P2=0xef;
  57   1        P0=0xff;
  58   1        P2=0x1f;
  59   1        
  60   1        P2=0xcf;
  61   1        P0=1<<discount;
  62   1        P2=0x1f;
  63   1        
  64   1        P2=0xef;
  65   1        if(discount==5||discount==1)//要加小数点需要判断
  66   1        P0=tab[dsbuff[discount]]&0x7f;
  67   1        else P0=tab[dsbuff[discount]];
  68   1        P2=0x1f;
  69   1        
  70   1        if(++discount==8)
  71   1          discount = 0;
  72   1      }
  73          
  74          /**************************************************************************
  75          函数名称：Timer0Init
  76          功能：定时器0初始化函数
  77          ***************************************************************************/
  78          void Timer0Init(void)   //5毫秒@11.0592MHz
  79          {
  80   1        AUXR |= 0x80;         //定时器时钟1T模式
  81   1        TMOD &= 0xF0;         //设置定时器模式
  82   1        TL0 = 0x00;           //设置定时初值
  83   1        TH0 = 0x28;           //设置定时初值
  84   1        TF0 = 0;              //清除TF0标志
  85   1        TR0 = 1;              //定时器0开始计时
  86   1      }
  87          
  88          /**************************************************************************
  89          函数名称：rel
  90          功能：初始化函数
  91          ***************************************************************************/
  92          void rel(uchar dong)
  93          {
  94   1        if(dong==0)
  95   1        {
  96   2          P2=0XA0;P0=0X00;//全关
  97   2        }
  98   1        else if(dong==1)
  99   1        {
 100   2          P2=0XA0;P0=0X40;//开蜂鸣器 
 101   2        }
 102   1        else if(dong==2)
 103   1        {
 104   2          P2=0XA0;P0=0X10;//开继电器
 105   2        }
 106   1        else if(dong==3)
 107   1        {
 108   2          P2=0XA0;P0=0Xff;//全开
 109   2        }
 110   1      }
 111          
 112          /**************************************************************************
 113          函数名称：keyscan
 114          功能：按键扫描函数
 115          ***************************************************************************/
 116          void keyscan()
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 16:37:24 PAGE 3   

 117          {
 118   1        if(P30==0)      //打开定时器持续出水，当第二次按时先清零在开始出水
 119   1        {
 120   2          delayms(5);
 121   2          if(P30==0)
 122   2          {
 123   3            rel(2);     //打开继电器
 124   3            dsbuff[4]=0;
 125   3            dsbuff[5]=0;
 126   3            dsbuff[6]=0;
 127   3            dsbuff[7]=0;
 128   3            EA=1;
 129   3            ET0=1;
 130   3          }
 131   2          while(!P30);
 132   2        }
 133   1        else if(P31==0)   //关闭定时器计算出出水的价格（扩大了10倍）
 134   1        {
 135   2          delayms(5);
 136   2          if(P31==0)
 137   2          {
 138   3            EA=0;
 139   3            ET0=0;
 140   3            rel(0);       //关闭继电器
 141   3            money=ML*5;
 142   3            dsbuff[4]=money/100000;
 143   3            dsbuff[5]=money%100000/10000;
 144   3            dsbuff[6]=money%10000/1000;
 145   3            dsbuff[7]=money%1000/100;
 146   3            ML=0; 
 147   3          }
 148   2          while(!P31);
 149   2        }
 150   1      }
 151          
 152          /**************************************************************************
 153          函数名称：adrun
 154          功能：采集光敏电阻电压函数
 155          ***************************************************************************/
 156          void adrun()
 157          {
 158   1        uchar num;
 159   1        num=iicread(0x01);//采集光敏电阻所在通道电压
 160   1        if(num<25)        //小于1.25V点亮L1
 161   1        {
 162   2          P2=0X80;
 163   2          P0=0XFE;
 164   2        }
 165   1        else              //大于1.25V关闭L1
 166   1        {
 167   2          P2=0X80;
 168   2          P0=0XFF;
 169   2        }
 170   1      }
 171          
 172          /**************************************************************************
 173          函数名称：main
 174          功能：主函数
 175          ***************************************************************************/
 176          void main()
 177          {
 178   1        allinit();      //板子整体初始化
C51 COMPILER V9.54   MAIN                                                                  12/21/2017 16:37:24 PAGE 4   

 179   1        Timer0Init();   //定时器0初始化
 180   1        while(1)
 181   1        {
 182   2          adrun();      //采集光敏电阻电压
 183   2          keyscan();    //按键扫描函数
 184   2          display();    //数码管显示函数
 185   2          delayms(1);   //扫描时间1MS
 186   2        }
 187   1      }
 188          
 189          /**************************************************************************
 190          函数名称：time0
 191          功能：中断服务函数
 192          ***************************************************************************/
 193          void time0() interrupt 1
 194          {
 195   1        tt++;
 196   1        if(tt==20)
 197   1        {
 198   2          tt=0;
 199   2          ML=ML+10;
 200   2          dsbuff[4]=ML/10000;
 201   2          dsbuff[5]=ML%10000/1000;
 202   2          dsbuff[6]=ML%1000/100;
 203   2          dsbuff[7]=ML%100/10;
 204   2          if(ML>99990)
 205   2          {
 206   3            EA=0;
 207   3            ET0=0;
 208   3            rel(0);
 209   3            money=ML*5;
 210   3            dsbuff[4]=money/100000;
 211   3            dsbuff[5]=money%100000/10000;
 212   3            dsbuff[6]=money%10000/1000;
 213   3            dsbuff[7]=money%1000/100;
 214   3            ML=0; 
 215   3          }
 216   2        }
 217   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    755    ----
   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     15    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
