C51 COMPILER V9.54   MAIN                                                                  12/24/2017 16:51:49 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.h>
   2          #include <delay.h>
   3          #include <ds1302.h>
   4          
   5          #define uchar unsigned char  
   6          #define uint unsigned int 
   7          
   8          uchar code tab[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
   9          uchar shizhong_flag=0,gongneng_flag=0,jia_flag=0,jian_flag=0;
  10          uchar hour=0,minute=0,second=0,moshi_flag=0;  
  11          uchar s_liang=0,f_liang=0,m_liang=0;
  12          uchar count_1=0,count_2=0,count_3=0;
  13          uchar dsbuff[8]={1,2,3,4,5,6,7,8};
  14          uchar discount=0;
  15          
  16          void allinit()
  17          {
  18   1        P2=0x80;P0=0xff;
  19   1        P2=0xa0;P0=0x00;
  20   1        P2=0xc0;P0=0xff;
  21   1        P2=0xe0;P0=0xff;
  22   1      }
  23          
  24          void display()
  25          {
  26   1        P2=0xef;
  27   1        P0=0xff;
  28   1        P2=0x1f;
  29   1      
  30   1        P2=0xc0;
  31   1        P0=1<<discount;
  32   1        P2=0x1f;
  33   1      
  34   1        P2=0xef;
  35   1          P0=tab[dsbuff[discount]];
  36   1        P2=0x1f;
  37   1      
  38   1        if(++discount == 8)
  39   1         discount = 0;
  40   1      }
  41          
  42          void Timer1Init(void)   //5毫秒@11.0592MHz
  43          {
  44   1        AUXR |= 0x40;         //定时器时钟1T模式
  45   1        TMOD &= 0x0F;         //设置定时器模式
  46   1        TL1 = 0x00;           //设置定时初值
  47   1        TH1 = 0x28;           //设置定时初值
  48   1        TF1 = 0;              //清除TF1标志
  49   1        TR1 = 1;              //定时器1开始计时
  50   1        EA=1;
  51   1        ET1=1;
  52   1      }
  53          
  54          void Timer0Init(void)   //2毫秒@11.0592MHz
C51 COMPILER V9.54   MAIN                                                                  12/24/2017 16:51:49 PAGE 2   

  55          {
  56   1        AUXR |= 0x80;         //定时器时钟1T模式
  57   1        TMOD &= 0xF0;         //设置定时器模式
  58   1        TL0 = 0x9A;           //设置定时初值
  59   1        TH0 = 0xA9;           //设置定时初值
  60   1        TF0 = 0;              //清除TF0标志
  61   1        TR0 = 1;              //定时器0开始计时
  62   1        ET0=1;
  63   1        EA=1;
  64   1      }
  65          
  66          void keyscan()
  67          {
  68   1        uchar temp;
  69   1        P3=0x7f;P44=0;P42=1;
  70   1        temp=P3;
  71   1        temp=P3&0x0f;
  72   1        if(temp!=0x0f)
  73   1        {
  74   2          Delay5ms();
  75   2          if(temp!=0x0f)
  76   2          {
  77   3            temp=P3;
  78   3            temp=P3&0x0f;
  79   3            switch(temp)
  80   3            {
  81   4              case 0x0e: 
  82   4              {
  83   5                if(gongneng_flag==1) gongneng_flag=0;   
  84   5                shizhong_flag=1;moshi_flag=0;
  85   5              }
  86   4              break;
  87   4              case 0x0d:    break;
  88   4              case 0x0b:    break;
  89   4              case 0x07:gongneng_flag=1;moshi_flag++;break;
  90   4            } 
  91   3            while(P3!=0x7f);
  92   3          }
  93   2          
  94   2        }
  95   1        
  96   1        P3=0xbf;P44=1;P42=0;
  97   1        temp=P3;
  98   1        temp=P3&0x0f;
  99   1        if(temp!=0x0f)
 100   1        {
 101   2          Delay5ms();
 102   2          if(temp!=0x0f)
 103   2          {
 104   3            temp=P3;
 105   3            temp=P3&0x0f;
 106   3            switch(temp)
 107   3            {
 108   4              case 0x0e: jia_flag=1;  break;
 109   4              case 0x0d: jian_flag=1; break;
 110   4              case 0x0b:              break;
 111   4              case 0x07:              break;
 112   4            }
 113   3          }
 114   2          while(P3!=0xbf);
 115   2        }
 116   1      
C51 COMPILER V9.54   MAIN                                                                  12/24/2017 16:51:49 PAGE 3   

 117   1      }
 118          
 119          void time_chuli()
 120          {
 121   1        if(gongneng_flag==0)
 122   1            {
 123   2              dsbuff[0]=shijian[2]/10;
 124   2              dsbuff[1]=shijian[2]%10;
 125   2              dsbuff[2]=10;
 126   2              dsbuff[3]=shijian[1]/10;
 127   2              dsbuff[4]=shijian[1]%10;
 128   2              dsbuff[5]=10;
 129   2              dsbuff[6]=shijian[0]/10;
 130   2              dsbuff[7]=shijian[0]%10;
 131   2            }
 132   1            else 
 133   1            {
 134   2              switch(moshi_flag)// 进入闪烁状态 不能在主函数里写数码管显示 而应都放在中断中显示 
 135   2              {
 136   3                case 1:hour=1;minute=0;second=0;break;
 137   3                case 2:minute=1;hour=0;second=0;break;
 138   3                case 3:second=1;hour=0;minute=0;break;
 139   3                case 4:moshi_flag=1;break;
 140   3              }
 141   2                if(hour==1)
 142   2                {
 143   3                  if(jia_flag==1)
 144   3                  {
 145   4                    if(shijian[2]<=23)
 146   4                      { 
 147   5                        shijian[2]=shijian[2]+1;
 148   5                      }
 149   4                    jia_flag=0;
 150   4                    dswrite();
 151   4                  }
 152   3                  if(jian_flag==1)
 153   3                  {
 154   4                    if(shijian[2]>=1)
 155   4                      {
 156   5                        shijian[2]-=1; 
 157   5                      }
 158   4                    jian_flag=0;
 159   4                    dswrite();
 160   4                  } 
 161   3                }
 162   2                else if(minute==1)
 163   2                {
 164   3                  if(jia_flag==1)
 165   3                  {
 166   4                    if(shijian[1]<=58)
 167   4                      shijian[1]+=1;
 168   4                    jia_flag=0;
 169   4                    dswrite();
 170   4                  }
 171   3                  if(jian_flag==1)
 172   3                  {
 173   4                    if(shijian[1]>=1)
 174   4                      shijian[1]-=1;
 175   4                    jian_flag=0;
 176   4                    dswrite();
 177   4                  } 
 178   3                }
C51 COMPILER V9.54   MAIN                                                                  12/24/2017 16:51:49 PAGE 4   

 179   2                else if(second==1)
 180   2                {
 181   3                  if(jia_flag==1)
 182   3                  {
 183   4                    if(shijian[0]<=58)
 184   4                      shijian[0]+=1;
 185   4                    jia_flag=0;
 186   4                    dswrite();
 187   4                  }
 188   3                  if(jian_flag==1)
 189   3                  {
 190   4                    if(shijian[0]>=1)
 191   4                      shijian[0]-=1;
 192   4                    jian_flag=0;
 193   4                    dswrite();
 194   4                  }
 195   3                }
 196   2            }
 197   1      }
 198          
 199          void time_shan()
 200          {
 201   1          if(hour==1)
 202   1          {
 203   2            count_1++;
 204   2            if(count_1==200)
 205   2            {
 206   3              count_1=0;
 207   3              if(s_liang==0)
 208   3              {
 209   4                s_liang=1;
 210   4                dsbuff[0]=11;
 211   4                dsbuff[1]=11;
 212   4                dsbuff[2]=10;
 213   4                dsbuff[3]=shijian[1]/10;
 214   4                dsbuff[4]=shijian[1]%10;
 215   4                dsbuff[5]=10;
 216   4                dsbuff[6]=shijian[0]/10;
 217   4                dsbuff[7]=shijian[0]%10;    
 218   4              }
 219   3              else 
 220   3              {
 221   4                s_liang=0; 
 222   4                dsbuff[0]=shijian[2]/10;
 223   4                dsbuff[1]=shijian[2]%10;
 224   4                dsbuff[2]=10;
 225   4                dsbuff[3]=shijian[1]/10;
 226   4                dsbuff[4]=shijian[1]%10;
 227   4                dsbuff[5]=10;
 228   4                dsbuff[6]=shijian[0]/10;
 229   4                dsbuff[7]=shijian[0]%10;
 230   4              }
 231   3            }
 232   2          }
 233   1          else if(minute==1)
 234   1          {
 235   2            count_2++;
 236   2            if(count_2==200)
 237   2            {
 238   3              count_2=0;
 239   3              if(f_liang==0)
 240   3              {
C51 COMPILER V9.54   MAIN                                                                  12/24/2017 16:51:49 PAGE 5   

 241   4                f_liang=1;
 242   4                dsbuff[0]=shijian[2]/10;
 243   4                dsbuff[1]=shijian[2]%10;
 244   4                dsbuff[2]=10;
 245   4                dsbuff[3]=11;
 246   4                dsbuff[4]=11;
 247   4                dsbuff[5]=10;
 248   4                dsbuff[6]=shijian[0]/10;
 249   4                dsbuff[7]=shijian[0]%10;    
 250   4              }
 251   3              else 
 252   3              {
 253   4                f_liang=0;
 254   4                dsbuff[0]=shijian[2]/10;
 255   4                dsbuff[1]=shijian[2]%10;
 256   4                dsbuff[2]=10;
 257   4                dsbuff[3]=shijian[1]/10;
 258   4                dsbuff[4]=shijian[1]%10;
 259   4                dsbuff[5]=10;
 260   4                dsbuff[6]=shijian[0]/10;
 261   4                dsbuff[7]=shijian[0]%10;
 262   4              }
 263   3            }
 264   2          }
 265   1          else if(second==1)
 266   1          {
 267   2            count_3++;
 268   2            if(count_3==200)
 269   2            {
 270   3              count_3=0;
 271   3              if(m_liang==0)
 272   3              {
 273   4                m_liang=1;
 274   4                dsbuff[0]=shijian[2]/10;
 275   4                dsbuff[1]=shijian[2]%10;
 276   4                dsbuff[2]=10;
 277   4                dsbuff[3]=shijian[1]/10;
 278   4                dsbuff[4]=shijian[1]%10;
 279   4                dsbuff[5]=10;
 280   4                dsbuff[6]=11;
 281   4                dsbuff[7]=11;   
 282   4              }
 283   3              else 
 284   3              {
 285   4                m_liang=0;
 286   4                dsbuff[0]=shijian[2]/10;
 287   4                dsbuff[1]=shijian[2]%10;
 288   4                dsbuff[2]=10;
 289   4                dsbuff[3]=shijian[1]/10;
 290   4                dsbuff[4]=shijian[1]%10;
 291   4                dsbuff[5]=10;
 292   4                dsbuff[6]=shijian[0]/10;
 293   4                dsbuff[7]=shijian[0]%10;
 294   4              }
 295   3            }
 296   2          } 
 297   1      }
 298          
 299          void main()
 300          {
 301   1        allinit();
 302   1        Timer0Init();
C51 COMPILER V9.54   MAIN                                                                  12/24/2017 16:51:49 PAGE 6   

 303   1        Timer1Init();
 304   1        dswrite();
 305   1        while(1)
 306   1        {
 307   2          keyscan();
 308   2          dsread();
 309   2          if(shizhong_flag==1)
 310   2          {
 311   3            time_chuli(); 
 312   3          }    
 313   2        }
 314   1      }
 315          
 316          void time0() interrupt 1
 317          {
 318   1        display();
 319   1      }
 320          
 321          void time1() interrupt 3
 322          {
 323   1        if((shizhong_flag==1)&&(gongneng_flag==1))
 324   1        {
 325   2          time_shan();
 326   2        }
 327   1      }
 328          
 329          
 330          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    872    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
