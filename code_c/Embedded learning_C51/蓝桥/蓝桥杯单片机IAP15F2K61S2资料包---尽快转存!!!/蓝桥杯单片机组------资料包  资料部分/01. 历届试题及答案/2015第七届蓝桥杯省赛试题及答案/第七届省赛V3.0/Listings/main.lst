C51 COMPILER V9.54   MAIN                                                                  12/20/2017 19:41:26 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /**********************************************************************************
   2          实验功能：第七届省赛试题程序设计
   3          时间：2107.12.20
   4          作者：吴康
   5          ***********************************************************************************/
   6          #include <STC15F2K60S2.H>
   7          #include <onewire.h>
   8          
   9          #define uchar unsigned char 
  10          #define uint unsigned int 
  11          
  12          uchar code tab[]={0XC0,0XF9,0XA4,0XB0,0X99,0X92,0X82,0XF8,0X80,0X90,0XBF,0XFF,0XC6};
  13          uchar yi,er,san,si,wu ,liu,qi,ba; 
  14          uchar moshi=1;                    //工作模式变量
  15          uchar shijian=0;                  //倒计时变量
  16          uchar shiwen=0;                   //温度存储变量
  17          uint num=0,miao=0;                //定时用的标志位
  18          
  19          /**********************************************************************************
  20          函数名称：delayms
  21          功能：延时函数
  22          ***********************************************************************************/
  23          void delayms(int ms)
  24          {
  25   1        int i,j;
  26   1        for(i=ms;i>0;i--)
  27   1          for(j=940;j>0;j--);
  28   1      }
  29          
  30          /**********************************************************************************
  31          函数名称：keyscan
  32          功能：按键扫描函数
  33          ***********************************************************************************/
  34          void keyscan()
  35          {
  36   1        if(P33==0)                  //模式选择按键
  37   1        {
  38   2          delayms(9);
  39   2          if(P33==0)
  40   2            {
  41   3              if(er==1) moshi=2;
  42   3              else if(er==2) moshi=3;
  43   3              else if(er==3) moshi=1;
  44   3            }
  45   2          while(!P33);
  46   2        }
  47   1        else if(P32==0)             //时间选择按键
  48   1          {
  49   2            delayms(9);
  50   2            if(P32==0)
  51   2              {
  52   3                if(shijian==0) shijian=60;
  53   3                else if(shijian<=60) shijian=120;
  54   3                else if(shijian<=120) shijian=0;
C51 COMPILER V9.54   MAIN                                                                  12/20/2017 19:41:26 PAGE 2   

  55   3              }
  56   2            while(!P32);
  57   2          }
  58   1        else if(P31==0)             //时间清除按键
  59   1          {
  60   2            delayms(9);
  61   2            if(P31==0) shijian=0;
  62   2            while(!P31);
  63   2          }
  64   1        else if(P30==0)             //温度显示按键
  65   1          {
  66   2            delayms(9);
  67   2            if(P30==0)
  68   2              { 
  69   3                if(shiwen==0) shiwen=1;
  70   3                else if(shiwen==1) shiwen=0;
  71   3              }
  72   2            while(!P30);
  73   2          }
  74   1      }
  75          
  76          /**********************************************************************************
  77          函数名称：display
  78          功能：显示函数
  79          ***********************************************************************************/
  80          void display1(uchar yi,uchar er)
  81          {
  82   1          P2=0XC0;//打开位选573   U8
  83   1          P0=0X01;//选择第一个数码管
  84   1          P2=0XFF;//打开段选573   U7
  85   1          P0=tab[yi];
  86   1          delayms(1);
  87   1          
  88   1          P2=0XC0;//打开位选573   U8
  89   1          P0=0X02;//选择第二个数码管
  90   1          P2=0XFF;//打开段选573   U7
  91   1          P0=tab[er];
  92   1          delayms(1);
  93   1      } 
  94          
  95          void display2(uchar san,uchar si)
  96          {
  97   1          P2=0XC0;//打开位选573   U8
  98   1          P0=0X04;//选择第三个数码管
  99   1          P2=0XFF;//打开段选573   U7
 100   1          P0=tab[san];
 101   1          delayms(1);
 102   1          
 103   1          P2=0XC0;//打开位选573   U8
 104   1          P0=0X08;//选择第四个数码管
 105   1          P2=0XFF;//打开段选573   U7
 106   1          P0=tab[si];
 107   1          delayms(1);
 108   1      }
 109          
 110          void display3(uchar wu,uchar liu)
 111          {
 112   1          P2=0XC0;//打开位选573   U8
 113   1          P0=0X10;//选择第一个数码管
 114   1          P2=0XFF;//打开段选573   U7
 115   1          P0=tab[wu];
 116   1          delayms(1);
C51 COMPILER V9.54   MAIN                                                                  12/20/2017 19:41:26 PAGE 3   

 117   1          
 118   1          P2=0XC0;//打开位选573   U8
 119   1          P0=0X20;//选择第一个数码管
 120   1          P2=0XFF;//打开段选573   U7
 121   1          P0=tab[liu];
 122   1          delayms(1);
 123   1      }
 124          
 125          void display4(uchar qi,uchar ba)
 126          {
 127   1          P2=0XC0;//打开位选573   U8
 128   1          P0=0X40;//选择第一个数码管
 129   1          P2=0XFF;//打开段选573   U7
 130   1          P0=tab[qi];
 131   1          delayms(1);
 132   1          
 133   1          P2=0XC0;//打开位选573   U8
 134   1          P0=0X80;//选择第一个数码管
 135   1          P2=0XFF;//打开段选573   U7
 136   1          P0=tab[ba];
 137   1          delayms(1);
 138   1      }
 139          
 140          /**********************************************************************************
 141          函数名称：Timer0Init
 142          功能：定时器0初始化函数
 143          ***********************************************************************************/
 144          void Timer0Init(void)   //100微秒@11.0592MHz
 145          {
 146   1        AUXR |= 0x80;         //定时器时钟1T模式
 147   1        TMOD &= 0xF0;         //设置定时器模式
 148   1        TL0 = 0xAE;           //设置定时初值
 149   1        TH0 = 0xFB;           //设置定时初值
 150   1        TF0 = 0;              //清除TF0标志
 151   1        TR0 = 1;              //定时器0开始计时
 152   1        EA=1;
 153   1        ET0=1;
 154   1      }
 155          
 156          /**********************************************************************************
 157          函数名称：main
 158          功能：主函数
 159          ***********************************************************************************/
 160          void main()
 161          {
 162   1        allinit();                          //板子整体初始化
 163   1        Timer0Init();                       //定时器0初始化
 164   1        yi=10;er=1;san=10;si=11;wu=0;liu=0;qi=0;ba=0;
 165   1        while(1)
 166   1        {
 167   2          keyscan();                        //按键扫描函数
 168   2          if(shiwen==0)                     //初始界面显示
 169   2            {
 170   3              yi=10;
 171   3              san=10;
 172   3              si=11;
 173   3              er=moshi;
 174   3              wu=shijian/1000;
 175   3              liu=shijian%1000/100;
 176   3              qi=shijian%100/10;
 177   3              ba=shijian%10;
 178   3            }
C51 COMPILER V9.54   MAIN                                                                  12/20/2017 19:41:26 PAGE 4   

 179   2          else if(shiwen==1)                //进入温度显示界面
 180   2            {
 181   3              yi=10;
 182   3              er=4;
 183   3              san=10;
 184   3              si=11;
 185   3              wu=11;
 186   3              liu=temget()/10;
 187   3              qi=temget()%10;
 188   3              ba=12;
 189   3              delayms(1);
 190   3            }   
 191   2          if(shijian>0)                     //判断是那个模式选择亮那个灯
 192   2          {
 193   3            if(moshi==1)
 194   3              { 
 195   4                P2=0X80;
 196   4                P0=0XFE;
 197   4              }
 198   3            else if(moshi==2)
 199   3              { 
 200   4                P2=0X80;
 201   4                P0=0XFD;
 202   4              }
 203   3            else if(moshi==3)
 204   3              { 
 205   4                P2=0X80;
 206   4                P0=0XFB;
 207   4              }
 208   3          }
 209   2          else 
 210   2            { 
 211   3              P2=0X80;
 212   3              P0=0XFF;
 213   3            }
 214   2            display1(yi,er);                  //显示函数
 215   2            display2(san,si);
 216   2            display3(wu,liu);
 217   2            display4(qi,ba);
 218   2          }
 219   1      }
 220          
 221          /**********************************************************************************
 222          函数名称：Timer0
 223          功能：定时器0的中断服务函数
 224          ***********************************************************************************/
 225          void Timer0() interrupt 1
 226          {
 227   1        num++;miao++;
 228   1        if(num>10) num=1;                       //设置周期
 229   1        if(miao==10000)                         //定时时间1s
 230   1          {
 231   2            miao=0;
 232   2            if(shijian>0) shijian--;
 233   2          }
 234   1        if(shijian>0)                           //判断倒计时是否结束，若结束则不输出PWM波
 235   1          {
 236   2            if(moshi==1)
 237   2              {
 238   3                if(num<3) P34=1;
 239   3                else P34=0;
 240   3              }
C51 COMPILER V9.54   MAIN                                                                  12/20/2017 19:41:26 PAGE 5   

 241   2            else if(moshi==2)
 242   2              {
 243   3                if(num<4) P34=1;
 244   3                else P34=0;
 245   3              }
 246   2            else if(moshi==3)
 247   2              {
 248   3                if(num<8) P34=1;
 249   3                else P34=0;
 250   3              }
 251   2          }
 252   1      }
 253          
 254          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    730    ----
   CONSTANT SIZE    =     13    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     15    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
