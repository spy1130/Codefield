C51 COMPILER V9.54   MAIN                                                                  12/23/2017 14:57:17 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <stc15f2k60s2.h>
   2          #include <24c02.h>
   3          #include <ds18b20.h>
   4          
   5          #define uint unsigned int
   6          #define uchar unsigned char
   7          
   8          uchar keysta[4]={1,1,1,1},DQTH,DQTL,temp;
   9          bit flag;
  10          
  11          uchar code smgchar[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
  12          uchar smgbuff[8]={0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff};
  13          
  14          void smg_ds18b20(unsigned char temp,unsigned char THC,unsigned char TLC)
  15          {
  16   1        smgbuff[0]=smgchar[temp%10];
  17   1        smgbuff[1]=smgchar[temp/10%10];
  18   1        smgbuff[2]=smgchar[11];
  19   1        smgbuff[3]=smgchar[11];
  20   1        smgbuff[4]=smgchar[TLC%10];
  21   1        smgbuff[5]=smgchar[TLC/10%10];
  22   1        smgbuff[6]=smgchar[THC%10];
  23   1        smgbuff[7]=smgchar[THC/10%10];
  24   1      }
  25          
  26          void Time_T0(unsigned char ms)
  27          {
  28   1        unsigned int temp;
  29   1        TMOD&=0xf0;
  30   1        TMOD|=0x00;
  31   1        temp=11059200/12/1000;
  32   1        temp=65536-temp*ms;
  33   1        TH0=temp/256;
  34   1        TL0=temp%256;
  35   1        EA=1;
  36   1        ET0=1;
  37   1        TR0=1;
  38   1      }
  39          
  40          void smg_buff()
  41          {
  42   1        static unsigned char i,cnt=0x80;
  43   1        P0=0x00;
  44   1        P2&=0x1f;
  45   1        P2|=0xc0;
  46   1        P2&=0x1f;
  47   1        P0=smgbuff[i];
  48   1        P2|=0xe0;
  49   1        P2&=0x1f;
  50   1        P0=cnt>>i;
  51   1        P2|=0xc0;
  52   1        P2&=0x1f;
  53   1        i++;
  54   1        if(i==8)
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 14:57:17 PAGE 2   

  55   1        i=0;  
  56   1      }
  57          
  58          void warningDS1302()
  59          {
  60   1        static bit relay,pwmkey;
  61   1        if(DQTH<temp&&pwmkey==0)
  62   1        {
  63   2          pwmkey=1;
  64   2          TR1=1;  
  65   2        }
  66   1        if(DQTH>=temp&&pwmkey==1)
  67   1        {
  68   2          pwmkey=0;
  69   2          TR1=0;
  70   2          P34=1;
  71   2        }
  72   1        if(DQTL<=temp)
  73   1        {
  74   2          if(relay)
  75   2          {
  76   3            relay=0;
  77   3            P0=0x00;
  78   3            P2&=0x1f;
  79   3            P2|=0xa0;
  80   3            P2&=0x1f; 
  81   3          }
  82   2        }
  83   1        if(DQTL>temp)
  84   1        {
  85   2          if(relay==0)
  86   2          {
  87   3            relay=1;
  88   3            P0=0x00;
  89   3            P2&=0x1f;
  90   3            P2|=0xa0;
  91   3            P04=1;
  92   3            P2&=0x1f;
  93   3          }   
  94   2        }
  95   1      }
  96          void key_4()
  97          {
  98   1        static unsigned char keyback[4]={1,1,1,1},i;
  99   1        for(i=0;i<4;i++)
 100   1        {
 101   2          if(keyback[i]!=keysta[i])
 102   2          {
 103   3            if(keyback[i]==0)
 104   3            {
 105   4              switch(i)
 106   4              {
 107   5                case 0:DQTL--;if(DQTL>100)DQTL=0;at24c02_wirte(0x01,DQTL);break;
 108   5                case 1:DQTH--;if(DQTH>100)DQTH=0;if(DQTL>DQTH)DQTH=DQTL;at24c02_wirte(0x00,DQTH);break;
 109   5                case 2:DQTL++;if(DQTL>=100)DQTL=99;if(DQTL>DQTH)DQTL=DQTH;at24c02_wirte(0x01,DQTL);break;
 110   5                case 3:DQTH++;if(DQTH>=100)DQTH=99;at24c02_wirte(0x00,DQTH);break;
 111   5                default:break;
 112   5              }
 113   4            }
 114   3            keyback[i]=keysta[i];
 115   3          }
 116   2        } 
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 14:57:17 PAGE 3   

 117   1      }
 118          
 119          
 120          void scanf_key()
 121          {
 122   1        static unsigned char i,keybuf[4]={0xff,0xff,0xff,0xff};
 123   1        keybuf[0]=(keybuf[0]<<1)|P30;
 124   1        keybuf[1]=(keybuf[1]<<1)|P31;
 125   1        keybuf[2]=(keybuf[2]<<1)|P32;
 126   1        keybuf[3]=(keybuf[3]<<1)|P33;
 127   1        for(i=0;i<4;i++)
 128   1        {
 129   2          if(keybuf[i]==0x00)
 130   2            keysta[i]=0;
 131   2          if(keybuf[i]==0xff)
 132   2            keysta[i]=1;
 133   2        }
 134   1      }
 135          void Timer1Init(void)   //100微秒@11.0592MHz
 136          {
 137   1        AUXR |= 0x40;   //定时器时钟1T模式
 138   1        TMOD &= 0x0F;   //设置定时器模式
 139   1        TL1 = 0xAE;   //设置定时初值
 140   1        TH1 = 0xFB;   //设置定时初值
 141   1        ET1=1;
 142   1      }
 143          
 144          void allinit()
 145          {
 146   1        P0=0xff;
 147   1        P2&=0x1f;
 148   1        P2|=0x80;
 149   1        P2&=0x1f;
 150   1        P0=0x00;
 151   1        P2&=0x1f;
 152   1        P2|=0xa0;
 153   1        P2&=0x1f;
 154   1      }
 155          void main()
 156          {
 157   1        allinit();
 158   1        DQTH=at24c02_read(0x00);
 159   1        DQTL=at24c02_read(0x01);
 160   1        Time_T0(1);
 161   1        Timer1Init();
 162   1        while(1)
 163   1        {
 164   2          if(flag)
 165   2          {
 166   3            flag=0;
 167   3            temp=read_ds18b20();
 168   3          }
 169   2          key_4();
 170   2          smg_ds18b20(temp,DQTH,DQTL);
 171   2          warningDS1302();
 172   2        }
 173   1      }
 174          
 175          
 176          void TimeT0interrupt() interrupt 1
 177          {
 178   1        static unsigned int i;
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 14:57:17 PAGE 4   

 179   1        i++;
 180   1        if(i==1000)
 181   1        {
 182   2          flag=1;
 183   2          i=0;
 184   2        }
 185   1        scanf_key();
 186   1        if(i%2)
 187   1        smg_buff();
 188   1      }
 189          void TimeT1interrupt() interrupt 3
 190          {
 191   1        static unsigned char i;
 192   1        if(i<3&&P34==0)
 193   1        P34=1;
 194   1        else if(i>3&&i<10&&P34==1)
 195   1        P34=0;
 196   1        i++;
 197   1        if(i==10)
 198   1        i=0;
 199   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    696    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     30    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
