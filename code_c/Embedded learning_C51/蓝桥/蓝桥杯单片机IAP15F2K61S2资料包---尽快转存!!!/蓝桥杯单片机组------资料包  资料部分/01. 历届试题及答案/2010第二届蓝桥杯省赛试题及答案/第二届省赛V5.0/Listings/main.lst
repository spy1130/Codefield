C51 COMPILER V9.54   MAIN                                                                  12/23/2017 15:52:13 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\keil   55\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ma
                    -in.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*******************************************************************************
   2          实验功能：第二届省赛试题程序设计
   3          时间：2017.12.23
   4          作者：吴康
   5          *******************************************************************************/
   6          #include <STC15F2K60S2.h>
   7          #include <24c02.h>
   8          #include <ds18b20.h>
   9          
  10          #define uint unsigned int
  11          #define uchar unsigned char
  12          
  13          uchar code tab[12]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
  14          uchar dsbuff[8]={11,11,11,11,11,11,11,11};
  15          uchar DQTH,DQTL,temp;//设定温度上下限变量
  16          uchar discount;      //数码管显示变量
  17          uchar flag;          //读取温度的标志位
  18          
  19          /*******************************************************************************
  20          函数名称：delayms
  21          功能：延时函数
  22          *******************************************************************************/
  23          void delayms(uint xms)
  24          {
  25   1        uint i,j;
  26   1        for(i=xms;i>0;i--)
  27   1        for(j=110;j>0;j--);
  28   1      }
  29          
  30          /*******************************************************************************
  31          函数名称：display
  32          功能：显示函数
  33          *******************************************************************************/
  34          void display()
  35          {
  36   1        P2=0XEF;
  37   1        P0=0XFF;
  38   1        P2=0X1F;
  39   1        
  40   1        P2=0XCF;
  41   1        P0=1<<discount;
  42   1        P2=0X1F;
  43   1        
  44   1        P2=0XEF;
  45   1        P0=tab[dsbuff[discount]];
  46   1        P2=0X1F;
  47   1        
  48   1        if(++discount==8) discount=0;
  49   1      }
  50          
  51          /*******************************************************************************
  52          函数名称：warning
  53          功能：超限输出PWM函数
  54          *******************************************************************************/
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 15:52:13 PAGE 2   

  55          void warning()
  56          {
  57   1        static bit relay,pwmkey;
  58   1        if(DQTH<temp&&pwmkey==0)
  59   1          {
  60   2            pwmkey=1;
  61   2            TR1=1;  
  62   2          }
  63   1        if(DQTH>=temp&&pwmkey==1)
  64   1          {
  65   2            pwmkey=0;
  66   2            TR1=0;
  67   2            P34=1;
  68   2          }
  69   1        if(DQTL<=temp)
  70   1          {
  71   2            if(relay)
  72   2              {
  73   3                relay=0;
  74   3                P0=0x00;
  75   3                P2&=0x1f;
  76   3                P2|=0xa0;
  77   3                P2&=0x1f; 
  78   3              }
  79   2          }
  80   1        if(DQTL>temp)
  81   1          {
  82   2            if(relay==0)
  83   2              {
  84   3                relay=1;
  85   3                P0=0x00;
  86   3                P2&=0x1f;
  87   3                P2|=0xa0;
  88   3                P04=1;
  89   3                P2&=0x1f;
  90   3              }   
  91   2          }
  92   1      }
  93          
  94          /*******************************************************************************
  95          函数名称：key
  96          功能：按键函数
  97          *******************************************************************************/
  98          void key()
  99          {
 100   1        if(P33==0)
 101   1          {
 102   2            delayms(10);
 103   2            if(P33==0)
 104   2              {
 105   3                DQTL--;
 106   3                if(DQTL>100) DQTL=0;
 107   3                at24c02_wirte(0x01,DQTL);
 108   3              }
 109   2              while(!P33);
 110   2          }
 111   1        
 112   1        if(P32==0)
 113   1          {
 114   2            delayms(10);
 115   2            if(P32==0)
 116   2              {
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 15:52:13 PAGE 3   

 117   3                DQTH--;
 118   3                if(DQTH>100) DQTH=0;
 119   3                if(DQTL>DQTH) DQTH=DQTL;
 120   3                at24c02_wirte(0x00,DQTH);
 121   3              }
 122   2            while(!P32);
 123   2          }
 124   1        
 125   1        if(P31==0)
 126   1          {
 127   2            delayms(10);
 128   2            if(P31==0)
 129   2              {
 130   3                DQTL++;
 131   3                if(DQTL>=100) DQTL=99;
 132   3                if(DQTL>DQTH) DQTL=DQTH;
 133   3                at24c02_wirte(0x01,DQTL);
 134   3              }
 135   2              while(!P31);
 136   2          }
 137   1        
 138   1        if(P30==0)
 139   1          {
 140   2            delayms(10);
 141   2            if(P30==0)
 142   2              {
 143   3                DQTH++;
 144   3                if(DQTH>=100) DQTH=99;
 145   3                at24c02_wirte(0x00,DQTH);
 146   3              }
 147   2              while(!P30);
 148   2          }
 149   1      }
 150          /*******************************************************************************
 151          函数名称：Timer0Init
 152          功能：定时器0初始化函数
 153          *******************************************************************************/
 154          void Timer0Init(void)   //1毫秒@11.0592MHz
 155          {
 156   1        AUXR |= 0x80;         //定时器时钟1T模式
 157   1        TMOD &= 0xF0;         //设置定时器模式
 158   1        TL0 = 0xCD;           //设置定时初值
 159   1        TH0 = 0xD4;           //设置定时初值
 160   1        TF0 = 0;              //清除TF0标志
 161   1        TR0 = 1;              //定时器0开始计时
 162   1        EA=1;
 163   1        ET0=1;
 164   1      }
 165          
 166          /*******************************************************************************
 167          函数名称：Timer1Init
 168          功能：定时器1初始化函数
 169          *******************************************************************************/
 170          void Timer1Init(void)   //100微秒@11.0592MHz
 171          {
 172   1        AUXR |= 0x40;         //定时器时钟1T模式
 173   1        TMOD &= 0x0F;         //设置定时器模式
 174   1        TL1 = 0xAE;           //设置定时初值
 175   1        TH1 = 0xFB;           //设置定时初值
 176   1        EA=1;
 177   1        ET1=1;
 178   1      }
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 15:52:13 PAGE 4   

 179          
 180          /*******************************************************************************
 181          函数名称：allinit
 182          功能：板子初始化函数
 183          *******************************************************************************/
 184          void allinit()
 185          {
 186   1          P2=0X80;P0=0XFF;
 187   1          P2=0XA0;P0=0X00;
 188   1          P2=0XC0;P0=0XFF;
 189   1          P2=0XE0;P0=0XFF;
 190   1      }
 191          
 192          /*******************************************************************************
 193          函数名称：main
 194          功能：主函数
 195          *******************************************************************************/
 196          void main()
 197          {
 198   1        allinit();              //板子整体初始化
 199   1        DQTH=at24c02_read(0x00);//读0x00地址里的数据
 200   1        DQTL=at24c02_read(0x01);//读0x01地址里的数据
 201   1        Timer0Init();           //定时器0初始化
 202   1        Timer1Init();           //定时器1初始化
 203   1        while(1)
 204   1        {
 205   2            if(flag==1)         //定时读取温度
 206   2              {
 207   3                flag=0;
 208   3                temp=read_ds18b20();
 209   3              }
 210   2            warning();          //报警函数
 211   2            dsbuff[7]=temp%10;
 212   2            dsbuff[6]=temp/10;
 213   2            dsbuff[5]=11;
 214   2            dsbuff[4]=11;
 215   2            dsbuff[3]=DQTL%10;
 216   2            dsbuff[2]=DQTL/10;
 217   2            dsbuff[1]=DQTH%10;
 218   2            dsbuff[0]=DQTH/10;
 219   2        }
 220   1      }
 221          
 222          /*******************************************************************************
 223          函数名称：Timer0
 224          功能：定时器0中断服务函数
 225          *******************************************************************************/
 226          void Timer0() interrupt 1
 227          {
 228   1        uint i;
 229   1        display();
 230   1        key();
 231   1        i++;
 232   1        if(i==4)
 233   1          {
 234   2            flag=1;
 235   2            i=0;
 236   2          }
 237   1      }
 238          
 239          /*******************************************************************************
 240          函数名称：Timer1
C51 COMPILER V9.54   MAIN                                                                  12/23/2017 15:52:13 PAGE 5   

 241          功能：定时器1中断服务函数
 242          *******************************************************************************/
 243          void Timer1() interrupt 3
 244          {
 245   1        static unsigned char i;
 246   1        if(i<3&&P34==0)
 247   1        P34=1;
 248   1        else if(i>3&&i<10&&P34==1)
 249   1        P34=0;
 250   1        i++;
 251   1        if(i==10)
 252   1        i=0;
 253   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    614    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     14       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
