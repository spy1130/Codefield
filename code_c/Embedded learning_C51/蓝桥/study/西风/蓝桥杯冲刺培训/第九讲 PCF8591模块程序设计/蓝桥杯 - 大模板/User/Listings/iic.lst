C51 COMPILER V9.54   IIC                                                                   01/13/2023 19:27:05 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\iic.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\Driver\iic.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Driver) DEBUG OBJECTE
                    -XTEND PRINT(.\Listings\iic.lst) TABS(2) OBJECT(.\Objects\iic.obj)

line level    source

   1          /*
   2            程序说明: IIC总线驱动程序
   3            软件环境: Keil uVision 4.10 
   4            硬件环境: CT107单片机综合实训平台 8051，12MHz
   5            日    期: 2011-8-9
   6          */
   7          
   8          #include "iic.h"
   9          
  10          //总线引脚定义
  11          sbit SDA = P2^1;  /* 数据线 */
  12          sbit SCL = P2^0;  /* 时钟线 */
  13          
  14          void IIC_Delay(unsigned char i)
  15          {
  16   1          do{_nop_();}
  17   1          while(i--);        
  18   1      }
  19          
  20          //总线启动条件
  21          void IIC_Start(void)
  22          {
  23   1          SDA = 1;
  24   1          SCL = 1;
  25   1          IIC_Delay(DELAY_TIME);
  26   1          SDA = 0;
  27   1          IIC_Delay(DELAY_TIME);
  28   1          SCL = 0;  
  29   1      }
  30          
  31          //总线停止条件
  32          void IIC_Stop(void)
  33          {
  34   1          SDA = 0;
  35   1          SCL = 1;
  36   1          IIC_Delay(DELAY_TIME);
  37   1          SDA = 1;
  38   1          IIC_Delay(DELAY_TIME);
  39   1      }
  40          
  41          //发送应答
  42          void IIC_SendAck(bit ackbit)
  43          {
  44   1          SCL = 0;
  45   1          SDA = ackbit;           // 0：应答，1：非应答
  46   1          IIC_Delay(DELAY_TIME);
  47   1          SCL = 1;
  48   1          IIC_Delay(DELAY_TIME);
  49   1          SCL = 0; 
  50   1          SDA = 1;
  51   1          IIC_Delay(DELAY_TIME);
  52   1      }
  53          
  54          //等待应答
C51 COMPILER V9.54   IIC                                                                   01/13/2023 19:27:05 PAGE 2   

  55          bit IIC_WaitAck(void)
  56          {
  57   1          bit ackbit;
  58   1        
  59   1          SCL  = 1;
  60   1          IIC_Delay(DELAY_TIME);
  61   1          ackbit = SDA;
  62   1          SCL = 0;
  63   1          IIC_Delay(DELAY_TIME);
  64   1          return ackbit;
  65   1      }
  66          
  67          //通过I2C总线发送数据
  68          void IIC_SendByte(unsigned char byt)
  69          {
  70   1          unsigned char i;
  71   1      
  72   1          for(i=0; i<8; i++)
  73   1          {
  74   2              SCL  = 0;
  75   2              IIC_Delay(DELAY_TIME);
  76   2              if(byt & 0x80) SDA  = 1;
  77   2              else SDA  = 0;
  78   2              IIC_Delay(DELAY_TIME);
  79   2              SCL = 1;
  80   2              byt <<= 1;
  81   2              IIC_Delay(DELAY_TIME);
  82   2          }
  83   1          SCL  = 0;  
  84   1      }
  85          
  86          //从I2C总线上接收数据
  87          unsigned char IIC_RecByte(void)
  88          {
  89   1          unsigned char i, da;
  90   1          for(i=0; i<8; i++)
  91   1          {   
  92   2            SCL = 1;
  93   2        IIC_Delay(DELAY_TIME);
  94   2        da <<= 1;
  95   2        if(SDA) da |= 1;
  96   2        SCL = 0;
  97   2        IIC_Delay(DELAY_TIME);
  98   2          }
  99   1          return da;    
 100   1      }
 101          
 102          
 103          
 104          
 105          
 106          //函数名：ADC转换函数
 107          //入口参数：要进行转换的通道控制位
 108          //返回值：ADC转换的数值
 109          //函数功能：对指定的通道进行ADC转换，函数返回转换的数值
 110          unsigned char AD_Read(unsigned char channel_num_contrl)
 111          {
 112   1        unsigned char temp;
 113   1        
 114   1        IIC_Start();//发送开启信号
 115   1        IIC_SendByte(0x90);//选择PCF8591芯片，确定写的模式
 116   1        IIC_WaitAck();//等待PCF8591反馈
C51 COMPILER V9.54   IIC                                                                   01/13/2023 19:27:05 PAGE 3   

 117   1        
 118   1        IIC_SendByte(channel_num_contrl);//确定要转换的通道（顺便，使能DA转换）
 119   1        IIC_WaitAck();//等待PCF8591反馈 
 120   1        
 121   1        IIC_Start();//发送开启信号
 122   1        IIC_SendByte(0x91);//选择PCF8591芯片，确定读的模式
 123   1        IIC_WaitAck();//等待PCF8591反馈 
 124   1          
 125   1        temp = IIC_RecByte();//接收数据
 126   1        IIC_SendAck(1);//选择不应答
 127   1        IIC_Stop();//停止发送
 128   1        
 129   1        return temp;
 130   1      
 131   1      }
 132          
 133          
 134          
 135          //函数名：DAC转换函数
 136          //入口参数：要进行转换的数值
 137          //返回值：无
 138          //函数功能：对入口参数要转换的DA数据进行转换
 139          void DA_Write(unsigned char trans_dat)
 140          {
 141   1        IIC_Start();//发送开启信号
 142   1        IIC_SendByte(0x90);//选择PCF8591芯片，确定写的模式
 143   1        IIC_WaitAck();//等待PCF8591反馈
 144   1        
 145   1        IIC_SendByte(0x41);//使能DA转换（随便写通道编号，不影响，主要的功能是使能DA）
 146   1        IIC_WaitAck();//等待PCF8591反馈   
 147   1      
 148   1        IIC_SendByte(trans_dat);//将待转换的数据发送出去
 149   1        IIC_WaitAck();//等待PCF8591反馈 
 150   1        IIC_Stop();//停止发送 
 151   1      
 152   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    222    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
