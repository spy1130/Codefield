C51 COMPILER V9.54   MAIN                                                                  04/06/2023 12:22:09 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Driver) DEBUG OBJECTEXTEND PRI
                    -NT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /* å¤´æ–‡ä»¶å£°æ˜åŒº */
   2          #include <STC15F2K60S2.H>//å•ç‰‡æœºå¯„å­˜å™¨ä¸“ç”¨å¤´æ–‡ä»¶
   3          #include <Init.h>//åˆå§‹åŒ–åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   4          #include <Led.h>//Ledåº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   5          #include <Key.h>//æŒ‰é”®åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   6          #include <Seg.h>//æ•°ç ç®¡åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   7          #include <Uart.h>//ä¸²å£åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   8          #include "onewire.h"//æ¸©åº¦åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   9          #include "iic.h"//å•æ€»çº¿åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
  10          #include <stdio.h>//sprintfä¸“ç”¨å¤´æ–‡ä»¶
  11          
  12          /* å˜é‡å£°æ˜åŒº */
  13          unsigned char Key_Val,Key_Down,Key_Old,Key_Up;//æŒ‰é”®ä¸“ç”¨å˜é‡
  14          unsigned char Key_Slow_Down;//æŒ‰é”®å‡é€Ÿä¸“ç”¨å˜é‡
  15          idata unsigned char Seg_Buf[8] = {10,10,10,10,10,10,10,10};//æ•°ç ç®¡æ˜¾ç¤ºæ•°æ®å­˜æ”¾æ•°ç»„
  16          idata unsigned char Seg_Point[8] = {0,0,0,0,0,0,0,0};//æ•°ç ç®¡å°æ•°ç‚¹æ•°æ®å­˜æ”¾æ•°ç»„
  17          unsigned char Seg_Pos;//æ•°ç ç®¡æ‰«æä¸“ç”¨å˜é‡
  18          unsigned int Seg_Slow_Down;//æ•°ç ç®¡å‡é€Ÿä¸“ç”¨å˜é‡
  19          idata unsigned char ucLed[8] = {0,0,0,0,0,0,0,0};//Ledæ˜¾ç¤ºæ•°æ®å­˜æ”¾æ•°ç»„
  20          unsigned char Uart_Slow_Down;//ä¸²å£å‡é€Ÿä¸“ç”¨å˜é‡
  21          unsigned char Uart_Recv[8];//ä¸²å£æ¥æ”¶æ•°æ®å‚¨å­˜æ•°ç»„ é»˜è®¤10ä¸ªå­—èŠ‚ è‹¥æ¥æ”¶æ•°æ®è¾ƒé•¿ å¯æ›´
             -æ”¹æœ€å¤§å­—èŠ‚æ•°
  22          unsigned char Uart_Recv_Index;//ä¸²å£æ¥æ”¶æ•°ç»„æŒ‡é’ˆ
  23          unsigned char Uart_Send[12];//ä¸²å£æ¥æ”¶æ•°æ®å‚¨å­˜æ•°ç»„ é»˜è®¤10ä¸ªå­—èŠ‚ è‹¥å‘é€æ•°æ®è¾ƒé•¿ å¯æ›
             -´æ”¹æœ€å¤§å­—èŠ‚æ•°
  24          bit Seg_Disp_Mode;//æ•°ç ç®¡æ˜¾ç¤ºæ¨¡å¼å˜é‡ 0-æ¸©åº¦æ˜¾ç¤º 1-æº¶æ°§åº¦æ˜¾ç¤º
  25          float Temperature;//å®æ—¶æ¸©åº¦é‡‡é›†å˜é‡
  26          float Oxygen_Val;//å®æ—¶æº¶æ°§åº¦é‡‡é›†å˜é‡
  27          bit System_Flag;//ç³»ç»Ÿå¯åŠ¨æ ‡å¿—ä½ 0-å…³é—­ 1-å¯åŠ¨
  28          bit Start_Flag;//è‡ªåŠ¨å–‚é£Ÿæ ‡å¿—ä½ 0-å…³é—­ 1-å¯åŠ¨
  29          unsigned int Timer_3000Ms;//ä¸‰åƒæ¯«ç§’è®¡æ—¶å˜é‡
  30          
  31          /* é”®ç›˜å¤„ç†å‡½æ•° */
  32          void Key_Proc()
  33          {
  34   1        if(Key_Slow_Down) return;
  35   1        Key_Slow_Down = 1;//é”®ç›˜å‡é€Ÿç¨‹åº
  36   1      
  37   1        Key_Val = Key_Read();//å®æ—¶è¯»å–é”®ç å€¼
  38   1        Key_Down = Key_Val & (Key_Old ^ Key_Val);//æ•æ‰æŒ‰é”®ä¸‹é™æ²¿
  39   1        Key_Up = ~Key_Val & (Key_Old ^ Key_Val);//æ•æ‰æŒ‰é”®ä¸Šé™æ²¿
  40   1        Key_Old = Key_Val;//è¾…åŠ©æ‰«æå˜é‡
  41   1      
  42   1        if(Key_Down == 4) //ç³»ç»Ÿå¯åŠ¨æš‚åœæŒ‰é”®
  43   1          System_Flag ^= 1;
  44   1        
  45   1        if((Key_Down * System_Flag) == 5) //ç•Œé¢åˆ‡æ¢åŠŸèƒ½æŒ‰é”®
  46   1          Seg_Disp_Mode ^= 1;
  47   1      }
  48          
  49          /* ä¿¡æ¯å¤„ç†å‡½æ•° */
  50          void Seg_Proc()
  51          { 
  52   1        /* ä¿¡æ¯è·å–åŒºåŸŸ */
C51 COMPILER V9.54   MAIN                                                                  04/06/2023 12:22:09 PAGE 2   

  53   1        switch(Seg_Slow_Down)
  54   1        {
  55   2          case 200://å®æ—¶æº¶æ°§åº¦è¯»å–
  56   2            Seg_Slow_Down += 1;
  57   2            Oxygen_Val = Ad_Read(0x43) / 51.0 * 2.0;
  58   2          break;
  59   2          case 400://å®æ—¶æ¸©åº¦è¯»å–
  60   2            Seg_Slow_Down += 1;
  61   2            Temperature = rd_temperature();
  62   2          break;
  63   2        }
  64   1      
  65   1        /* æ•°æ®æ˜¾ç¤ºåŒºåŸŸ */
  66   1        Seg_Buf[0] = 11;//æ ‡è¯†ç¬¦U
  67   1        Seg_Buf[1] = (unsigned char)Seg_Disp_Mode + 1;
  68   1        if(Seg_Disp_Mode == 0) //æ¸©åº¦æ˜¾ç¤ºç•Œé¢
  69   1        {
  70   2          Seg_Buf[4] = 10;
  71   2          Seg_Buf[5] = (unsigned char)Temperature / 10 % 10;
  72   2          Seg_Buf[6] = (unsigned char)Temperature % 10;
  73   2          Seg_Buf[7] = (unsigned int)(Temperature * 10) % 10;
  74   2          Seg_Point[6] = 1;
  75   2          Seg_Point[5] = 0;
  76   2        }
  77   1        else //æº¶æ°§åº¦æ˜¾ç¤ºç•Œé¢
  78   1        {
  79   2          Seg_Buf[4] = (unsigned char)Oxygen_Val / 10 % 10?1:10;
  80   2          Seg_Buf[5] = (unsigned char)Oxygen_Val % 10;
  81   2          Seg_Buf[6] = (unsigned int)(Oxygen_Val * 100) / 10 % 10;  
  82   2          Seg_Buf[7] = (unsigned int)(Oxygen_Val * 100) % 10;     
  83   2          Seg_Point[6] = 0;
  84   2          Seg_Point[5] = 1;   
  85   2        }
  86   1      }
  87          
  88          /* å…¶ä»–æ˜¾ç¤ºå‡½æ•° */
  89          void Led_Proc()
  90          {
  91   1        ucLed[0] = System_Flag;//å¯åŠ¨åŠŸèƒ½çŸ¥è¯†ç¯
  92   1        ucLed[1] = !Seg_Disp_Mode;//æ¸©åº¦æ˜¾ç¤ºæŒ‡ç¤ºç¯
  93   1        ucLed[2] = Seg_Disp_Mode;//æº¶æ°§åº¦æ˜¾ç¤ºæŒ‡ç¤ºç¯
  94   1        ucLed[3] = Temperature > 26 || Temperature < 20;//æ¸©åº¦æŒ‡ç¤ºç¯
  95   1        ucLed[7] = Start_Flag;//å–‚é£ŸæŒ‡ç¤ºç¯
  96   1        Relay(System_Flag&(Oxygen_Val<3));//ä¾›æ°§æŒ‡ç¤ºå™¨
  97   1      }
  98          
  99          /* ä¸²å£å¤„ç†å‡½æ•° */
 100          void Uart_Proc()
 101          {
 102   1        if(Uart_Slow_Down) return;
 103   1        Uart_Slow_Down = 1;//ä¸²å£å‡é€Ÿç¨‹åº 
 104   1        
 105   1        if(Uart_Recv_Index > 0) //æ¥æ”¶åˆ°æ•°æ®
 106   1        {
 107   2          if(System_Flag == 1) //ç³»ç»Ÿå¤„äºå¯åŠ¨çŠ¶æ€
 108   2          {
 109   3            if(Uart_Recv_Index == 6) //Open\r\n
 110   3            {
 111   4              if(Uart_Recv[0] == 'O' && Uart_Recv[1] == 'p' && Uart_Recv[2] == 'e' && Uart_Recv[3] == 'n' && Uart_Re
             -cv[4] == '\r' && Uart_Recv[5] == '\n') //æ¥å—åˆ°Openå‘½ä»¤
 112   4                Start_Flag = 1;//å¯åŠ¨å–‚é£Ÿ
 113   4            }
C51 COMPILER V9.54   MAIN                                                                  04/06/2023 12:22:09 PAGE 3   

 114   3            else if(Uart_Recv_Index == 1) // 1 æˆ– 2
 115   3            {
 116   4              if(Uart_Recv[0] == '1')
 117   4                sprintf(Uart_Send,"C:%.1f\r\n",Temperature);
 118   4              else if(Uart_Recv[0] == '2')
 119   4                sprintf(Uart_Send,"D:%.2fppm\r\n",Oxygen_Val);
 120   4              Uart_Send_String(Uart_Send);
 121   4            }
 122   3          }
 123   2          Uart_Recv_Index = 0; //ç´¢å¼•å€¼å¤ä½
 124   2        }
 125   1      }
 126          
 127          /* å®šæ—¶å™¨0ä¸­æ–­åˆå§‹åŒ–å‡½æ•° */
 128          void Timer0Init(void)   //1æ¯«ç§’@12.000MHz
 129          {
 130   1        AUXR &= 0x7F;   //å®šæ—¶å™¨æ—¶é’Ÿ12Tæ¨¡å¼
 131   1        TMOD &= 0xF0;   //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 132   1        TL0 = 0x18;   //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 133   1        TH0 = 0xFC;   //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 134   1        TF0 = 0;    //æ¸…é™¤TF0æ ‡å¿—
 135   1        TR0 = 1;    //å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 136   1        ET0 = 1;    //å®šæ—¶å™¨ä¸­æ–­0æ‰“å¼€
 137   1        EA = 1;     //æ€»ä¸­æ–­æ‰“å¼€
 138   1      }
 139          
 140          /* å®šæ—¶å™¨0ä¸­æ–­æœåŠ¡å‡½æ•° */
 141          void Timer0Server() interrupt 1
 142          {  
 143   1        if(++Key_Slow_Down == 10) Key_Slow_Down = 0;//é”®ç›˜å‡é€Ÿä¸“ç”¨
 144   1        if(++Seg_Slow_Down == 500) Seg_Slow_Down = 0;//æ•°ç ç®¡å‡é€Ÿä¸“ç”¨
 145   1        if(++Uart_Slow_Down == 200) Uart_Slow_Down = 0;//ä¸²å£å‡é€Ÿä¸“ç”¨
 146   1        if(++Seg_Pos == 8) Seg_Pos = 0;//æ•°ç ç®¡æ˜¾ç¤ºä¸“ç”¨
 147   1        Seg_Disp(Seg_Pos,System_Flag*Seg_Buf[Seg_Pos]+(!System_Flag)*10,Seg_Point[Seg_Pos]*System_Flag);
 148   1        Led_Disp(Seg_Pos,ucLed[Seg_Pos]*System_Flag);
 149   1        
 150   1        if(Start_Flag == 1) //å¼€å§‹å–‚é£Ÿ
 151   1        {
 152   2          if(++Timer_3000Ms == 3000) //ä¸‰ç§’å
 153   2          {
 154   3            Timer_3000Ms = 0;
 155   3            Start_Flag = 0;//åœæ­¢å–‚é£Ÿ
 156   3            Uart_Send_String("Over!\r\n");//å‘é€ä¸²å£æŒ‡ä»¤
 157   3          }
 158   2        }
 159   1      }
 160          
 161          /* ä¸²å£1ä¸­æ–­æœåŠ¡å‡½æ•° */
 162          void Uart1Server() interrupt 4
 163          {
 164   1        if(RI == 1 && Uart_Recv_Index < 9) //ä¸²å£æ¥æ”¶æ•°æ®
 165   1        {
 166   2          Uart_Recv[Uart_Recv_Index] = SBUF;
 167   2          Uart_Recv_Index++;
 168   2          RI = 0;
 169   2        }
 170   1        
 171   1        //if(Uart_Recv_Index > 7) Uart_Recv_Index = 0;//æ¸…é™¤è¯»å–æŒ‡é’ˆ
 172   1      }
 173          
 174          /* Main */
 175          void main()
C51 COMPILER V9.54   MAIN                                                                  04/06/2023 12:22:09 PAGE 4   

 176          {
 177   1        System_Init();
 178   1        while(rd_temperature() == 85);//é¿å…ä¸Šç”µé”™è¯¯æ•°æ®85.0
 179   1        Temperature = rd_temperature();//é¿å…ä¸Šç”µé”™è¯¯æ•°æ®00.0
 180   1        Timer0Init();
 181   1        UartInit();
 182   1        while (1)
 183   1        {
 184   2          Key_Proc();
 185   2          Seg_Proc();
 186   2          Led_Proc();
 187   2          Uart_Proc();
 188   2        }
 189   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    981    ----
   CONSTANT SIZE    =     29    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     40    ----
   IDATA SIZE       =     24    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
