C51 COMPILER V9.54   MAIN                                                                  01/22/2023 12:36:31 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Driver) DEBUG OBJECTEXTEND PRI
                    -NT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /* å¤´æ–‡ä»¶å£°æ˜åŒº */
   2          #include <STC15F2K60S2.H>//å•ç‰‡æœºå¯„å­˜å™¨ä¸“ç”¨å¤´æ–‡ä»¶
   3          #include <Init.h>//åˆå§‹åŒ–åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   4          #include <Led.h>//Ledåº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   5          #include <Key.h>//æŒ‰é”®åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   6          #include <Seg.h>//æ•°ç ç®¡åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   7          #include "onewire.h"//æ¸©åº¦åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   8          #include "iic.h"//DACåº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   9          
  10          /* å˜é‡å£°æ˜åŒº */
  11          unsigned char Key_Val,Key_Down,Key_Old,Key_Up;//æŒ‰é”®ä¸“ç”¨å˜é‡
  12          unsigned char Key_Slow_Down;//æŒ‰é”®å‡é€Ÿä¸“ç”¨å˜é‡
  13          unsigned char Seg_Buf[8] = {10,10,10,10,10,10,10,10};//æ•°ç ç®¡æ˜¾ç¤ºæ•°æ®å­˜æ”¾æ•°ç»„
  14          unsigned char Seg_Point[8] = {0,0,0,0,0,0,0,0};//æ•°ç ç®¡å°æ•°ç‚¹æ•°æ®å­˜æ”¾æ•°ç»„
  15          unsigned char Seg_Pos;//æ•°ç ç®¡æ‰«æä¸“ç”¨å˜é‡
  16          unsigned int Seg_Slow_Down;//æ•°ç ç®¡å‡é€Ÿä¸“ç”¨å˜é‡
  17          unsigned char ucLed[8] = {0,0,0,0,0,0,0,0};//Ledæ˜¾ç¤ºæ•°æ®å­˜æ”¾æ•°ç»„
  18          unsigned char Seg_Disp_Mode;//æ•°ç ç®¡æ˜¾ç¤ºæ¨¡å¼æ ‡å¿—ä½ 0-æ¸©åº¦æ˜¾ç¤ºç•Œé¢ 1-å‚æ•°è®¾ç½®ç•Œé¢ 2-D
             -ACè¾“å‡ºç•Œé¢
  19          unsigned char Temperature_Params;//æ¸©åº¦å‚æ•°å˜é‡ï¼ˆç”¨äºè®¾ç½®æ˜¾ç¤ºï¼‰
  20          unsigned char Temperature_Params_Ctrol = 25;//æ¸©åº¦å‚æ•°æ§åˆ¶å˜é‡ï¼ˆç”¨äºå®é™…æ§åˆ¶ï¼‰ åˆå§‹å€¼ï¼
             -š25
  21          float Voltage_Output;//å®æ—¶è¾“å‡ºç”µå‹
  22          float Temperature;//å®æ—¶æ¸©åº¦å˜é‡
  23          bit Ouput_Mode;//DACè¾“å‡ºæ¨¡å¼ 0-DACè¾“å‡ºç”µå‹ä¸æ¸©åº¦ç›¸å…³ 1-DACç»™å‡ºçš„å…³ç³»è¾“å‡ºç”µå‹
  24          
  25          /* é”®ç›˜å¤„ç†å‡½æ•° */
  26          void Key_Proc()
  27          {
  28   1        if(Key_Slow_Down) return;
  29   1        Key_Slow_Down = 1;//é”®ç›˜å‡é€Ÿç¨‹åº
  30   1      
  31   1        Key_Val = Key_Read();//å®æ—¶è¯»å–é”®ç å€¼
  32   1        Key_Down = Key_Val & (Key_Old ^ Key_Val);//æ•æ‰æŒ‰é”®ä¸‹é™æ²¿
  33   1        Key_Up = ~Key_Val & (Key_Old ^ Key_Val);//æ•æ‰æŒ‰é”®ä¸Šé™æ²¿
  34   1        Key_Old = Key_Val;//è¾…åŠ©æ‰«æå˜é‡
  35   1        
  36   1        switch(Key_Down)
  37   1        {
  38   2          case 4://ç•Œé¢åˆ‡æ¢æŒ‰é”®
  39   2            if(++Seg_Disp_Mode == 3) 
  40   2              Seg_Disp_Mode = 0;//æ•°ç ç®¡æ˜¾ç¤ºæ¨¡å¼åœ¨0-2ä¹‹é—´å¾ªç¯åˆ‡æ¢
  41   2            if(Seg_Disp_Mode == 1) //å½“å‰å¤„äºæ¸©åº¦å‚æ•°è®¾ç½®ç•Œé¢
  42   2              Temperature_Params = Temperature_Params_Ctrol;//å°†å®é™…æ§åˆ¶æ•°æ®èµ‹å€¼ç»™è®¾ç½®å˜é‡ ä¾¿äºæ•°æ
             -®æ›´æ”¹
  43   2            if(Seg_Disp_Mode == 2) //å½“ç•Œé¢ä»å‚æ•°è®¾ç½®åˆ‡æ¢å‡ºå»å
  44   2              Temperature_Params_Ctrol = Temperature_Params;//å°†è®¾ç½®æ•°æ®ä¿å­˜åˆ°æ§åˆ¶å˜é‡
  45   2          break;
  46   2          case 8://å‚æ•°è‡ªå‡æŒ‰é”®
  47   2            if(Seg_Disp_Mode == 1) //å½“å‰å¤„äºæ¸©åº¦å‚æ•°è®¾ç½®ç•Œé¢
  48   2            {
  49   3              if(--Temperature_Params == 255) //é™åˆ¶æ¸©åº¦ä¸‹é™ä¸º0
  50   3                Temperature_Params = 0;
  51   3            }
C51 COMPILER V9.54   MAIN                                                                  01/22/2023 12:36:31 PAGE 2   

  52   2          break;
  53   2          case 9://å‚æ•°è‡ªåŠ æŒ‰é”®
  54   2            if(Seg_Disp_Mode == 1) //å½“å‰å¤„äºæ¸©åº¦å‚æ•°è®¾ç½®ç•Œé¢
  55   2            {
  56   3              if(++Temperature_Params == 100) //é™åˆ¶æ¸©åº¦ä¸Šé™ä¸º99
  57   3                Temperature_Params = 99;
  58   3            }
  59   2          break;
  60   2          case 5://æ¨¡å¼åˆ‡æ¢æŒ‰é”®
  61   2            Ouput_Mode ^= 1;//åˆ‡æ¢è¾“å‡ºæ¨¡å¼
  62   2          break;
  63   2        }
  64   1      
  65   1      }
  66          
  67          /* ä¿¡æ¯å¤„ç†å‡½æ•° */
  68          void Seg_Proc()
  69          {
  70   1        if(Seg_Slow_Down) return;
  71   1        Seg_Slow_Down = 1;//æ•°ç ç®¡å‡é€Ÿç¨‹åº
  72   1      
  73   1        /* ä¿¡æ¯é‡‡é›†åŒºåŸŸ */
  74   1        Temperature = rd_temperature();//å®æ—¶é‡‡é›†æ¸©åº¦æ•°æ®
  75   1        
  76   1        /* æ•°æ®æ˜¾ç¤ºåŒºåŸŸ */
  77   1        switch(Seg_Disp_Mode)
  78   1        {
  79   2          case 0://æ¸©åº¦æ˜¾ç¤ºç•Œé¢
  80   2            Seg_Buf[0] = 11;//æ ‡è¯†ç¬¦C
  81   2            Seg_Buf[4] = (unsigned char)Temperature / 10 % 10;
  82   2            Seg_Buf[5] = (unsigned char)Temperature % 10;
  83   2            Seg_Buf[6] = (unsigned int)(Temperature * 100) / 10 % 10;
  84   2            Seg_Buf[7] = (unsigned int)(Temperature * 100) % 10;
  85   2            Seg_Point[5] = 1;//ä½¿èƒ½å°æ•°ç‚¹
  86   2          break;
  87   2          case 1://å‚æ•°è®¾ç½®ç•Œé¢
  88   2            Seg_Buf[0] = 12;//æ ‡è¯†ç¬¦P
  89   2            Seg_Buf[4] = Seg_Buf[5] = 10;//ç†„ç­ç¬¬äº”ã€ç¬¬å…­ä¸ªæ•°ç ç®¡
  90   2            Seg_Buf[6] = Temperature_Params / 10 % 10;
  91   2            Seg_Buf[7] = Temperature_Params % 10;
  92   2            Seg_Point[5] = 0;//å…³é—­å°æ•°ç‚¹
  93   2          break;
  94   2          case 2://DACè¾“å‡ºç•Œé¢
  95   2            Seg_Buf[0] = 13;//æ ‡è¯†ç¬¦A
  96   2            Seg_Buf[5] = (unsigned char)Voltage_Output;
  97   2            Seg_Buf[6] = (unsigned int)(Voltage_Output * 100) / 10 % 10;
  98   2            Seg_Buf[7] = (unsigned int)(Voltage_Output * 100) % 10;
  99   2            Seg_Point[5] = 1;//ä½¿èƒ½å°æ•°ç‚¹
 100   2          break;
 101   2        }
 102   1      }
 103          
 104          /* å…¶ä»–æ˜¾ç¤ºå‡½æ•° */
 105          void Led_Proc()
 106          {
 107   1        unsigned char i;//ç”¨äºForå¾ªç¯
 108   1        /* DACç›¸å…³ */
 109   1        if(Ouput_Mode == 0)//DACè¾“å‡ºç”µå‹ä¸æ¸©åº¦ç›¸å…³
 110   1        {
 111   2          if(Temperature > Temperature_Params_Ctrol) //å½“å®æ—¶æ¸©åº¦å¤§äºæ¸©åº¦å‚æ•°æ—¶
 112   2            Voltage_Output = 5;//DACè¾“å‡º5V
 113   2          else//å½“å®æ—¶æ¸©åº¦å°äºå‚æ•°è®¾ç½®æ—¶
C51 COMPILER V9.54   MAIN                                                                  01/22/2023 12:36:31 PAGE 3   

 114   2            Voltage_Output = 0;//DACè¾“å‡º0V
 115   2          //Voltage_Output = (bit)((unsigned char)Temperature / Temperature_Params_Ctrol) * 5;
 116   2        }   
 117   1        else//DACç»™å‡ºçš„å…³ç³»è¾“å‡ºç”µå‹
 118   1        {
 119   2          if(Temperature < 20)//å½“å®æ—¶æ¸©åº¦å°äº20åº¦æ—¶
 120   2            Voltage_Output = 1;//DACè¾“å‡º1V
 121   2          else if(Temperature > 40)//å½“å®æ—¶æ¸©åº¦å°äº40åº¦æ—¶
 122   2            Voltage_Output = 4;//DACè¾“å‡º4V
 123   2          else//å½“å®æ—¶æ¸©åº¦åœ¨20-40ä¹‹é—´æ—¶
 124   2            Voltage_Output = 0.15 * (Temperature - 20) + 1;//DACè¾“å‡ºä¸å®æ—¶æ¸©åº¦ä¸ºä¸€æ¬¡å‡½æ•°å…³ç³»
 125   2        }
 126   1        Da_Write(Voltage_Output * 51);//å®æ—¶è¾“å‡ºDAC
 127   1        
 128   1        /* Ledç›¸å…³ */
 129   1        ucLed[0] = !Ouput_Mode;//å½“å‰å¤„äºæ¨¡å¼ 1 çŠ¶æ€ï¼ŒæŒ‡ç¤ºç¯ L1 ç‚¹äº®ï¼Œå¦åˆ™ç†„ç­
 130   1        for(i=0;i<3;i++)//æ¨¡å¼æŒ‡ç¤ºç¯
 131   1         ucLed[1+i] = (i == Seg_Disp_Mode);
 132   1      }
 133          
 134          /* å®šæ—¶å™¨0ä¸­æ–­åˆå§‹åŒ–å‡½æ•° */
 135          void Timer0Init(void)   //1æ¯«ç§’@12.000MHz
 136          {
 137   1        AUXR &= 0x7F;   //å®šæ—¶å™¨æ—¶é’Ÿ12Tæ¨¡å¼
 138   1        TMOD &= 0xF0;   //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 139   1        TL0 = 0x18;   //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 140   1        TH0 = 0xFC;   //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 141   1        TF0 = 0;    //æ¸…é™¤TF0æ ‡å¿—
 142   1        TR0 = 1;    //å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 143   1        ET0 = 1;    //å®šæ—¶å™¨ä¸­æ–­0æ‰“å¼€
 144   1        EA = 1;     //æ€»ä¸­æ–­æ‰“å¼€
 145   1      }
 146          
 147          /* å®šæ—¶å™¨0ä¸­æ–­æœåŠ¡å‡½æ•° */
 148          void Timer0Server() interrupt 1
 149          {  
 150   1        if(++Key_Slow_Down == 10) Key_Slow_Down = 0;//é”®ç›˜å‡é€Ÿä¸“ç”¨
 151   1        if(++Seg_Slow_Down == 500) Seg_Slow_Down = 0;//æ•°ç ç®¡å‡é€Ÿä¸“ç”¨
 152   1        if(++Seg_Pos == 8) Seg_Pos = 0;//æ•°ç ç®¡æ˜¾ç¤ºä¸“ç”¨
 153   1        Seg_Disp(Seg_Pos,Seg_Buf[Seg_Pos],Seg_Point[Seg_Pos]);
 154   1        Led_Disp(Seg_Pos,ucLed[Seg_Pos]);
 155   1      }
 156          
 157          /* å»¶æ—¶å‡½æ•° */
 158          void Delay750ms()   //@12.000MHz
 159          {
 160   1        unsigned char i, j, k;
 161   1        i = 35;
 162   1        j = 51;
 163   1        k = 182;
 164   1        do
 165   1        {
 166   2          do
 167   2          {
 168   3            while (--k);
 169   3          } while (--j);
 170   2        } while (--i);
 171   1      }
 172          
 173          /* Main */
 174          void main()
 175          {
C51 COMPILER V9.54   MAIN                                                                  01/22/2023 12:36:31 PAGE 4   

 176   1        rd_temperature();//ä¸Šç”µè¯»å–ä¸€æ¬¡æ¸©åº¦å¹¶ä¸”å»¶æ—¶750MSé¿å…æ•°æ®å‡ºç°85
 177   1        Delay750ms();
 178   1        System_Init();
 179   1        Timer0Init();
 180   1        while (1)
 181   1        {
 182   2          Key_Proc();
 183   2          Seg_Proc();
 184   2          Led_Proc();
 185   2        }
 186   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    715    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
