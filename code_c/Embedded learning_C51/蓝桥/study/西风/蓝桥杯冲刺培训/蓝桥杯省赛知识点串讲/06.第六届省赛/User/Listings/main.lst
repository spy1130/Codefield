C51 COMPILER V9.54   MAIN                                                                  02/19/2023 10:32:15 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Driver) DEBUG OBJECTEXTEND PRI
                    -NT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /* å¤´æ–‡ä»¶å£°æ˜åŒº */
   2          #include <STC15F2K60S2.H>//å•ç‰‡æœºå¯„å­˜å™¨ä¸“ç”¨å¤´æ–‡ä»¶
   3          #include <Init.h>//åˆå§‹åŒ–åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   4          #include <Led.h>//Ledåº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   5          #include <Key.h>//æŒ‰é”®åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   6          #include <Seg.h>//æ•°ç ç®¡åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   7          #include "ds1302.h"//æ—¶é’Ÿåº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   8          #include "onewire.h"//æ¸©åº¦åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
   9          
  10          /* å˜é‡å£°æ˜åŒº */
  11          unsigned char Key_Val,Key_Down,Key_Old,Key_Up;//æŒ‰é”®ä¸“ç”¨å˜é‡
  12          unsigned char Key_Slow_Down;//æŒ‰é”®å‡é€Ÿä¸“ç”¨å˜é‡
  13          unsigned char Seg_Buf[8] = {10,10,10,10,10,10,10,10};//æ•°ç ç®¡æ˜¾ç¤ºæ•°æ®å­˜æ”¾æ•°ç»„
  14          unsigned char Seg_Point[8] = {0,0,0,0,0,0,0,0};//æ•°ç ç®¡å°æ•°ç‚¹æ•°æ®å­˜æ”¾æ•°ç»„
  15          unsigned char Seg_Pos;//æ•°ç ç®¡æ‰«æä¸“ç”¨å˜é‡
  16          unsigned int Seg_Slow_Down;//æ•°ç ç®¡å‡é€Ÿä¸“ç”¨å˜é‡
  17          unsigned char ucLed[8] = {0,0,0,0,0,0,0,0};//Ledæ˜¾ç¤ºæ•°æ®å­˜æ”¾æ•°ç»„
  18          unsigned char Seg_Disp_Mode;//æ•°ç ç®¡æ˜¾ç¤ºæ¨¡å¼å˜é‡ 0-å‚æ•°è®¾ç½®ç•Œé¢ 1-æ—¶é’Ÿæ˜¾ç¤ºç•Œé¢ 2-æ¸©å
             -º¦æ˜¾ç¤ºç•Œé¢
  19          unsigned char AcqInvl_Disp = 1;//ç³»ç»Ÿé‡‡é›†é—´éš”å˜é‡(æ˜¾ç¤ºå€¼)
  20          unsigned char AcqInvl_Ctrol = 1;//ç³»ç»Ÿé‡‡é›†é—´éš”å˜é‡(æ§åˆ¶å€¼)
  21          unsigned char Time_Data[4] = {1,5,30,60};//æ—¶é—´å‚æ•°æ•°æ®å‚¨å­˜æ•°ç»„
  22          unsigned char Time_Data_Index;//æ—¶é—´å‚æ•°æ•°ç»„æŒ‡é’ˆ
  23          unsigned char ucRtc[3] = {0x23,0x59,0x50};//æ—¶é’Ÿæ•°æ®å‚¨å­˜æ•°ç»„ ä¸Šç”µé»˜è®¤æ—¶é—´ 23ï¼š59ï¼š50
  24          unsigned char Temperature_Data[10];//æ¸©åº¦æ•°æ®å‚¨å­˜æ•°ç»„
  25          unsigned char Temperature_Data_Index;//æ¸©åº¦æ•°æ®å‚¨å­˜æ•°ç»„æŒ‡é’ˆ
  26          unsigned int Sys_Tick;//ç³»ç»Ÿè®¡æ—¶å˜é‡
  27          unsigned char Sec_Time;//ç³»ç»Ÿç§’æ•°è®¡æ—¶å˜é‡
  28          unsigned int Timer_500Ms;//äº”ç™¾æ¯«ç§’è®¡æ—¶å˜é‡
  29          bit Led_Enable_Flag;//Ledä½¿èƒ½æ ‡å¿—ä½
  30          bit Led_Star_Flag;//Ledé—ªçƒæ ‡å¿—ä½
  31          bit Seg_Star_Flag;//æ•°ç ç®¡é—ªçƒæ ‡å¿—ä½
  32          
  33          /* é”®ç›˜å¤„ç†å‡½æ•° */
  34          void Key_Proc()
  35          {
  36   1        if(Key_Slow_Down) return;
  37   1        Key_Slow_Down = 1;//é”®ç›˜å‡é€Ÿç¨‹åº
  38   1      
  39   1        Key_Val = Key_Read();//å®æ—¶è¯»å–é”®ç å€¼
  40   1        Key_Down = Key_Val & (Key_Old ^ Key_Val);//æ•æ‰æŒ‰é”®ä¸‹é™æ²¿
  41   1        Key_Up = ~Key_Val & (Key_Old ^ Key_Val);//æ•æ‰æŒ‰é”®ä¸Šé™æ²¿
  42   1        Key_Old = Key_Val;//è¾…åŠ©æ‰«æå˜é‡
  43   1      
  44   1        switch(Key_Down)
  45   1        {
  46   2          case 4://å‚æ•°åˆ‡æ¢æŒ‰é”® 
  47   2            if(Seg_Disp_Mode == 0) //å½“å‰å¤„äºå‚æ•°è®¾ç½®ç•Œé¢
  48   2            {
  49   3              if(++Time_Data_Index == 4) //æŒ‡é’ˆå€¼åœ¨0-3ä¹‹é—´å¾ªç¯åˆ‡æ¢ æ‰€å¯¹åº”æ•°ç»„çš„ç¬¬1-4ä¸ªæ•°æ®
  50   3                Time_Data_Index = 0;
  51   3              AcqInvl_Disp = Time_Data[Time_Data_Index];//å°†æ‰€é€‰ä¸­çš„æ•°æ®èµ‹å€¼ç»™æ˜¾ç¤ºå˜é‡
  52   3            }
  53   2          break;
C51 COMPILER V9.54   MAIN                                                                  02/19/2023 10:32:15 PAGE 2   

  54   2          case 5://å‚æ•°ç¡®è®¤æŒ‰é”®
  55   2            if(Seg_Disp_Mode == 0) //å½“å‰å¤„äºå‚æ•°è®¾ç½®ç•Œé¢
  56   2            {
  57   3              AcqInvl_Ctrol = AcqInvl_Disp;//ä¿å­˜è®¾ç½®å‚æ•°
  58   3              Temperature_Data[Temperature_Data_Index] = rd_temperature();//è¯»å–ä¸€æ¬¡å®æ—¶æ¸©åº¦æ•°æ®
  59   3              Temperature_Data_Index++;
  60   3              Seg_Disp_Mode = 1;//åˆ‡æ¢åˆ°æ—¶é’Ÿæ˜¾ç¤ºç•Œé¢
  61   3            }
  62   2          break;
  63   2          case 6://æ•°æ®åˆ‡æ¢æŒ‰é”®
  64   2            if(Seg_Disp_Mode == 2) //å½“å‰å¤„äºæ¸©åº¦æ˜¾ç¤ºç•Œé¢
  65   2            {
  66   3              Led_Enable_Flag = 0;//å…³é—­Ledä½¿èƒ½çŠ¶æ€
  67   3              if(++Temperature_Data_Index == 10) //å¾ªç¯åˆ‡æ¢æ˜¾ç¤ºæ•°æ®
  68   3                Temperature_Data_Index = 0;
  69   3            }
  70   2          break;
  71   2          case 7://å‚æ•°è®¾ç½®æŒ‰é”®
  72   2            if(Seg_Disp_Mode == 2) //å½“å‰å¤„äºæ¸©åº¦æ˜¾ç¤ºç•Œé¢
  73   2            {
  74   3              Temperature_Data_Index = 0;//æŒ‡é’ˆå€¼å¤ä½
  75   3              Seg_Disp_Mode = 0;//åˆ‡æ¢åˆ°å‚æ•°è®¾ç½®ç•Œé¢
  76   3            }
  77   2          break;
  78   2        }
  79   1      }
  80          
  81          /* ä¿¡æ¯å¤„ç†å‡½æ•° */
  82          void Seg_Proc()
  83          {
  84   1        unsigned char i;//Forå¾ªç¯ä¸“ç”¨å˜é‡
  85   1        if(Seg_Slow_Down) return;
  86   1        Seg_Slow_Down = 1;//æ•°ç ç®¡å‡é€Ÿç¨‹åº
  87   1        
  88   1        /* æ•°æ®è¯»å–åŒºåŸŸ */
  89   1        Read_Rtc(ucRtc);//å®æ—¶è¯»å–æ—¶é’Ÿæ•°æ®
  90   1        if(Sec_Time == AcqInvl_Ctrol) //è¾¾åˆ°ä¸€æ¬¡é‡‡é›†é—´éš”
  91   1        {
  92   2          Sec_Time = 0;//è®¡æ—¶å¤ä½ ä¾¿äºä¸‹æ¬¡è¿›å…¥
  93   2          Temperature_Data[Temperature_Data_Index] = rd_temperature();//è¯»å–ä¸€æ¬¡å®æ—¶æ¸©åº¦æ•°æ®
  94   2          if(++Temperature_Data_Index == 10) //ä¸€è½®æ¸©åº¦è¯»å–å®Œæˆ
  95   2          {
  96   3            Temperature_Data_Index = 0;//æŒ‡é’ˆå€¼å¤ä½
  97   3            Led_Enable_Flag = 1;//ä½¿èƒ½Ledé—ªçƒ
  98   3            Seg_Disp_Mode = 2;//è·³è½¬åˆ°æ•°æ®æ˜¾ç¤ºç•Œé¢
  99   3          }
 100   2        }
 101   1        
 102   1        /* ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ */
 103   1        switch(Seg_Disp_Mode)
 104   1        {
 105   2          case 0://å‚æ•°è®¾ç½®ç•Œé¢
 106   2            Seg_Buf[0] = Seg_Buf[1] = Seg_Buf[2] = 10;
 107   2            Seg_Buf[5] = 11;
 108   2            Seg_Buf[6] = AcqInvl_Disp / 10;
 109   2            Seg_Buf[7] = AcqInvl_Disp % 10;
 110   2          break;
 111   2          case 1://æ—¶é’Ÿæ˜¾ç¤ºç•Œé¢
 112   2            for(i=0;i<3;i++)
 113   2            {
 114   3              Seg_Buf[3*i] = ucRtc[i] / 16;
 115   3              Seg_Buf[3*i+1] = ucRtc[i] % 16;
C51 COMPILER V9.54   MAIN                                                                  02/19/2023 10:32:15 PAGE 3   

 116   3            }
 117   2            Seg_Star_Flag = Seg_Buf[7] % 2;//ä½¿ç”¨æ—¶é’ŸèŠ¯ç‰‡è®°å½•é—ªçƒæ—¶é—´
 118   2            Seg_Buf[2] = Seg_Buf[5] = 10 + (unsigned char)Seg_Star_Flag;//10ï¼šç†„ç­ 11ï¼š-
 119   2          break;
 120   2          case 2://æ¸©åº¦æ˜¾ç¤ºç•Œé¢
 121   2            Seg_Buf[0] = 11;
 122   2            Seg_Buf[1] = 0;
 123   2            Seg_Buf[2] = Temperature_Data_Index;
 124   2            Seg_Buf[3] = Seg_Buf[4] = 10;
 125   2            Seg_Buf[5] = 11;
 126   2            Seg_Buf[6] = Temperature_Data[Temperature_Data_Index] / 10;
 127   2            Seg_Buf[7] = Temperature_Data[Temperature_Data_Index] % 10;
 128   2          break; 
 129   2        }
 130   1      }
 131          
 132          /* å…¶ä»–æ˜¾ç¤ºå‡½æ•° */
 133          void Led_Proc()
 134          {
 135   1        ucLed[0] = Led_Enable_Flag & Led_Star_Flag;
 136   1      }
 137          
 138          /* å®šæ—¶å™¨0ä¸­æ–­åˆå§‹åŒ–å‡½æ•° */
 139          void Timer0Init(void)   //1æ¯«ç§’@12.000MHz
 140          {
 141   1        AUXR &= 0x7F;   //å®šæ—¶å™¨æ—¶é’Ÿ12Tæ¨¡å¼
 142   1        TMOD &= 0xF0;   //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 143   1        TL0 = 0x18;   //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 144   1        TH0 = 0xFC;   //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 145   1        TF0 = 0;    //æ¸…é™¤TF0æ ‡å¿—
 146   1        TR0 = 1;    //å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 147   1        ET0 = 1;    //å®šæ—¶å™¨ä¸­æ–­0æ‰“å¼€
 148   1        EA = 1;     //æ€»ä¸­æ–­æ‰“å¼€
 149   1      }
 150          
 151          /* å®šæ—¶å™¨0ä¸­æ–­æœåŠ¡å‡½æ•° */
 152          void Timer0Server() interrupt 1
 153          {  
 154   1        if(++Key_Slow_Down == 10) Key_Slow_Down = 0;//é”®ç›˜å‡é€Ÿä¸“ç”¨
 155   1        if(++Seg_Slow_Down == 500) Seg_Slow_Down = 0;//æ•°ç ç®¡å‡é€Ÿä¸“ç”¨
 156   1        if(++Seg_Pos == 8) Seg_Pos = 0;//æ•°ç ç®¡æ˜¾ç¤ºä¸“ç”¨
 157   1        Seg_Disp(Seg_Pos,Seg_Buf[Seg_Pos],Seg_Point[Seg_Pos]);
 158   1        Led_Disp(Seg_Pos,ucLed[Seg_Pos]);
 159   1        if(Seg_Disp_Mode == 1) //ç³»ç»Ÿå¼€å§‹é‡‡é›†æ¸©åº¦
 160   1        {
 161   2          if(++Sys_Tick == 1000)
 162   2          {
 163   3            Sys_Tick = 0;
 164   3            Sec_Time++;
 165   3          }
 166   2        }
 167   1        
 168   1        if(++Timer_500Ms == 500)
 169   1        {
 170   2          Timer_500Ms = 0;
 171   2          Led_Star_Flag ^= 1;
 172   2        }
 173   1      }
 174          
 175          /* Main */
 176          void main()
 177          {
C51 COMPILER V9.54   MAIN                                                                  02/19/2023 10:32:15 PAGE 4   

 178   1        Set_Rtc(ucRtc);//ä¸Šç”µè®¾ç½®æ—¶é’Ÿæ•°æ®
 179   1        rd_temperature();//ä¸Šç”µè¯»å–ä¸€æ¬¡æ¸©åº¦é¿å…ç¬¬ä¸€æ¬¡æ¸©åº¦æ•°æ®å‡ºç°85
 180   1        System_Init();
 181   1        Timer0Init();
 182   1        while (1)
 183   1        {
 184   2          Key_Proc();
 185   2          Seg_Proc();
 186   2          Led_Proc();
 187   2        }
 188   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    572    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     59    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
