C51 COMPILER V9.52.0.0   __________________________                                        02/15/2019 22:08:39 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE __________________________
OBJECT MODULE PLACED IN 工厂灯光控制系统(存储器版).OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE 工厂灯光控制系统(存储器版).c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "reg52.h"
   2          #include "absacc.h"
   3          
   4          sfr AUXR = 0x8e;              //定义辅助寄存器
   5          
   6          sbit S5 = P3^2;               //定义按键S5引脚
   7          sbit S4 = P3^3;               //定义按键S4引脚
   8          
   9          unsigned char count = 0;      //定义50ms定时中断累计变量
  10          unsigned char t_h = 0;        //定义运行时间的时变量
  11          unsigned char t_m = 0;        //定义运行时间的分变量
  12          unsigned char t_s = 0;        //定义运行时间的秒变量
  13          unsigned char command = 0;    //定义串口命令字接收变量
  14          
  15          unsigned char stat_led = 0xff;    //定义LED灯当前开关状态
  16          
  17          //-----共阳数码管的段码编码表（无小数点）----
  18          unsigned char code SMG_NoDot[18]={0xc0,0xf9,
  19              0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,
  20              0x88,0x80,0xc6,0xc0,0x86,0x8e,0xbf,0x7f};
  21          
  22          /*==================普通的延时函数======================
  23          功能：普通的非精确延时函数。
  24          参数：t--延时长度。
  25          返回：空。
  26          设计：欧浩源（2018年3月11日）
  27          =======================================================*/
  28          void Delay(unsigned int t)
  29          {
  30   1        while(t--);
  31   1        while(t--);
  32   1      }
  33          /*================数码管专用延时函数====================
  34          功能：数码管动态显示专用延时函数。
  35          参数：t--延时长度。
  36          返回：空。
  37          设计：欧浩源（2018年3月11日）
  38          =======================================================*/
  39          void DelaySMG(unsigned int t)
  40          {
  41   1        while(t--);
  42   1      }
  43          /*=================单个数码管显示函数====================
  44          功能：在指定的数码管位置上显示指定的内容。
  45          参数vvalue--数码管显示的内容
  46                pos--数码管位选，即要点亮的数码管位置。
  47          返回：空。
  48          设计：欧浩源（2018年3月11日）
  49          =======================================================*/
  50          void DisplaySMG_Bit(unsigned char value, unsigned char pos)
  51          {
  52   1        XBYTE[0xe000] = 0xff;             //消隐
  53   1        XBYTE[0xc000] = 0x01 << pos;      //数码管的段位     
  54   1        XBYTE[0xe000] = value;            //数码管显示内容
  55   1      }
C51 COMPILER V9.52.0.0   __________________________                                        02/15/2019 22:08:39 PAGE 2   

  56          /*===============系统运行时间显示函数===================
  57          功能：在数码管上显示系统运行的时间。
  58          参数：无。
  59          返回：空。
  60          设计：欧浩源（2018年3月11日）
  61          =======================================================*/
  62          void DisplayTime()
  63          {
  64   1        DisplaySMG_Bit(SMG_NoDot[t_s%10],7);    //秒个位
  65   1        DelaySMG(500);
  66   1        DisplaySMG_Bit(SMG_NoDot[t_s/10],6);    //秒十位
  67   1        DelaySMG(500);
  68   1        DisplaySMG_Bit(SMG_NoDot[16],5);        //分隔符
  69   1        DelaySMG(500);
  70   1        
  71   1        DisplaySMG_Bit(SMG_NoDot[t_m%10],4);    //分个位
  72   1        DelaySMG(500);
  73   1        DisplaySMG_Bit(SMG_NoDot[t_m/10],3);    //分十位
  74   1        DelaySMG(500);
  75   1        DisplaySMG_Bit(SMG_NoDot[16],2);        //分隔符
  76   1        DelaySMG(500);
  77   1        
  78   1        DisplaySMG_Bit(SMG_NoDot[t_h%10],1);    //时个位
  79   1        DelaySMG(500);
  80   1        DisplaySMG_Bit(SMG_NoDot[t_h/10],0);    //时十位
  81   1        DelaySMG(500);
  82   1      }
  83          
  84          /*================定时器T0初始化函数====================
  85          功能：将定时器T0设置为16位模式，计数初值为50ms。
  86          参数：无。
  87          返回：空。
  88          设计：欧浩源（2018年3月11日）
  89          =======================================================*/
  90          void InitTimer0()
  91          {
  92   1        TMOD = 0x21;      //必须注意，T0和T1的工作模式一起赋值
  93   1        TH0 = (65535 - 50000) / 256;
  94   1        TL0 = (65535 - 50000) % 256;
  95   1        ET0 = 1;          //使能定时器T0
  96   1        EA = 1;           //使能总中断
  97   1        TR0 = 1;          //启动定时器T0
  98   1      }
  99          /*===============定时器T0中断服务函数===================
 100          功能：进行系统运行时间的逻辑处理。
 101          参数：无。
 102          返回：空。
 103          设计：欧浩源（2018年3月11日）
 104          =======================================================*/
 105          void ServiceTimer0() interrupt 1
 106          {
 107   1        TH0 = (65535 - 50000) / 256;
 108   1        TL0 = (65535 - 50000) % 256;
 109   1        
 110   1        count++;
 111   1        if(count == 20)
 112   1        {
 113   2          count = 0;
 114   2          t_s++;
 115   2        }
 116   1        if(t_s == 60)
 117   1        {
C51 COMPILER V9.52.0.0   __________________________                                        02/15/2019 22:08:39 PAGE 3   

 118   2          t_s = 0;
 119   2          t_m++;
 120   2          if(t_m == 60)
 121   2          {
 122   3            t_m = 0;
 123   3            t_h++;
 124   3          }
 125   2        }
 126   1      }
 127          /*=================串口初始化函数========================
 128          功能：将串口初始化为模式1，波特率为9600，允许接收。
 129          参数：无。
 130          返回：空。
 131          设计：欧浩源（2018年3月11日）
 132          =======================================================*/
 133          void InitUart()
 134          {
 135   1        TMOD = 0x21;      //必须注意，T0和T1的工作模式一起赋值
 136   1        TH1 = 0xfd;       //设置9600波特率的参数
 137   1        TL1 = 0xfd;
 138   1        TR1 = 1;          //启动定时器T1
 139   1        
 140   1        SCON = 0x50;      //8位UART模式，允许接收
 141   1        AUXR = 0x00;      //辅助寄存器设置（89C82系列不需要）
 142   1        
 143   1        ES = 1;           //使能串口中断
 144   1        EA = 1;           //使能总中断
 145   1      }
 146          /*=================串口中断服务函数====================
 147          功能：接收上位机的数据并保持在command变量中。
 148          参数：无。
 149          返回：空。
 150          设计：欧浩源（2018年3月11日）
 151          =======================================================*/
 152          void ServiceUart() interrupt 4
 153          {
 154   1        if(RI == 1)
 155   1        {
 156   2          command = SBUF;   //将接收到的数据保存到command变量
 157   2          RI = 0;           //将接收完成标志RI清0
 158   2        }
 159   1      }
 160          /*=================串口发送单字节函数====================
 161          功能：串口向上位机发生一个字节。
 162          参数：dat--要发送到内容。
 163          返回：空。
 164          设计：欧浩源（2018年3月11日）
 165          =======================================================*/
 166          void SendByte(unsigned char dat)
 167          {
 168   1        SBUF = dat;
 169   1        while(TI == 0);
 170   1        TI = 0;
 171   1      }
 172          /*===============上位机命令解析执行函数==================
 173          功能：接收上位机的数据并保持在command变量中。
 174          参数：无。
 175          返回：空。
 176          设计：欧浩源（2018年3月11日）
 177          =======================================================*/
 178          void ExecuteCommand()
 179          {
C51 COMPILER V9.52.0.0   __________________________                                        02/15/2019 22:08:39 PAGE 4   

 180   1        if(command != 0x00)             //接收到一个上位机命令
 181   1        {
 182   2          switch(command & 0xf0)        //将命令类型取出来
 183   2          {
 184   3            case 0xa0:                  //远程灯光控制命令
 185   3              stat_led = (stat_led | 0x0f) & (~command | 0xf0);
 186   3              XBYTE[0x8000] = stat_led; //执行现场灯光控制
 187   3              command = 0x00;
 188   3            break;
 189   3            
 190   3            case 0xb0:                  //读取现场系统运行时间命令
 191   3              SendByte((t_h / 10 << 4) | (t_h % 10));
 192   3              SendByte((t_m / 10 << 4) | (t_m % 10));
 193   3              SendByte((t_s / 10 << 4) | (t_s % 10));
 194   3              command = 0x00;
 195   3            break;
 196   3          }
 197   2        }
 198   1      }
 199          /*=================独立按键扫描函数====================
 200          功能：扫描S5和S4按键并执行现场灯光控制。
 201          参数：无。
 202          返回：空。
 203          设计：欧浩源（2018年3月11日）
 204          =======================================================*/
 205          void ScanKeys()
 206          {
 207   1        if(S5 == 0)             //发现按键S5信号
 208   1        {
 209   2          DisplayTime();        //去抖动处理
 210   2          if(S5 == 0)           //确认按键S5信号
 211   2          {
 212   3            while(S5 == 0)      //等待按键S5松开
 213   3            {
 214   4              DisplayTime();
 215   4            }
 216   3            stat_led = (stat_led | 0x40) & (~stat_led | 0xbf); 
 217   3            XBYTE[0x8000] = stat_led;     //执行现场灯光控制
 218   3          }
 219   2        }
 220   1        
 221   1        if(S4 == 0)             //发现按键S4信号
 222   1        {
 223   2          DisplayTime();        //去抖动处理
 224   2          if(S4 == 0)           //确认按键S4信号
 225   2          {
 226   3            while(S4 == 0)      //等待按键S4松开
 227   3            {
 228   4              DisplayTime();
 229   4            }
 230   3            stat_led = (stat_led | 0x80) & (~stat_led | 0x7f); 
 231   3            XBYTE[0x8000] = stat_led;     //执行现场灯光控制
 232   3          }
 233   2        }
 234   1      }
 235          /*=================工厂灯光检测函数====================
 236          功能：逐个检测工厂灯光的工作状态。
 237          参数：无。
 238          返回：空。
 239          设计：欧浩源（2018年3月11日）
 240          =======================================================*/
 241          void CheckLED()
C51 COMPILER V9.52.0.0   __________________________                                        02/15/2019 22:08:39 PAGE 5   

 242          {
 243   1        char i;
 244   1        for(i = 0; i < 9; i++)
 245   1        {
 246   2          stat_led = 0xfe << i;         //逐个点亮LED灯
 247   2          XBYTE[0x8000] = stat_led;
 248   2          Delay(60000);
 249   2        }
 250   1        for(i = 0; i < 9; i++)
 251   1        {
 252   2          stat_led = ~(0xfe << i);      //逐个熄灭LED灯
 253   2          XBYTE[0x8000] = stat_led;
 254   2          Delay(60000);
 255   2        }
 256   1      }
 257          /*================时间显示模块检测函数==================
 258          功能：逐个检测数码管的工作状态。
 259          参数：无。
 260          返回：空。
 261          设计：欧浩源（2018年3月11日）
 262          =======================================================*/
 263          void CheckSMG()
 264          {
 265   1        char i;
 266   1        XBYTE[0xe000] = 0x00;
 267   1        for(i = 0; i < 9; i++)
 268   1        {
 269   2          XBYTE[0xc000] = ~(0xfe << i);   //逐个点亮数码管
 270   2          Delay(60000);
 271   2        }
 272   1        for(i = 0; i < 9; i++)
 273   1        {
 274   2          XBYTE[0xc000] = 0xfe << i;      //逐个熄灭数码管
 275   2          Delay(60000);
 276   2        }
 277   1      }
 278          /*==================系统初始化函数======================
 279          功能：将蜂鸣器和继电器等无关设备关闭。
 280          参数：无。
 281          返回：空。
 282          设计：欧浩源（2018年3月11日）
 283          =======================================================*/
 284          void InitSystem()
 285          {
 286   1        stat_led = 0xff; 
 287   1        XBYTE[0x8000] = stat_led;
 288   1        XBYTE[0xa000] = 0x00;
 289   1        XBYTE[0xc000] = 0x00;
 290   1        XBYTE[0xe000] = 0xff;
 291   1      }
 292          /*======================主函数===========================
 293          功能：整个工厂灯光控制系统的主函数。
 294          参数：无。
 295          返回：空。
 296          设计：欧浩源（2018年3月11日）
 297          =======================================================*/
 298          void main()
 299          {
 300   1        InitSystem();
 301   1        CheckLED();
 302   1        CheckSMG();
 303   1        InitTimer0();
C51 COMPILER V9.52.0.0   __________________________                                        02/15/2019 22:08:39 PAGE 6   

 304   1        InitUart();
 305   1        
 306   1        while(1)
 307   1        {
 308   2          ExecuteCommand();
 309   2          DisplayTime();
 310   2          ScanKeys();
 311   2        }
 312   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    587    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
