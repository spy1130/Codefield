C51 COMPILER V9.52.0.0   _________________IO___                                            02/15/2019 22:07:54 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE _________________IO___
OBJECT MODULE PLACED IN 工厂灯光控制系统(IO版).OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE 工厂灯光控制系统(IO版).c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "reg52.h"
   2          
   3          sfr AUXR = 0x8e;              //定义辅助寄存器
   4          
   5          sbit S5 = P3^2;               //定义按键S5引脚
   6          sbit S4 = P3^3;               //定义按键S4引脚
   7          
   8          unsigned char count = 0;      //定义50ms定时中断累计变量
   9          unsigned char t_h = 0;        //定义运行时间的时变量
  10          unsigned char t_m = 0;        //定义运行时间的分变量
  11          unsigned char t_s = 0;        //定义运行时间的秒变量
  12          unsigned char command = 0;    //定义串口命令字接收变量
  13          
  14          unsigned char stat_led = 0xff;    //定义LED灯当前开关状态
  15          
  16          //-----共阳数码管的段码编码表（无小数点）----
  17          unsigned char code SMG_NoDot[18]={0xc0,0xf9,
  18              0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,
  19              0x88,0x80,0xc6,0xc0,0x86,0x8e,0xbf,0x7f};
  20          
  21          /*==================普通的延时函数======================
  22          功能：普通的非精确延时函数。
  23          参数：t--延时长度。
  24          返回：空。
  25          设计：欧浩源（2018年3月11日）
  26          =======================================================*/
  27          void Delay(unsigned int t)
  28          {
  29   1        while(t--);
  30   1        while(t--);
  31   1      }
  32          /*================数码管专用延时函数====================
  33          功能：数码管动态显示专用延时函数。
  34          参数：t--延时长度。
  35          返回：空。
  36          设计：欧浩源（2018年3月11日）
  37          =======================================================*/
  38          void DelaySMG(unsigned int t)
  39          {
  40   1        while(t--);
  41   1      }
  42          /*=================锁存器选择函数======================
  43          功能：选择要打通的锁存器。
  44          参数：t--延时长度。
  45          返回：空。
  46          设计：欧浩源（2018年3月11日）
  47          =======================================================*/
  48          void SelectHC573(unsigned channel)
  49          {
  50   1        switch(channel)
  51   1        {
  52   2          case 4:
  53   2            P2 = (P2 & 0x1f) | 0x80;    //Y4输出0，选择LED控制
  54   2          break;
  55   2          case 5:
C51 COMPILER V9.52.0.0   _________________IO___                                            02/15/2019 22:07:54 PAGE 2   

  56   2            P2 = (P2 & 0x1f) | 0xa0;    //Y5输出0，选择蜂鸣器和继电器控制
  57   2          break;
  58   2          case 6:
  59   2            P2 = (P2 & 0x1f) | 0xc0;    //Y6输出0，选择数码管位选
  60   2          break;
  61   2          case 7:
  62   2            P2 = (P2 & 0x1f) | 0xe0;    //Y7输出0，选择数码管段码
  63   2          break;
  64   2          case 0:
  65   2            P2 = (P2 & 0x1f) | 0x00;    //所有锁存器不选择
  66   2          break;
  67   2        }
  68   1      }
  69          /*=================单个数码管显示函数====================
  70          功能：在指定的数码管位置上显示指定的内容。
  71          参数vvalue--数码管显示的内容
  72                pos--数码管位选，即要点亮的数码管位置。
  73          返回：空。
  74          设计：欧浩源（2018年3月11日）
  75          =======================================================*/
  76          void DisplaySMG_Bit(unsigned char value, unsigned char pos)
  77          {
  78   1        P0 = 0xff;            //消隐
  79   1        SelectHC573(6);
  80   1        P0 = 0x01 << pos;     //数码管的段位    
  81   1        SelectHC573(7);
  82   1        P0 = value;           //数码管显示内容
  83   1      }
  84          /*===============系统运行时间显示函数===================
  85          功能：在数码管上显示系统运行的时间。
  86          参数：无。
  87          返回：空。
  88          设计：欧浩源（2018年3月11日）
  89          =======================================================*/
  90          void DisplayTime()
  91          {
  92   1        DisplaySMG_Bit(SMG_NoDot[t_s%10],7);    //秒个位
  93   1        DelaySMG(500);
  94   1        DisplaySMG_Bit(SMG_NoDot[t_s/10],6);    //秒十位
  95   1        DelaySMG(500);
  96   1        DisplaySMG_Bit(SMG_NoDot[16],5);        //分隔符
  97   1        DelaySMG(500);
  98   1        
  99   1        DisplaySMG_Bit(SMG_NoDot[t_m%10],4);    //分个位
 100   1        DelaySMG(500);
 101   1        DisplaySMG_Bit(SMG_NoDot[t_m/10],3);    //分十位
 102   1        DelaySMG(500);
 103   1        DisplaySMG_Bit(SMG_NoDot[16],2);        //分隔符
 104   1        DelaySMG(500);
 105   1        
 106   1        DisplaySMG_Bit(SMG_NoDot[t_h%10],1);    //时个位
 107   1        DelaySMG(500);
 108   1        DisplaySMG_Bit(SMG_NoDot[t_h/10],0);    //时十位
 109   1        DelaySMG(500);
 110   1      }
 111          
 112          /*================定时器T0初始化函数====================
 113          功能：将定时器T0设置为16位模式，计数初值为50ms。
 114          参数：无。
 115          返回：空。
 116          设计：欧浩源（2018年3月11日）
 117          =======================================================*/
C51 COMPILER V9.52.0.0   _________________IO___                                            02/15/2019 22:07:54 PAGE 3   

 118          void InitTimer0()
 119          {
 120   1        TMOD = 0x21;      //必须注意，T0和T1的工作模式一起赋值
 121   1        TH0 = (65535 - 50000) / 256;
 122   1        TL0 = (65535 - 50000) % 256;
 123   1        ET0 = 1;          //使能定时器T0
 124   1        EA = 1;           //使能总中断
 125   1        TR0 = 1;          //启动定时器T0
 126   1      }
 127          /*===============定时器T0中断服务函数===================
 128          功能：进行系统运行时间的逻辑处理。
 129          参数：无。
 130          返回：空。
 131          设计：欧浩源（2018年3月11日）
 132          =======================================================*/
 133          void ServiceTimer0() interrupt 1
 134          {
 135   1        TH0 = (65535 - 50000) / 256;
 136   1        TL0 = (65535 - 50000) % 256;
 137   1        
 138   1        count++;
 139   1        if(count == 20)
 140   1        {
 141   2          count = 0;
 142   2          t_s++;
 143   2        }
 144   1        if(t_s == 60)
 145   1        {
 146   2          t_s = 0;
 147   2          t_m++;
 148   2          if(t_m == 60)
 149   2          {
 150   3            t_m = 0;
 151   3            t_h++;
 152   3          }
 153   2        }
 154   1      }
 155          /*=================串口初始化函数========================
 156          功能：将串口初始化为模式1，波特率为9600，允许接收。
 157          参数：无。
 158          返回：空。
 159          设计：欧浩源（2018年3月11日）
 160          =======================================================*/
 161          void InitUart()
 162          {
 163   1        TMOD = 0x21;      //必须注意，T0和T1的工作模式一起赋值
 164   1        TH1 = 0xfd;       //设置9600波特率的参数
 165   1        TL1 = 0xfd;
 166   1        TR1 = 1;          //启动定时器T1
 167   1        
 168   1        SCON = 0x50;      //8位UART模式，允许接收
 169   1        AUXR = 0x00;      //辅助寄存器设置（89C82系列不需要）
 170   1        
 171   1        ES = 1;           //使能串口中断
 172   1        EA = 1;           //使能总中断
 173   1      }
 174          /*=================串口中断服务函数====================
 175          功能：接收上位机的数据并保持在command变量中。
 176          参数：无。
 177          返回：空。
 178          设计：欧浩源（2018年3月11日）
 179          =======================================================*/
C51 COMPILER V9.52.0.0   _________________IO___                                            02/15/2019 22:07:54 PAGE 4   

 180          void ServiceUart() interrupt 4
 181          {
 182   1        if(RI == 1)
 183   1        {
 184   2          command = SBUF;   //将接收到的数据保存到command变量
 185   2          RI = 0;           //将接收完成标志RI清0
 186   2        }
 187   1      }
 188          /*=================串口发送单字节函数====================
 189          功能：串口向上位机发生一个字节。
 190          参数：dat--要发送到内容。
 191          返回：空。
 192          设计：欧浩源（2018年3月11日）
 193          =======================================================*/
 194          void SendByte(unsigned char dat)
 195          {
 196   1        SBUF = dat;
 197   1        while(TI == 0);
 198   1        TI = 0;
 199   1      }
 200          /*===============上位机命令解析执行函数==================
 201          功能：接收上位机的数据并保持在command变量中。
 202          参数：无。
 203          返回：空。
 204          设计：欧浩源（2018年3月11日）
 205          =======================================================*/
 206          void ExecuteCommand()
 207          {
 208   1        if(command != 0x00)             //接收到一个上位机命令
 209   1        {
 210   2          switch(command & 0xf0)        //将命令类型取出来
 211   2          {
 212   3            case 0xa0:                  //远程灯光控制命令
 213   3              SelectHC573(4);
 214   3              stat_led = (stat_led | 0x0f) & (~command | 0xf0);
 215   3              P0 = stat_led;
 216   3              SelectHC573(0);
 217   3              command = 0x00;
 218   3            break;
 219   3            
 220   3            case 0xb0:                  //读取现场系统运行时间命令
 221   3              SendByte((t_h / 10 << 4) | (t_h % 10));
 222   3              SendByte((t_m / 10 << 4) | (t_m % 10));
 223   3              SendByte((t_s / 10 << 4) | (t_s % 10));
 224   3              command = 0x00;
 225   3            break;
 226   3          }
 227   2        }
 228   1      }
 229          /*=================独立按键扫描函数====================
 230          功能：扫描S5和S4按键并执行现场灯光控制。
 231          参数：无。
 232          返回：空。
 233          设计：欧浩源（2018年3月11日）
 234          =======================================================*/
 235          void ScanKeys()
 236          {
 237   1        if(S5 == 0)             //发现按键S5信号
 238   1        {
 239   2          DisplayTime();        //去抖动处理
 240   2          if(S5 == 0)           //确认按键S5信号
 241   2          {
C51 COMPILER V9.52.0.0   _________________IO___                                            02/15/2019 22:07:54 PAGE 5   

 242   3            while(S5 == 0)      //等待按键S5松开
 243   3            {
 244   4              DisplayTime();
 245   4            }
 246   3            SelectHC573(4);
 247   3            stat_led = (stat_led | 0x40) & (~stat_led | 0xbf); 
 248   3            P0 = stat_led;      //执行现场灯光控制
 249   3            SelectHC573(0);
 250   3          }
 251   2        }
 252   1        
 253   1        if(S4 == 0)             //发现按键S4信号
 254   1        {
 255   2          DisplayTime();        //去抖动处理
 256   2          if(S4 == 0)           //确认按键S4信号
 257   2          {
 258   3            while(S4 == 0)      //等待按键S4松开
 259   3            {
 260   4              DisplayTime();
 261   4            }
 262   3            SelectHC573(4);
 263   3            stat_led = (stat_led | 0x80) & (~stat_led | 0x7f); 
 264   3            P0 = stat_led;      //执行现场灯光控制
 265   3            SelectHC573(0);
 266   3          }
 267   2        }
 268   1      }
 269          /*=================工厂灯光检测函数====================
 270          功能：逐个检测工厂灯光的工作状态。
 271          参数：无。
 272          返回：空。
 273          设计：欧浩源（2018年3月11日）
 274          =======================================================*/
 275          void CheckLED()
 276          {
 277   1        char i;
 278   1        SelectHC573(4);
 279   1        for(i = 0; i < 9; i++)
 280   1        {
 281   2          stat_led = 0xfe << i;       //逐个点亮LED灯
 282   2          P0 = stat_led;
 283   2          Delay(60000);
 284   2        }
 285   1        for(i = 0; i < 9; i++)
 286   1        {
 287   2          stat_led = ~(0xfe << i);    //逐个熄灭LED灯
 288   2          P0 = stat_led;
 289   2          Delay(60000);
 290   2        }
 291   1        SelectHC573(0);
 292   1      }
 293          /*================时间显示模块检测函数==================
 294          功能：逐个检测数码管的工作状态。
 295          参数：无。
 296          返回：空。
 297          设计：欧浩源（2018年3月11日）
 298          =======================================================*/
 299          void CheckSMG()
 300          {
 301   1        char i;
 302   1        SelectHC573(7);
 303   1        P0 = 0x00;
C51 COMPILER V9.52.0.0   _________________IO___                                            02/15/2019 22:07:54 PAGE 6   

 304   1        for(i = 0; i < 9; i++)
 305   1        {
 306   2          SelectHC573(6);
 307   2          P0 = ~(0xfe << i);      //逐个点亮数码管  
 308   2          Delay(60000);
 309   2        }
 310   1        for(i = 0; i < 9; i++)
 311   1        {
 312   2          SelectHC573(6);
 313   2          P0 = 0xfe << i;         //逐个熄灭数码管
 314   2          Delay(60000);
 315   2        }
 316   1        SelectHC573(0);
 317   1      }
 318          /*==================系统初始化函数======================
 319          功能：将蜂鸣器和继电器等无关设备关闭。
 320          参数：无。
 321          返回：空。
 322          设计：欧浩源（2018年3月11日）
 323          =======================================================*/
 324          void InitSystem()
 325          {
 326   1        SelectHC573(5);
 327   1        P0 = 0x00;
 328   1        SelectHC573(4);
 329   1        P0 = stat_led;
 330   1        SelectHC573(0);
 331   1      }
 332          /*======================主函数===========================
 333          功能：整个工厂灯光控制系统的主函数。
 334          参数：无。
 335          返回：空。
 336          设计：欧浩源（2018年3月11日）
 337          =======================================================*/
 338          void main()
 339          {
 340   1        InitSystem();
 341   1        CheckLED();
 342   1        CheckSMG();
 343   1        InitTimer0();
 344   1        InitUart();
 345   1        
 346   1        while(1)
 347   1        {
 348   2          ExecuteCommand();
 349   2          DisplayTime();
 350   2          ScanKeys();
 351   2        }
 352   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    690    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
