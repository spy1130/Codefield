C51 COMPILER V9.52.0.0   ________________                                                  03/11/2018 19:22:49 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE ________________
OBJECT MODULE PLACED IN 工厂灯光控制系统.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE 工厂灯光控制系统.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "reg52.h"
   2          
   3          sfr AUXR = 0x8e;              //定义辅助寄存器
   4          
   5          sbit S5 = P3^2;               //定义按键S5引脚
   6          sbit S4 = P3^3;               //定义按键S4引脚
   7          
   8          unsigned char count = 0;      //定义50ms定时中断累计变量
   9          unsigned char t_h = 0;        //定义运行时间的时变量
  10          unsigned char t_m = 0;        //定义运行时间的分变量
  11          unsigned char t_s = 0;        //定义运行时间的秒变量
  12          unsigned char command = 0;    //定义串口命令字接收变量
  13          
  14          unsigned char stat_led = 0xff;    //定义LED灯当前开关状态
  15          
  16          //-----共阳数码管的段码编码表（无小数点）----
  17          unsigned char code SMG_NoDot[18]={0xc0,0xf9,
  18              0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,
  19              0x88,0x80,0xc6,0xc0,0x86,0x8e,0xbf,0x7f};
  20          
  21          /*==================普通的延时函数======================
  22          功能：普通的非精确延时函数。
  23          参数：t--延时长度。
  24          返回：空。
  25          设计：欧浩源（2018年3月11日）
  26          =======================================================*/
  27          void Delay(unsigned int t)
  28          {
  29   1        while(t--);
  30   1        while(t--);
  31   1      }
  32          /*================数码管专用延时函数====================
  33          功能：数码管动态显示专用延时函数。
  34          参数：t--延时长度。
  35          返回：空。
  36          设计：欧浩源（2018年3月11日）
  37          =======================================================*/
  38          void DelaySMG(unsigned int t)
  39          {
  40   1        while(t--);
  41   1      }
  42          /*=================锁存器选择函数======================
  43          功能：选择要打通的锁存器。
  44          参数：t--延时长度。
  45          返回：空。
  46          设计：欧浩源（2018年3月11日）
  47          =======================================================*/
  48          void SelectHC573(unsigned channel)
  49          {
  50   1        switch(channel)
  51   1        {
  52   2          case 4:
  53   2            P2 = (P2 & 0x1f) | 0x80;    //Y4输出0，选择LED控制
  54   2          break;
  55   2          case 5:
C51 COMPILER V9.52.0.0   ________________                                                  03/11/2018 19:22:49 PAGE 2   

  56   2            P2 = (P2 & 0x1f) | 0xa0;    //Y5输出0，选择蜂鸣器和继电器控制
  57   2          break;
  58   2          case 6:
  59   2            P2 = (P2 & 0x1f) | 0xc0;    //Y6输出0，选择数码管位选
  60   2          break;
  61   2          case 7:
  62   2            P2 = (P2 & 0x1f) | 0xe0;    //Y7输出0，选择数码管段码
  63   2          break;
  64   2          case 0:
  65   2            P2 = (P2 & 0x1f) | 0x00;    //所有锁存器不选择
  66   2          break;
  67   2        }
  68   1      }
  69          /*=================单个数码管显示函数====================
  70          功能：在指定的数码管位置上显示指定的内容。
  71          参数vvalue--数码管显示的内容
  72                pos--数码管位选，即要点亮的数码管位置。
  73          返回：空。
  74          设计：欧浩源（2018年3月11日）
  75          =======================================================*/
  76          void DisplaySMG_Bit(unsigned char value, unsigned char pos)
  77          {
  78   1        SelectHC573(6);
  79   1        P0 = 0x01 << pos;     //数码管的段位    
  80   1        SelectHC573(7);
  81   1        P0 = value;           //数码管显示内容
  82   1      }
  83          /*===============系统运行时间显示函数===================
  84          功能：在数码管上显示系统运行的时间。
  85          参数：无。
  86          返回：空。
  87          设计：欧浩源（2018年3月11日）
  88          =======================================================*/
  89          void DisplayTime()
  90          {
  91   1        DisplaySMG_Bit(SMG_NoDot[t_s%10],7);    //秒个位
  92   1        DelaySMG(500);
  93   1        DisplaySMG_Bit(SMG_NoDot[t_s/10],6);    //秒十位
  94   1        DelaySMG(500);
  95   1        DisplaySMG_Bit(SMG_NoDot[16],5);        //分隔符
  96   1        DelaySMG(500);
  97   1        
  98   1        DisplaySMG_Bit(SMG_NoDot[t_m%10],4);    //分个位
  99   1        DelaySMG(500);
 100   1        DisplaySMG_Bit(SMG_NoDot[t_m/10],3);    //分十位
 101   1        DelaySMG(500);
 102   1        DisplaySMG_Bit(SMG_NoDot[16],2);        //分隔符
 103   1        DelaySMG(500);
 104   1        
 105   1        DisplaySMG_Bit(SMG_NoDot[t_h%10],1);    //时个位
 106   1        DelaySMG(500);
 107   1        DisplaySMG_Bit(SMG_NoDot[t_h/10],0);    //时十位
 108   1        DelaySMG(500);
 109   1      }
 110          
 111          /*================定时器T0初始化函数====================
 112          功能：将定时器T0设置为16位模式，计数初值为50ms。
 113          参数：无。
 114          返回：空。
 115          设计：欧浩源（2018年3月11日）
 116          =======================================================*/
 117          void InitTimer0()
C51 COMPILER V9.52.0.0   ________________                                                  03/11/2018 19:22:49 PAGE 3   

 118          {
 119   1        TMOD = 0x21;      //必须注意，T0和T1的工作模式一起赋值
 120   1        TH0 = (65535 - 50000) / 256;
 121   1        TL0 = (65535 - 50000) % 256;
 122   1        ET0 = 1;          //使能定时器T0
 123   1        EA = 1;           //使能总中断
 124   1        TR0 = 1;          //启动定时器T0
 125   1      }
 126          /*===============定时器T0中断服务函数===================
 127          功能：进行系统运行时间的逻辑处理。
 128          参数：无。
 129          返回：空。
 130          设计：欧浩源（2018年3月11日）
 131          =======================================================*/
 132          void ServiceTimer0() interrupt 1
 133          {
 134   1        TH0 = (65535 - 50000) / 256;
 135   1        TL0 = (65535 - 50000) % 256;
 136   1        
 137   1        count++;
 138   1        if(count == 20)
 139   1        {
 140   2          count = 0;
 141   2          t_s++;
 142   2        }
 143   1        if(t_s == 60)
 144   1        {
 145   2          t_s = 0;
 146   2          t_m++;
 147   2          if(t_m == 60)
 148   2          {
 149   3            t_m = 0;
 150   3            t_h++;
 151   3          }
 152   2        }
 153   1      }
 154          /*=================串口初始化函数========================
 155          功能：将串口初始化为模式1，波特率为9600，允许接收。
 156          参数：无。
 157          返回：空。
 158          设计：欧浩源（2018年3月11日）
 159          =======================================================*/
 160          void InitUart()
 161          {
 162   1        TMOD = 0x21;      //必须注意，T0和T1的工作模式一起赋值
 163   1        TH1 = 0xfd;       //设置9600波特率的参数
 164   1        TL1 = 0xfd;
 165   1        TR1 = 1;          //启动定时器T1
 166   1        
 167   1        SCON = 0x50;      //8位UART模式，允许接收
 168   1        AUXR = 0x00;      //辅助寄存器设置（89C82系列不需要）
 169   1        
 170   1        ES = 1;           //使能串口中断
 171   1        EA = 1;           //使能总中断
 172   1      }
 173          /*=================串口中断服务函数====================
 174          功能：接收上位机的数据并保持在command变量中。
 175          参数：无。
 176          返回：空。
 177          设计：欧浩源（2018年3月11日）
 178          =======================================================*/
 179          void ServiceUart() interrupt 4
C51 COMPILER V9.52.0.0   ________________                                                  03/11/2018 19:22:49 PAGE 4   

 180          {
 181   1        if(RI == 1)
 182   1        {
 183   2          command = SBUF;   //将接收到的数据保存到command变量
 184   2          RI = 0;           //将接收完成标志RI清0
 185   2        }
 186   1      }
 187          /*=================串口发送单字节函数====================
 188          功能：串口向上位机发生一个字节。
 189          参数：dat--要发送到内容。
 190          返回：空。
 191          设计：欧浩源（2018年3月11日）
 192          =======================================================*/
 193          void SendByte(unsigned char dat)
 194          {
 195   1        SBUF = dat;
 196   1        while(TI == 0);
 197   1        TI = 0;
 198   1      }
 199          /*===============上位机命令解析执行函数==================
 200          功能：接收上位机的数据并保持在command变量中。
 201          参数：无。
 202          返回：空。
 203          设计：欧浩源（2018年3月11日）
 204          =======================================================*/
 205          void ExecuteCommand()
 206          {
 207   1        if(command != 0x00)             //接收到一个上位机命令
 208   1        {
 209   2          switch(command & 0xf0)        //将命令类型取出来
 210   2          {
 211   3            case 0xa0:                  //远程灯光控制命令
 212   3              SelectHC573(4);
 213   3              stat_led = (stat_led | 0x0f) & (~command | 0xf0);
 214   3              P0 = stat_led;
 215   3              SelectHC573(0);
 216   3              command = 0x00;
 217   3            break;
 218   3            
 219   3            case 0xb0:                  //读取现场系统运行时间命令
 220   3              SendByte((t_h / 10 << 4) | (t_h % 10));
 221   3              SendByte((t_m / 10 << 4) | (t_m % 10));
 222   3              SendByte((t_s / 10 << 4) | (t_s % 10));
 223   3              command = 0x00;
 224   3            break;
 225   3          }
 226   2        }
 227   1      }
 228          /*=================独立按键扫描函数====================
 229          功能：扫描S5和S4按键并执行现场灯光控制。
 230          参数：无。
 231          返回：空。
 232          设计：欧浩源（2018年3月11日）
 233          =======================================================*/
 234          void ScanKeys()
 235          {
 236   1        if(S5 == 0)             //发现按键S5信号
 237   1        {
 238   2          DisplayTime();        //去抖动处理
 239   2          if(S5 == 0)           //确认按键S5信号
 240   2          {
 241   3            while(S5 == 0)      //等待按键S5松开
C51 COMPILER V9.52.0.0   ________________                                                  03/11/2018 19:22:49 PAGE 5   

 242   3            {
 243   4              DisplayTime();
 244   4            }
 245   3            SelectHC573(4);
 246   3            stat_led = (stat_led | 0x40) & (~stat_led | 0xbf); 
 247   3            P0 = stat_led;      //执行现场灯光控制
 248   3            SelectHC573(0);
 249   3          }
 250   2        }
 251   1        
 252   1        if(S4 == 0)             //发现按键S4信号
 253   1        {
 254   2          DisplayTime();        //去抖动处理
 255   2          if(S4 == 0)           //确认按键S4信号
 256   2          {
 257   3            while(S4 == 0)      //等待按键S4松开
 258   3            {
 259   4              DisplayTime();
 260   4            }
 261   3            SelectHC573(4);
 262   3            stat_led = (stat_led | 0x80) & (~stat_led | 0x7f); 
 263   3            P0 = stat_led;      //执行现场灯光控制
 264   3            SelectHC573(0);
 265   3          }
 266   2        }
 267   1      }
 268          /*=================工厂灯光检测函数====================
 269          功能：逐个检测工厂灯光的工作状态。
 270          参数：无。
 271          返回：空。
 272          设计：欧浩源（2018年3月11日）
 273          =======================================================*/
 274          void CheckLED()
 275          {
 276   1        char i;
 277   1        SelectHC573(4);
 278   1        for(i = 0; i < 9; i++)
 279   1        {
 280   2          stat_led = ~(0x01 << i);
 281   2          P0 = stat_led;
 282   2          Delay(60000);
 283   2        }
 284   1        SelectHC573(0);
 285   1      }
 286          /*================时间显示模块检测函数==================
 287          功能：逐个检测数码管的工作状态。
 288          参数：无。
 289          返回：空。
 290          设计：欧浩源（2018年3月11日）
 291          =======================================================*/
 292          void CheckSMG()
 293          {
 294   1        char i;
 295   1        for(i = 0; i < 9; i++)
 296   1        {
 297   2          SelectHC573(6);
 298   2          P0 = 0x01 << i;
 299   2          SelectHC573(7);
 300   2          P0 = 0x00;
 301   2          Delay(60000);
 302   2        }
 303   1        SelectHC573(0);
C51 COMPILER V9.52.0.0   ________________                                                  03/11/2018 19:22:49 PAGE 6   

 304   1      }
 305          /*==================系统初始化函数======================
 306          功能：将蜂鸣器和继电器等无关设备关闭。
 307          参数：无。
 308          返回：空。
 309          设计：欧浩源（2018年3月11日）
 310          =======================================================*/
 311          void InitSystem()
 312          {
 313   1        SelectHC573(5);
 314   1        P0 = 0x00;
 315   1        SelectHC573(4);
 316   1        P0 = stat_led;
 317   1        SelectHC573(0);
 318   1      }
 319          /*======================主函数===========================
 320          功能：整个工厂灯光控制系统的主函数。
 321          参数：无。
 322          返回：空。
 323          设计：欧浩源（2018年3月11日）
 324          =======================================================*/
 325          void main()
 326          {
 327   1        InitSystem();
 328   1        CheckLED();
 329   1        CheckSMG();
 330   1        InitTimer0();
 331   1        InitUart();
 332   1        
 333   1        while(1)
 334   1        {
 335   2          ExecuteCommand();
 336   2          DisplayTime();
 337   2          ScanKeys();
 338   2        }
 339   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    640    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
