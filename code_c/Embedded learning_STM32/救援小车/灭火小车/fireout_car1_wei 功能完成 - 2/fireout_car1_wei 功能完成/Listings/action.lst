C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE ACTION
OBJECT MODULE PLACED IN .\Objects\action.obj
COMPILER INVOKED BY: E:\Applications\Keil_5\C51\BIN\C51.EXE action.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.
                    -\Listings\action.lst) OBJECT(.\Objects\action.obj)

line level    source

   1          #include "action.h"
   2          
   3          volatile unsigned int last_dis = 0;
   4          volatile unsigned int left_dis = 0;
   5          volatile unsigned int right_dis = 0;
   6          volatile unsigned int front_dis = 0;
   7          volatile unsigned int speed_right = 0;
   8          volatile unsigned int speed_left = 0;
   9          
  10          float xdata time_i = 0;
  11          float xdata error=0x00;
  12          float xdata error_i=0x00;
  13          float xdata sum_err=0x00;
  14          float xdata error_dis=0x00;
  15          float xdata error_dir=0x00;
  16          
  17          float xdata kp_dis=5.2; 
  18          float xdata kp_dir=5.0;
  19          
  20          float xdata kp_dis_big=2.5; //2.3 -- 2.5 -- 2.3
  21          float xdata ki_dis_big=2.3; //2.0 -- 2.3 -- 2.5
  22          float xdata kp_dir_big=8.0; //7.0 -- 8.0 -- 7.0
  23          
  24          float xdata kp_dis_mid=2.0;//3.0*1.5;2.7-2.4
  25          float xdata kp_dir_mid=30.7;//1.5*1.5;   34-30还不错
  26          
  27          float xdata kp_dis_samll=1.9;//1.9;//2.2有点猛;//1.8*1.5;1.5-1.2-1.0
  28          float xdata kp_dir_small=40.0;//1.9;//2.2有点猛;//1.8*1.5;1.5-1.2-1.0
  29          
  30          
  31          typedef struct Kalm_parameter
  32          {
  33                  float p_mid;
  34                  float p_last;
  35                  float p_now;
  36                  float Q;
  37                  float kg;
  38                  float R;
  39                  float Sm;
  40                  float x_last;
  41                  float x_mid;
  42          }
  43          Kalm_par;
  44          
  45          Kalm_par kalm_front = {0.0, 0.0, 0.0, 0.018, 0.0, 0.0542, 0.0, 0.0, 0.0};
  46          Kalm_par xdata kalm_left = {0.0, 0.0, 0.0, 0.001, 0.0, 0.012, 0.0, 0.0, 0.0};
  47          Kalm_par xdata kalm_right = {0.0, 0.0, 0.0, 0.001, 0.0, 0.012, 0.0, 0.0, 0.0};
  48          
  49          int kalmanfilter(int z_measure, int position)//卡尔曼滤波
  50          {
  51   1              switch(position)
  52   1              {
  53   2                      case 1:
  54   2                              kalm_front.x_mid = kalm_front.x_last;
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 2   

  55   2                              kalm_front.p_mid = kalm_front.p_last + kalm_front.Q;
  56   2                              kalm_front.kg = kalm_front.p_mid + kalm_front.Q;
  57   2                              kalm_front.Sm = (int)kalm_front.x_mid + kalm_front.kg * (z_measure - kalm_front.x_mid);
  58   2                              kalm_front.p_now = (1-kalm_front.kg) * kalm_front.p_mid;
  59   2                              kalm_front.p_last = kalm_front.p_now;
  60   2                              kalm_front.x_last = kalm_front.Sm;
  61   2                              break;
  62   2                      case 2:
  63   2                              kalm_left.x_mid = kalm_left.x_last;
  64   2                              kalm_left.p_mid = kalm_left.p_last + kalm_left.Q;
  65   2                              kalm_left.kg = kalm_left.p_mid + kalm_left.Q;
  66   2                              kalm_left.Sm = (int)kalm_left.x_mid + kalm_left.kg * (z_measure - kalm_left.x_mid);
  67   2                              kalm_left.p_now = (1-kalm_left.kg) * kalm_left.p_mid;
  68   2                              kalm_left.p_last = kalm_left.p_now;
  69   2                              kalm_left.x_last = kalm_left.Sm;
  70   2                              break;
  71   2                      case 3:
  72   2                              kalm_right.x_mid = kalm_right.x_last;
  73   2                              kalm_right.p_mid = kalm_right.p_last + kalm_right.Q;
  74   2                              kalm_right.kg = kalm_right.p_mid + kalm_right.Q;
  75   2                              kalm_right.Sm = (int)kalm_right.x_mid + kalm_right.kg * (z_measure - kalm_right.x_mid);
  76   2                              kalm_right.p_now = (1-kalm_right.kg) * kalm_right.p_mid;
  77   2                              kalm_right.p_last = kalm_right.p_now;
  78   2                              kalm_right.x_last = kalm_right.Sm;
  79   2                              break;
  80   2                      default:
  81   2                              break;
  82   2              }
  83   1              if(1 == position) 
  84   1                      return kalm_front.x_last;
  85   1              else if(2 == position) 
  86   1                      return kalm_left.x_last;
  87   1              else if(3 == position) 
  88   1                      return kalm_right.x_last;
  89   1              
  90   1              return 0;
  91   1      }
  92          
  93          
  94          void adjustDirection_1(unsigned int LeftSpeed,unsigned int RightSpeed)
  95          {
  96   1              Right_H_Speed = (int)(RightSpeed * 0.89);
  97   1        Right_L_Speed = 18330 - Right_H_Speed;
  98   1              
  99   1              Left_H_Speed = (int)(LeftSpeed * 0.89);
 100   1              Left_L_Speed = 18330 - Left_H_Speed;
 101   1      }
 102          void Circulation_wall_right()
 103          {
 104   1               last_dis=right_dis;
 105   1               front_dis= kalmanfilter(Ultrasonic_Get_Front(),1);
 106   1               right_dis = Ultrasonic_Get_Right();
 107   1               //left_dis = Ultrasonic_Get_Left();
 108   1              
 109   1      //       front_dis= Ultrasonic_Get_Front();
 110   1      //       right_dis= Ultrasonic_Get_Right();
 111   1      //       left_dis= Ultrasonic_Get_Left();
 112   1              
 113   1               if(right_dis > 320)//右边不靠墙时扫描左边与墙的距离
 114   1               {
 115   2                       speed_right=1300;
 116   2                       speed_left=1700;
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 3   

 117   2                       adjustDirection_1(speed_left,speed_right);
 118   2               }
 119   1      //--------------大于170--------------10        
 120   1               else if(right_dis >170)//turn right
 121   1               {
 122   2                       error_dis=(right_dis-170)*kp_dis;// kp_dis=5.0
 123   2      /////////////////////////////大于220-------------------------------
 124   2      //小车离中心线大于50mm，有位置环pid，有方向环pid
 125   2      /////////////////////////                                
 126   2                       if(right_dis-170>50)
 127   2                       {
 128   3                               kp_dis=kp_dis_samll;//kp_dis_samll=1.9
 129   3                               kp_dir=kp_dir_small;//kp_dir_small=40.0
 130   3      //------------------------------------------------------------------                     
 131   3                               error_dis=(right_dis-170)*kp_dis;//-------------10.2
 132   3                               error_dir=(last_dis-right_dis)*kp_dir; 
 133   3      //                       speed_right=1300+error_dis;
 134   3                               if((last_dis-right_dis)>0)
 135   3                                       {
 136   4                                               //现朝右墙远离中心，要使靠近中心线
 137   4                                                speed_right=1300+error_dis-error_dir;
 138   4                                                if(speed_right>=1500)
 139   4                                                       {
 140   5                                                               speed_right=1450;
 141   5                                                       }
 142   4                                               speed_left=1700;
 143   4                                               adjustDirection_1(1700,(int)speed_right);
 144   4                                       }
 145   3                                       else
 146   3                                       {
 147   4                                               //现朝左远离中心线，使靠近中心线
 148   4                                               speed_right=1300+error_dis-error_dir;
 149   4                                               if(speed_right>=1500)
 150   4                                               {
 151   5                                                       speed_right=1450;
 152   5                                               }
 153   4                                               speed_left=1700;
 154   4                                               adjustDirection_1(1700,(int)speed_right);
 155   4                                       }
 156   3                       }
 157   2                       else
 158   2                       {
 159   3      /////////////////////////////
 160   3      //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
 161   3      /////////////////////////                        
 162   3                               error_dis=(right_dis-170)*kp_dis;
 163   3                               
 164   3                               if(right_dis-170>30)
 165   3                               {
 166   4                                         kp_dis=kp_dis_mid;//kp_dis_mid=2.0
 167   4                                         kp_dir=kp_dir_mid;//kp_dir_mid=30.7
 168   4                                        
 169   4                                        error_dis=(right_dis-170)*kp_dis;
 170   4                                        error_dir=(last_dis-right_dis)*kp_dir;
 171   4                                       
 172   4                                       if((last_dis-right_dis)>0)
 173   4                                       {
 174   5                                               //靠近中心线
 175   5                                               if(error_dir>=0.9*error_dis)
 176   5                                               {
 177   6                                                       error_dir=0.9*error_dis;
 178   6                                               }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 4   

 179   5                                                speed_right=1300+error_dis-error_dir;
 180   5                                                if(speed_right>=1500)
 181   5                                               {
 182   6                                                       speed_right=1450;
 183   6                                               }
 184   5                                               speed_left=1700;
 185   5                                               adjustDirection_1(1700,(int)speed_right);
 186   5                                       }
 187   4                                       else
 188   4                                       {
 189   5                                               //远离中心线
 190   5                                               speed_right=1300+error_dis-error_dir;
 191   5                                               if(speed_right>=1500)
 192   5                                               {
 193   6                                                       speed_right=1450;
 194   6                                               }
 195   5                                               speed_left=1700;
 196   5                                               adjustDirection_1(1700,(int)speed_right);
 197   5                                       }
 198   4                               }
 199   3      ////////////////////////////
 200   3      //小车离中心线小于30mm，大于10mm，有位置环pid，有方向环pid
 201   3      /////////////////////////       
 202   3                               else
 203   3                               {
 204   4                                      kp_dis=kp_dis_big;//kp_dis_big=2.3
 205   4                                      kp_dir=kp_dir_big;//kp_dir_big=7.0
 206   4                                      error_dis=(right_dis-170)*kp_dis;
 207   4                                      error_dir=(last_dis-right_dis)*kp_dir;
 208   4                                      error=(right_dis-170);
 209   4                                      if(15>=error&&time_i<=5)                                 
 210   4                                      {
 211   5                                              if(time_i<4)
 212   5                                                       sum_err=sum_err+error*0.3;
 213   5                                              else
 214   5                                                       sum_err=(sum_err+error)*0.7;
 215   5                                              
 216   5                                              error_i=sum_err*ki_dis_big;//ki_dis_big=2.0
 217   5                                                      
 218   5                                              time_i++;
 219   5                                      }
 220   4                                      else if (15<error||time_i>5)
 221   4                                      {
 222   5                                              sum_err=0;
 223   5                                              error_i=0;                                        
 224   5                                              time_i=0;
 225   5                                      }
 226   4                                      if((last_dis-right_dis)>0)//朝右(鼓励适当右)
 227   4                                      {
 228   5                                              //右转是大环境，这里离目标线很近，需要调整车头方向为左拐，防止超调 
 229   5                                              speed_left=1700+error_dis-error_dir*0.3+error_i;
 230   5                                              if(speed_left<=1500)
 231   5                                              {
 232   6                                                       speed_left=1550;
 233   6                                              }
 234   5                                                speed_right=1300;
 235   5                                               adjustDirection_1((int)speed_left,1300);
 236   5                                       }
 237   4                                       else if((last_dis-right_dis)<0)//朝左 error_dir<0
 238   4                                       {
 239   5                                               //远离中心线
 240   5                                               speed_right=1300+error_dis-error_dir+error_i;
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 5   

 241   5                                               if(speed_right>=1500)
 242   5                                               {
 243   6                                                       speed_right=1450;
 244   6                                               }
 245   5                                                speed_left=1700;
 246   5                                               adjustDirection_1(1700,(int)speed_right);                                      
 247   5                                       }
 248   4                                       else //正向
 249   4                                       {
 250   5                                              //远离中心线
 251   5                                              speed_right=1300+error_dis+error_i;
 252   5                                              if(speed_right>=1500)
 253   5                                              {
 254   6                                                      speed_right=1450;
 255   6                                              }
 256   5                                               speed_left=1700;
 257   5                                              adjustDirection_1(1700,(int)speed_right);                                       
 258   5                                       }
 259   4                               }
 260   3                       }
 261   2               }
 262   1      /////////////////////////////
 263   1      //-------------小车离墙距离小于170mm
 264   1      /////////////////////////        
 265   1               else if(right_dis <170)//turn left
 266   1               {
 267   2                      error_dis=(170-right_dis)*kp_dis;
 268   2                      if(170-right_dis>50)
 269   2                      {
 270   3      /////////////////////////////
 271   3      //小车离中心线大于50mm，只有位置环pid，没有方向环pid
 272   3      /////////////////////////                
 273   3                              kp_dis=kp_dis_samll;
 274   3                              kp_dir=kp_dir_small;
 275   3                               error_dis=(170-right_dis)*kp_dis;
 276   3                              error_dir=(last_dis-right_dis)*kp_dir;
 277   3                              if((last_dis-right_dis)>0)
 278   3                              {
 279   4                                      //远近中心线
 280   4                                      kp_dis=kp_dis_big;
 281   4                                      kp_dir=kp_dir_big;
 282   4                                      speed_left=1700-error_dis-error_dir;
 283   4                                      if(speed_left<=1500)
 284   4                                      {
 285   5                                              speed_left=1550;
 286   5                                      }
 287   4                                      speed_right=1300;
 288   4                                      adjustDirection_1((int)speed_left,1300);
 289   4                              }
 290   3                              else
 291   3                              {
 292   4                                      //靠近中心线
 293   4                                      if(-(error_dir)>=0.9*error_dis)
 294   4                                      {
 295   5                                              error_dir=-0.9*error_dis;
 296   5                                      }
 297   4                                      speed_left=1700-error_dis-error_dir;
 298   4                                      if(speed_left<=1500)
 299   4                                      {
 300   5                                              speed_left=1550;
 301   5                                      }
 302   4                                      speed_right=1300;
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 6   

 303   4                                      adjustDirection_1((int)speed_left,1300);
 304   4                              }
 305   3                      }
 306   2                      else
 307   2                      {
 308   3      /////////////////////////////
 309   3      //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
 310   3      /////////////////////////                                
 311   3                              if(170-right_dis>30)
 312   3                              {
 313   4                                      kp_dis=kp_dis_mid;
 314   4                                      kp_dir=kp_dir_mid;
 315   4                                      error_dis=(170-right_dis)*kp_dis;
 316   4                                      error_dir=(last_dis-right_dis)*kp_dir;
 317   4                                      if((last_dis-right_dis)>0)
 318   4                                      {
 319   5                                              //远近中心线
 320   5                                              kp_dis=kp_dis_big;
 321   5                                              kp_dir=kp_dir_big;
 322   5                                              speed_left=1700-error_dis-error_dir;
 323   5                                              if(speed_left<=1500)
 324   5                                              {
 325   6                                                      speed_left=1550;
 326   6                                              }
 327   5                                              speed_right=1300;
 328   5                                              adjustDirection_1((int)speed_left,1300);
 329   5                                      }
 330   4                                      else
 331   4                                      {
 332   5                                              //靠近中心线
 333   5                                              if(-(error_dir)>=0.9*error_dis)
 334   5                                              {
 335   6                                                      error_dir=-0.9*error_dis;
 336   6                                              }
 337   5                                              speed_left=1700-error_dis-error_dir;
 338   5                                              if(speed_left<=1500)
 339   5                                              {
 340   6                                                      speed_left=1550;
 341   6                                              }
 342   5                                              speed_right=1300;
 343   5                                              adjustDirection_1((int)speed_left,1300);
 344   5                                      }
 345   4                              }
 346   3       /////////////////////////////
 347   3      //小车离中心线小于30mm，大于10mm，有位置环pid，有方向环pid
 348   3      /////////////////////////
 349   3                              else
 350   3                              {
 351   4                                      kp_dis=kp_dis_big;
 352   4                                      kp_dir=kp_dir_big;
 353   4                                      error_dis=(170-right_dis)*kp_dis;
 354   4                                      error_dir=(last_dis-right_dis)*kp_dir;
 355   4                                      error=(170-right_dis);                           
 356   4                                      if(15>=error&&time_i<=5)                                 
 357   4                                      {
 358   5                                              if(time_i<3)
 359   5                                                       sum_err=sum_err+error*0.3;
 360   5                                              else
 361   5                                                       sum_err=(sum_err+error)*0.6;
 362   5                                              error_i=sum_err*ki_dis_big;                                              
 363   5                                              time_i++;
 364   5                                      }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 7   

 365   4                                      else if (15<error||time_i>5)
 366   4                                      {
 367   5                                      sum_err=0;
 368   5                                      error_i=0;                                        
 369   5                                      time_i=0;
 370   5                                      }
 371   4                                      if((last_dis-right_dis)>0)//朝右
 372   4                                      {
 373   5                                              //远近中心线
 374   5                                              
 375   5                                              kp_dis=kp_dis_big;
 376   5                                              kp_dir=kp_dir_big;
 377   5                                               speed_left=1700-error_dis-error_dir-error_i;
 378   5                                              if(speed_left<=1500)
 379   5                                              {
 380   6                                                       speed_left=1550;
 381   6                                              }
 382   5                                               speed_right=1300;
 383   5                                              adjustDirection_1((int)speed_left,1300);
 384   5                                      }
 385   4                                      else if((last_dis-right_dis)<0)//朝左(适当鼓励)
 386   4                                      {
 387   5                                              //靠近中心线
 388   5                                              //左转是大环境，这里离目标线很近，需要调整车头方向为右拐，防止超调
 389   5                                              speed_right=1300-error_dis-error_dir*0.3-error_i;
 390   5                                              if(speed_right>=1500)
 391   5                                              {
 392   6                                                      speed_right=1450;
 393   6                                              }
 394   5                                              speed_left=1700;
 395   5                                              adjustDirection_1(1700,(int)speed_right);
 396   5                                      }
 397   4                                      else //正向
 398   4                                      {
 399   5                                              //让朝右
 400   5                                                       
 401   5                                              speed_left=1700-error_dis-error_i;
 402   5                                              if(speed_left<=1500)
 403   5                                              {
 404   6                                                       speed_left=1550;
 405   6                                              }
 406   5                                               speed_right=1300;
 407   5                                              adjustDirection_1((int)speed_left,1300);                                        
 408   5                                      }
 409   4                              }
 410   3                       }
 411   2               }
 412   1               else if(right_dis ==170)
 413   1               {
 414   2                       adjustDirection_1(1700,1300);                   
 415   2               }
 416   1      }
 417          
 418          
 419          /*
 420          void Circulation_wall_left(void)
 421          {       
 422                   last_dis=left_dis;
 423                   front_dis= kalmanfilter(Ultrasonic_Get_Front(),1);
 424                   right_dis= Ultrasonic_Get_Right();
 425                   left_dis= Ultrasonic_Get_Left();
 426          //       front_dis= Ultrasonic_Get_Front();
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 8   

 427          //       left_dis= Ultrasonic_Get_Left();
 428          //       right_dis= Ultrasonic_Get_Right();
 429                  
 430                  
 431                  if(left_dis > 320)//右边不靠墙时扫描左边与墙的距离
 432                   {               
 433                           speed_right=1300;
 434                           speed_left=1700;
 435                           adjustDirection_1(speed_left,speed_right);     
 436                   }
 437                   
 438          /////////////////////////////
 439          //--------------------小车离墙距离小于172mm
 440          /////////////////////////       
 441                   else if(left_dis <=170)//turn right
 442                   {
 443                           error_dis=(170-left_dis)*kp_dis;
 444          /////////////////////////////
 445          //小车离中心线大于50mm，只有位置环pid，没有方向环pid
 446          /////////////////////////                        
 447                           if(170-left_dis>50)
 448                           {
 449                                   kp_dis=kp_dis_samll;
 450                                   kp_dir=kp_dir_small;
 451                                   error_dir=0.0;
 452                                   error_dis=(170-left_dis)*kp_dis;
 453                                   speed_right=1300+error_dis;
 454                                    if(speed_right>=1500)
 455                                   {
 456                                           speed_right=1450;
 457                                   }
 458                              speed_left=1700;
 459                                    adjustDirection_1(speed_left,(int)speed_right);
 460                           }
 461                           else
 462                           {
 463          /////////////////////////////
 464          //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
 465          /////////////////////////       
 466                                   if(170-left_dis>30)
 467                                   {
 468                                           kp_dis=kp_dis_mid;
 469                                           kp_dir=kp_dir_mid;
 470                                           error_dis=(170-left_dis)*kp_dis;
 471                                           error_dir=(last_dis-left_dis)*kp_dir;
 472                                           if((last_dis-left_dis)>0)//--------------朝左
 473                                           {
 474                                                   //远离中心线
 475                                                  speed_right=1300+error_dis+error_dir;
 476                                                    if(speed_right>=1500)
 477                                                   {
 478                                                           speed_right=1450;
 479                                                            
 480                                                   }
 481                                                   speed_left=1700;
 482                                                   adjustDirection_1(speed_left,(int)speed_right);
 483                                           }
 484                                           else                  //--------------朝右
 485                                           {
 486                                                   //靠近中心线
 487                                                    if(-(error_dir)>=0.9*error_dis)
 488                                                   {
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 9   

 489                                                           error_dir=-0.9*error_dis;
 490                                                   }
 491                                                    speed_right=1300+error_dis+error_dir;
 492                                                    if(speed_right>=1500)
 493                                                   {
 494                                                           speed_right=1450;
 495                                                          
 496                                                   }
 497                                                   speed_left=1700;
 498                                                   adjustDirection_1(speed_left,(int)speed_right);
 499                                           }
 500                                   }
 501                                   else
 502                                   {
 503          /////////////////////////////
 504          //小车离中心线小于30mm，有位置环pid，有方向环pid
 505          /////////////////////////                                        
 506                                           
 507                                                    kp_dis=kp_dis_big;
 508                                                    kp_dir=kp_dir_big;
 509                                                    error_dis=(170-left_dis)*kp_dis;
 510                                                    error_dir=(last_dis-left_dis)*kp_dir;
 511                                                   if((last_dis-left_dis)>0)  //--------------朝左
 512                                                   {
 513                                                           //远离中心线
 514                                                            speed_right=1300+error_dis+error_dir;
 515                                                            if(speed_right>=1500)
 516                                                            {
 517                                                                   speed_right=1450;
 518                                                            }
 519                                                            speed_left=1700;
 520                                                            adjustDirection_1(speed_left,(int)speed_right);
 521                                                   }
 522                                                   else if((last_dis-left_dis)<0)      //--------------朝右适当鼓励dir-
 523                                                   {
 524                                                           //靠近中心线
 525                                                           //转中的转
 526                                                            //右转是大环境，这里离目标线很近，需要调整车头左拐，防止超调
 527                                                          speed_left=1700+error_dis+error_dir*0.5;  //---适当鼓励朝右
 528                                                          if(speed_left<=1500)
 529                                                                  
 530                                                          {
 531                                                                  speed_left=1550;
 532                                                          }
 533                                                          speed_right=1300;
 534                                                          adjustDirection_1((int)speed_left,speed_right);
 535                                                   }
 536                                              else //正向
 537                                                   {
 538                                                           //远离中心线
 539                                                                   
 540                                                           speed_right=1300+error_dis;
 541                                                           if(speed_right>=1500)
 542                                                           {
 543                                                                   speed_right=1450;
 544                                                           }
 545                                                           speed_left=1700;
 546                                                           adjustDirection_1(speed_left,(int)speed_right);                                        
 547                                                   }
 548                                   }
 549                           }
 550                   }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 10  

 551          /////////////////////////////
 552          //小车离墙距离大于172mm
 553          /////////////////////////        
 554                   else//turn left
 555                   {
 556                           error_dis=(left_dis-170)*kp_dis;
 557          /////////////////////////////
 558          //小车离中心线大于50mm，只有位置环pid，没有方向环pid
 559          /////////////////////////                
 560                           if(left_dis-170>50)
 561                           {
 562                                   kp_dis=kp_dis_samll;
 563                                   kp_dir=kp_dir_small;
 564                                   error_dis=(left_dis-170)*kp_dis;
 565                                   error_dir=0.0;
 566                                   speed_left=1700-error_dis;
 567                                   if(speed_left<=1500)
 568                                   {
 569                                           speed_left=1550;
 570                                   }
 571                                    speed_right=1300;
 572                                   adjustDirection_1((int)speed_left,speed_right);
 573                           }
 574                           else
 575                           {
 576          /////////////////////////////
 577          //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
 578          /////////////////////////                       
 579                                   if(left_dis-170>30)
 580                                   {
 581                                             kp_dis=kp_dis_mid;
 582                                             kp_dir=kp_dir_mid;
 583                                           error_dis=(left_dis-170)*kp_dis;
 584                                           error_dir=(last_dis-left_dis)*kp_dir;
 585                                           
 586                                           if((last_dis-left_dis)>0)//---------朝左
 587                                           {
 588                                                   //靠近中心线
 589                                                    if(error_dir>=0.9*error_dis)
 590                                                   {
 591                                                           error_dir=0.9*error_dis;
 592                                                   }
 593                                                   speed_left=1700-error_dis+error_dir;
 594                                                    if(speed_left<=1500)
 595                                                   {
 596                                                           speed_left=1550;
 597                                                   }
 598                                                    speed_right=1300;
 599                                                   adjustDirection_1((int)speed_left,speed_right);
 600                                           }
 601                                           else       //---------朝右
 602                                           {
 603                                                   //远近中心线
 604                                                  speed_left=1700-error_dis+error_dir*0.8;
 605                                                    if(speed_left<=1500)
 606                                                   {
 607                                                           speed_left=1550;
 608                                                   }
 609                                                    speed_right=1300;
 610                                                   adjustDirection_1((int)speed_left,speed_right);
 611                                           }
 612                                   }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 11  

 613                                   else
 614                                   {
 615                                           kp_dis=kp_dis_big;
 616                                            kp_dir=kp_dir_big;
 617                                           error_dis=(left_dis-170)*kp_dis;
 618          /////////////////////////////
 619          //小车离中心线小于30mm，--10mm，有位置环pid，有方向环pid
 620          /////////////////////////
 621                                          
 622                                                  error_dir=(last_dis-left_dis)*kp_dir;
 623                                                   if((last_dis-left_dis)>0)//---------朝左适当鼓励
 624                                                   {
 625                                                           //靠近中心线
 626                                                           //左转是大环境，这里离目标线很近，需要调整车头右拐，防止超调
 627                                                           speed_right=1300-error_dis+error_dir*0.6;
 628                                                            if(speed_right>=1500)
 629                                                           {
 630                                                                   speed_right=1450;
 631                                                           }
 632                                                            speed_left=1700;
 633                                                           adjustDirection_1(speed_left,(int)speed_right);
 634                                                   }
 635                                          else if((last_dis-left_dis)<0) //---------朝右
 636                                                   {
 637                                                           //远近中心线
 638                                                          speed_left=1700-error_dis+error_dir*0.9;
 639                                                            if(speed_left<=1500)
 640                                                           {
 641                                                                   speed_left=1550;
 642                                                           }
 643                                                            speed_right=1300;
 644                                                           adjustDirection_1((int)speed_left,speed_right);
 645                                                   }
 646                                          
 647                                           else //正向
 648                                                   {
 649                                                           //远离中心线
 650                                                                   
 651                                                           speed_left=1700-error_dis;
 652                                                           if(speed_left<=1500)
 653                                                           {
 654                                                                   speed_left=1550;
 655                                                           }
 656                                                            speed_right=1300;
 657                                                           adjustDirection_1((int)speed_left,speed_right);                                
 658                                                   }
 659                                   }      
 660                           }
 661                   }
 662          }
 663          */
 664          void tingche()
 665          {
 666   1              adjustDirection_1(1500,1500);
 667   1      }
 668          void car_stop()
 669          {
 670   1                Left_H_Speed = 1335;
 671   1          Left_L_Speed = 18330 - 1335;
 672   1          Right_H_Speed = 1335;
 673   1          Right_L_Speed = 18330 - 1335;
 674   1      }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 12  

 675          void delay_ms2(unsigned int z)    
 676          {
 677   1               unsigned int i,j;
 678   1               for(j = z;j > 0; j--)
 679   1               for(i = 112;i > 0; i--);
 680   1                      tingche();
 681   1                      tingche();
 682   1                      tingche();
 683   1              tingche();
 684   1              tingche();
 685   1      }
 686          void forward()
 687          {
 688   1              adjustDirection_1(1590,1415);//原1700，1300
 689   1      }
 690          void turn_left_90()
 691          {
 692   1              adjustDirection_1(1350,1350);
 693   1              delay_ms(460);//延时500ms即可 ——原数据360改为540——5.18，400-5.19，420-5.20
 694   1      }
 695          
 696          
 697          void turn_left_90_big31()   //
 698          {
 699   1              adjustDirection_1(1350,1350);
 700   1              delay_ms(450);//延时500ms即可 ——原数据360改为540——5.18，400-5.19，420-5.20
 701   1      }
 702          
 703          
 704          //4.06单独测火返回时太小
 705          void turn_left_90_big_32()
 706          {
 707   1              adjustDirection_1(1350,1350);
 708   1              delay_ms(500);//延时500ms即可 ——原数据360改为540——5.18，400-5.19，420-5.20     450 小
             -一点
 709   1      }
 710          
 711          void turn_right_90()
 712          {
 713   1              adjustDirection_1(1650,1650);
 714   1              delay_ms(470);//延时500ms即可 ——原数据360改为540——5.18，400-5.19，420-5.20 460-10.21
 715   1      }
 716          
 717          void turn_right_90_small()
 718          {
 719   1              adjustDirection_1(1650,1650);
 720   1              delay_ms(380);//延时500ms即可 ——原数据360改为540——5.18，400-5.19，420-5.20
 721   1      }
 722          
 723          void turn_right_back_90()//回家转90；
 724          {
 725   1              adjustDirection_1(1650,1650);
 726   1              delay_ms(480);
 727   1      }
 728          
 729          void turn_right_180()
 730          {
 731   1              adjustDirection_1(1650,1650); //之前是1650 和 1650   
 732   1              delay_ms(900);//延时500ms即可 ——原数据950，改为延迟1080-5.17，1060-5.18，840-5.20，880
             --5.26      840不行   500不行    300不行   延时1000角度开始接近    1140不行  980 1050不行  860  880  95
             -0   1020  1065  1085 1150
 733   1      }//1130  1110  1120  1140  1010   1200 
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 13  

 734          //890   920  950   870  840   760  740  720  710有用  730稍微小点   740改赛道稍小  750还是同
             -样问题  765
 735          void turn_left_90_big()
 736          {
 737   1              adjustDirection_1(1350,1350);
 738   1              delay_ms(500);//延时500ms即可 ——原数据400改为600——5.18，500-5.19，480-5.20
 739   1      }
 740          
 741          void Circulation_wall_left(void)
 742          {       
 743   1               last_dis=left_dis;
 744   1               front_dis= kalmanfilter(Ultrasonic_Get_Front(),1);
 745   1               //right_dis = Ultrasonic_Get_Right();
 746   1               left_dis = Ultrasonic_Get_Left();
 747   1              
 748   1              
 749   1              if(left_dis > 320)//右边不靠墙时扫描左边与墙的距离
 750   1               {
 751   2                       left_dis = Ultrasonic_Get_Left();
 752   2      //                forwardOneStep();
 753   2      //                forwardOneStep();
 754   2      //                forwardOneStep();
 755   2      //                forwardOneStep();
 756   2      //                forwardOneStep(); 
 757   2                       
 758   2                       
 759   2                       
 760   2                       speed_right=1300;
 761   2                       speed_left=1700;
 762   2                       adjustDirection_1(speed_left,speed_right);
 763   2      //               sprintf(buf1,"直行");
 764   2      //              
 765   2      //              speak_len1=strlen(( const char *)buf1);
 766   2      //              speak_context((u8*)buf1,speak_len1);    
 767   2               }
 768   1      /////////////////////////////
 769   1      //--------------------小车离墙距离小于172mm
 770   1      /////////////////////////       
 771   1                else if(left_dis <=170)//turn right
 772   1               {
 773   2                       error_dis=(170-left_dis)*kp_dis;
 774   2      /////////////////////////////
 775   2      //小车离中心线大于50mm，只有位置环pid，没有方向环pid
 776   2      /////////////////////////                        
 777   2                       if(170-left_dis>50)
 778   2                       {
 779   3                               kp_dis=kp_dis_samll;
 780   3                               kp_dir=kp_dir_small;
 781   3                               error_dir=0.0;
 782   3                                error_dis=(170-left_dis)*kp_dis;
 783   3                               speed_right=1300+error_dis;
 784   3                                if(speed_right>=1500)
 785   3                                       {
 786   4                                               speed_right=1450;
 787   4                                              
 788   4                                       }
 789   3                          speed_left=1700;
 790   3                              adjustDirection_1(speed_left,(int)speed_right);
 791   3      //                      sprintf(buf1,"右转");
 792   3      //                      speak_len1=strlen(( const char *)buf1);
 793   3      //                      speak_context((u8*)buf1,speak_len1);    
 794   3                               
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 14  

 795   3                       }
 796   2                       else
 797   2                       {
 798   3      /////////////////////////////
 799   3      //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
 800   3      /////////////////////////       
 801   3                               if(170-left_dis>30)
 802   3                               {
 803   4                                       kp_dis=kp_dis_mid;
 804   4                                       kp_dir=kp_dir_mid;
 805   4                                        error_dis=(170-left_dis)*kp_dis;
 806   4                                       error_dir=(last_dis-left_dis)*kp_dir;
 807   4                                       if((last_dis-left_dis)>0)//--------------朝左
 808   4                                       {
 809   5                                               //远离中心线
 810   5                                              speed_right=1300+error_dis+error_dir;
 811   5                                                if(speed_right>=1500)
 812   5                                               {
 813   6                                                       speed_right=1450;
 814   6                                                        
 815   6                                               }
 816   5                                               speed_left=1700;
 817   5                                               adjustDirection_1(1700,(int)speed_right);
 818   5                                       }
 819   4                                       else                  //--------------朝右
 820   4                                       {
 821   5                                               //靠近中心线
 822   5                                                if(-(error_dir)>=0.9*error_dis)
 823   5                                               {
 824   6                                                       error_dir=-0.9*error_dis;
 825   6                                               }
 826   5      
 827   5                                                speed_right=1300+error_dis+error_dir;
 828   5                                                if(speed_right>=1500)
 829   5                                               {
 830   6                                                       speed_right=1450;
 831   6                                                      
 832   6                                               }
 833   5                                                 speed_left=1700;
 834   5                                               adjustDirection_1(speed_left,(int)speed_right);
 835   5                                       }
 836   4      //                               sprintf(buf1,"右转");
 837   4      //                              speak_len1=strlen(( const char *)buf1);
 838   4      //                              speak_context((u8*)buf1,speak_len1);    
 839   4                               }
 840   3                               else
 841   3                               {
 842   4      /////////////////////////////
 843   4      //小车离中心线小于30mm，有位置环pid，有方向环pid
 844   4      /////////////////////////                                        
 845   4                                       
 846   4                                                kp_dis=kp_dis_big;
 847   4                                                kp_dir=kp_dir_big;
 848   4                                                error_dis=(170-left_dis)*kp_dis;
 849   4                                                error_dir=(last_dis-left_dis)*kp_dir;
 850   4                                               if((last_dis-left_dis)>0)  //--------------朝左
 851   4                                               {
 852   5                                                       //远离中心线
 853   5                                                      speed_right=1300+error_dis+error_dir;
 854   5                                                        if(speed_right>=1500)
 855   5                                                       {
 856   6                                                               speed_right=1450;
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 15  

 857   6                                                       }
 858   5                                                        speed_left=1700;
 859   5                                                       adjustDirection_1(1700,(int)speed_right);
 860   5      //                                                sprintf(buf1,"右转");
 861   5      //                                              speak_len1=strlen(( const char *)buf1);
 862   5      //                                              speak_context((u8*)buf1,speak_len1);    
 863   5                                               }
 864   4                                               else if((last_dis-left_dis)<0)      //--------------朝右适当鼓励dir-
 865   4                                               {
 866   5                                                       //靠近中心线
 867   5              //                                        if(-(error_dir)>=0.9*error_dis)
 868   5              //                                       {
 869   5              //                                               error_dir=-0.9*error_dis;
 870   5              //                                       }
 871   5              //                                        speed_right=1300+error_dis+error_dir;
 872   5              //                                        if(speed_right>=1500)
 873   5              //                                       {
 874   5              //                                               speed_right=1450;
 875   5              //                                       }
 876   5              //                                       adjustDirection_1(1700,(int)speed_right);
 877   5                                                       //转中的转
 878   5                                                        //右转是大环境，这里离目标线很近，需要调整车头左拐，防止超调
 879   5                                                       
 880   5                                                      speed_left=1700+error_dis+error_dir*0.6;  //---适当鼓励朝右
 881   5                                                        if(speed_left<=1500)
 882   5                                                       {
 883   6                                                               speed_left=1550;
 884   6                                                       }
 885   5                                                       speed_right=1300;
 886   5                                                       adjustDirection_1((int)speed_left,1300);
 887   5                                               
 888   5                                                       
 889   5                                               }
 890   4                                       else //正向
 891   4                                               {
 892   5                                                       //远离中心线
 893   5                                                               
 894   5                                                       speed_right=1300+error_dis;
 895   5                                                       if(speed_right>=1500)
 896   5                                                       {
 897   6                                                               speed_right=1450;
 898   6                                                       }
 899   5                                                        speed_left=1700;
 900   5                                                       adjustDirection_1(1700,(int)speed_right);                                      
 901   5                                               }
 902   4                                       
 903   4                                      
 904   4                               }
 905   3                              
 906   3                                       
 907   3                       }
 908   2                       
 909   2      //               sprintf(buf1,"F=%d,L=%d,s_l=1700,s_r=%d\n",front_dis,left_dis,(int)speed_right);
 910   2      //              speak_len1=strlen(( const char *)buf1);
 911   2      //              for( s_i = 0 ; s_i < speak_len1; s_i++) 
 912   2      //              {
 913   2      //      //              while((USART3->SR&0X40)==0);  
 914   2      //      //              USART3->DR = DataScope_OutPut_Buffer2[s_i]; 
 915   2      //                      while((USART1->SR&0X40)==0);  
 916   2      //                      USART1->DR = buf1[s_i];                                                                              
             -                                                                                                                        
             -                                                                                                                        
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 16  

             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                          
 917   2      //              }
 918   2      
 919   2                              
 920   2               }
 921   1      /////////////////////////////
 922   1      //小车离墙距离大于172mm
 923   1      /////////////////////////        
 924   1               else//turn left
 925   1               {
 926   2                       error_dis=(left_dis-170)*kp_dis;
 927   2      /////////////////////////////
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 17  

 928   2      //小车离中心线大于50mm，只有位置环pid，没有方向环pid
 929   2      /////////////////////////                
 930   2                       if(left_dis-170>50)
 931   2                       {
 932   3                               kp_dis=kp_dis_samll;
 933   3                               kp_dir=kp_dir_small;
 934   3                               error_dis=(left_dis-170)*kp_dis;
 935   3                               error_dir=0.0;
 936   3                               speed_left=1700-error_dis;
 937   3                               if(speed_left<=1500)
 938   3                               {
 939   4                                       speed_left=1550;
 940   4                               }
 941   3                                speed_right=1300;
 942   3                               adjustDirection_1((int)speed_left,1300);
 943   3                               
 944   3      //                       sprintf(buf1,"左转");
 945   3      //                      speak_len1=strlen(( const char *)buf1);
 946   3      //                      speak_context((u8*)buf1,speak_len1);
 947   3                               
 948   3                       }
 949   2                       else
 950   2                       {
 951   3      /////////////////////////////
 952   3      //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
 953   3      /////////////////////////                       
 954   3                               if(left_dis-170>30)
 955   3                               {
 956   4                                         kp_dis=kp_dis_mid;
 957   4                                         kp_dir=kp_dir_mid;
 958   4                                       error_dis=(left_dis-170)*kp_dis;
 959   4                                       error_dir=(last_dis-left_dis)*kp_dir;
 960   4                                       
 961   4                                       if((last_dis-left_dis)>0)//---------朝左
 962   4                                       {
 963   5                                               //靠近中心线
 964   5                                                if(error_dir>=0.9*error_dis)
 965   5                                               {
 966   6                                                       error_dir=0.9*error_dis;
 967   6                                               }
 968   5                                               speed_left=1700-error_dis+error_dir;
 969   5                                                if(speed_left<=1500)
 970   5                                               {
 971   6                                                       speed_left=1550;
 972   6                                               }
 973   5                                                speed_right=1300;
 974   5                                               adjustDirection_1((int)speed_left,1300);
 975   5      
 976   5                                                
 977   5                                       }
 978   4                                       else       //---------朝右
 979   4                                       {
 980   5                                               //远近中心线
 981   5                                              speed_left=1700-error_dis+error_dir*0.8;
 982   5                                                if(speed_left<=1500)
 983   5                                               {
 984   6                                                       speed_left=1550;
 985   6                                               }
 986   5                                                speed_right=1300;
 987   5                                               adjustDirection_1((int)speed_left,1300);
 988   5                                       }
 989   4      //                               sprintf(buf1,"左转");
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 18  

 990   4      //                              speak_len1=strlen(( const char *)buf1);
 991   4      //                              speak_context((u8*)buf1,speak_len1);
 992   4                               }
 993   3                               else
 994   3                               {
 995   4              
 996   4                                       
 997   4                                       kp_dis=kp_dis_big;
 998   4                                        kp_dir=kp_dir_big;
 999   4                                       error_dis=(left_dis-170)*kp_dis;
1000   4      /////////////////////////////
1001   4      //小车离中心线小于30mm，--10mm，有位置环pid，有方向环pid
1002   4      /////////////////////////
1003   4                                      
1004   4                                              error_dir=(last_dis-left_dis)*kp_dir;
1005   4                                               if((last_dis-left_dis)>0)//---------朝左适当鼓励
1006   4                                               {
1007   5                                                       //靠近中心线
1008   5                                                       
1009   5              
1010   5                                                       //左转是大环境，这里离目标线很近，需要调整车头右拐，防止超调
1011   5                                                       speed_right=1300-error_dis+error_dir*0.6;
1012   5                                                        if(speed_right>=1500)
1013   5                                                       {
1014   6                                                               speed_right=1450;
1015   6                                                       }
1016   5                                                        speed_left=1700;
1017   5                                                       adjustDirection_1(1700,(int)speed_right);
1018   5                                                       
1019   5      //                                               sprintf(buf1,"右转");
1020   5      //                                              speak_len1=strlen(( const char *)buf1);
1021   5      //                                              speak_context((u8*)buf1,speak_len1);
1022   5      
1023   5                                                        
1024   5                                               }
1025   4                                      else if((last_dis-left_dis)<0) //---------朝右
1026   4                                               {
1027   5                                                       //远近中心线
1028   5                                                      speed_left=1700-error_dis+error_dir*0.9;
1029   5                                                        if(speed_left<=1500)
1030   5                                                       {
1031   6                                                               speed_left=1550;
1032   6                                                       }
1033   5                                                        speed_right=1300;
1034   5                                                       adjustDirection_1((int)speed_left,1300);
1035   5      //                                               sprintf(buf1,"左转");
1036   5      //                                              speak_len1=strlen(( const char *)buf1);
1037   5      //                                              speak_context((u8*)buf1,speak_len1);
1038   5                                               }
1039   4                                      
1040   4                                       else //正向
1041   4                                               {
1042   5                                                       //远离中心线
1043   5                                                               
1044   5                                                       speed_left=1700-error_dis;
1045   5                                                       if(speed_left<=1500)
1046   5                                                       {
1047   6                                                               speed_left=1550;
1048   6                                                       }
1049   5                                                        speed_right=1300;
1050   5                                                       adjustDirection_1((int)speed_left,1300);                               
1051   5                                               }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 19  

1052   4                               }       
1053   3                       }
1054   2               }
1055   1      }
1056          void Circulation_wall_left2(void)
1057          {       
1058   1               last_dis=left_dis;
1059   1               front_dis= kalmanfilter(Ultrasonic_Get_Front(),1);
1060   1               //right_dis = Ultrasonic_Get_Right();
1061   1               left_dis = Ultrasonic_Get_Left();
1062   1              
1063   1              
1064   1              if(left_dis > 320)//右边不靠墙时扫描左边与墙的距离
1065   1               {
1066   2                       left_dis = Ultrasonic_Get_Left();
1067   2      //                forwardOneStep();
1068   2      //                forwardOneStep();
1069   2      //                forwardOneStep();
1070   2      //                forwardOneStep();
1071   2      //                forwardOneStep(); 
1072   2                       
1073   2                       
1074   2                       
1075   2                       speed_right=1300;
1076   2                       speed_left=1700;
1077   2                       adjustDirection_1(speed_left,speed_right);
1078   2      //               sprintf(buf1,"直行");
1079   2      //              
1080   2      //              speak_len1=strlen(( const char *)buf1);
1081   2      //              speak_context((u8*)buf1,speak_len1);    
1082   2               }
1083   1      /////////////////////////////
1084   1      //--------------------小车离墙距离小于172mm
1085   1      /////////////////////////       
1086   1                else if(left_dis <=140)//turn right
1087   1               {
1088   2                       error_dis=(140-left_dis)*kp_dis;
1089   2      /////////////////////////////
1090   2      //小车离中心线大于50mm，只有位置环pid，没有方向环pid
1091   2      /////////////////////////                        
1092   2                       if(140-left_dis>50)
1093   2                       {
1094   3                               kp_dis=kp_dis_samll;
1095   3                               kp_dir=kp_dir_small;
1096   3                               error_dir=0.0;
1097   3                                error_dis=(140-left_dis)*kp_dis;
1098   3                               speed_right=1300+error_dis;
1099   3                                if(speed_right>=1500)
1100   3                                       {
1101   4                                               speed_right=1450;
1102   4                                              
1103   4                                       }
1104   3                          speed_left=1700;
1105   3                              adjustDirection_1(speed_left,(int)speed_right);
1106   3      //                      sprintf(buf1,"右转");
1107   3      //                      speak_len1=strlen(( const char *)buf1);
1108   3      //                      speak_context((u8*)buf1,speak_len1);    
1109   3                               
1110   3                       }
1111   2                       else
1112   2                       {
1113   3      /////////////////////////////
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 20  

1114   3      //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
1115   3      /////////////////////////       
1116   3                               if(140-left_dis>30)
1117   3                               {
1118   4                                       kp_dis=kp_dis_mid;
1119   4                                       kp_dir=kp_dir_mid;
1120   4                                        error_dis=(140-left_dis)*kp_dis;
1121   4                                       error_dir=(last_dis-left_dis)*kp_dir;
1122   4                                       if((last_dis-left_dis)>0)//--------------朝左
1123   4                                       {
1124   5                                               //远离中心线
1125   5                                              speed_right=1300+error_dis+error_dir;
1126   5                                                if(speed_right>=1500)
1127   5                                               {
1128   6                                                       speed_right=1450;
1129   6                                                        
1130   6                                               }
1131   5                                               speed_left=1700;
1132   5                                               adjustDirection_1(1700,(int)speed_right);
1133   5                                       }
1134   4                                       else                  //--------------朝右
1135   4                                       {
1136   5                                               //靠近中心线
1137   5                                                if(-(error_dir)>=0.9*error_dis)
1138   5                                               {
1139   6                                                       error_dir=-0.9*error_dis;
1140   6                                               }
1141   5      
1142   5                                                speed_right=1300+error_dis+error_dir;
1143   5                                                if(speed_right>=1500)
1144   5                                               {
1145   6                                                       speed_right=1450;
1146   6                                                      
1147   6                                               }
1148   5                                                 speed_left=1700;
1149   5                                               adjustDirection_1(speed_left,(int)speed_right);
1150   5                                       }
1151   4      //                               sprintf(buf1,"右转");
1152   4      //                              speak_len1=strlen(( const char *)buf1);
1153   4      //                              speak_context((u8*)buf1,speak_len1);    
1154   4                               }
1155   3                               else
1156   3                               {
1157   4      /////////////////////////////
1158   4      //小车离中心线小于30mm，有位置环pid，有方向环pid
1159   4      /////////////////////////                                        
1160   4                                       
1161   4                                                kp_dis=kp_dis_big;
1162   4                                                kp_dir=kp_dir_big;
1163   4                                                error_dis=(140-left_dis)*kp_dis;
1164   4                                                error_dir=(last_dis-left_dis)*kp_dir;
1165   4                                               if((last_dis-left_dis)>0)  //--------------朝左
1166   4                                               {
1167   5                                                       //远离中心线
1168   5                                                      speed_right=1300+error_dis+error_dir;
1169   5                                                        if(speed_right>=1500)
1170   5                                                       {
1171   6                                                               speed_right=1450;
1172   6                                                       }
1173   5                                                        speed_left=1700;
1174   5                                                       adjustDirection_1(1700,(int)speed_right);
1175   5      //                                                sprintf(buf1,"右转");
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 21  

1176   5      //                                              speak_len1=strlen(( const char *)buf1);
1177   5      //                                              speak_context((u8*)buf1,speak_len1);    
1178   5                                               }
1179   4                                               else if((last_dis-left_dis)<0)      //--------------朝右适当鼓励dir-
1180   4                                               {
1181   5                                                       //靠近中心线
1182   5              //                                        if(-(error_dir)>=0.9*error_dis)
1183   5              //                                       {
1184   5              //                                               error_dir=-0.9*error_dis;
1185   5              //                                       }
1186   5              //                                        speed_right=1300+error_dis+error_dir;
1187   5              //                                        if(speed_right>=1500)
1188   5              //                                       {
1189   5              //                                               speed_right=1450;
1190   5              //                                       }
1191   5              //                                       adjustDirection_1(1700,(int)speed_right);
1192   5                                                       //转中的转
1193   5                                                        //右转是大环境，这里离目标线很近，需要调整车头左拐，防止超调
1194   5                                                       
1195   5                                                      speed_left=1700+error_dis+error_dir*0.6;  //---适当鼓励朝右
1196   5                                                        if(speed_left<=1500)
1197   5                                                       {
1198   6                                                               speed_left=1550;
1199   6                                                       }
1200   5                                                       speed_right=1300;
1201   5                                                       adjustDirection_1((int)speed_left,1300);
1202   5                                               
1203   5                                                       
1204   5                                               }
1205   4                                       else //正向
1206   4                                               {
1207   5                                                       //远离中心线
1208   5                                                               
1209   5                                                       speed_right=1300+error_dis;
1210   5                                                       if(speed_right>=1500)
1211   5                                                       {
1212   6                                                               speed_right=1450;
1213   6                                                       }
1214   5                                                        speed_left=1700;
1215   5                                                       adjustDirection_1(1700,(int)speed_right);                                      
1216   5                                               }
1217   4                                       
1218   4                                      
1219   4                               }
1220   3                              
1221   3                                       
1222   3                       }
1223   2                       
1224   2      //               sprintf(buf1,"F=%d,L=%d,s_l=1700,s_r=%d\n",front_dis,left_dis,(int)speed_right);
1225   2      //              speak_len1=strlen(( const char *)buf1);
1226   2      //              for( s_i = 0 ; s_i < speak_len1; s_i++) 
1227   2      //              {
1228   2      //      //              while((USART3->SR&0X40)==0);  
1229   2      //      //              USART3->DR = DataScope_OutPut_Buffer2[s_i]; 
1230   2      //                      while((USART1->SR&0X40)==0);  
1231   2      //                      USART1->DR = buf1[s_i];                                                                              
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 22  

             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                                                                                                        
             -                                          
1232   2      //              }
1233   2      
1234   2                              
1235   2               }
1236   1      /////////////////////////////
1237   1      //小车离墙距离大于172mm
1238   1      /////////////////////////        
1239   1               else//turn left
1240   1               {
1241   2                       error_dis=(left_dis-140)*kp_dis;
1242   2      /////////////////////////////
1243   2      //小车离中心线大于50mm，只有位置环pid，没有方向环pid
1244   2      /////////////////////////                
1245   2                       if(left_dis-140>50)
1246   2                       {
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 23  

1247   3                               kp_dis=kp_dis_samll;
1248   3                               kp_dir=kp_dir_small;
1249   3                               error_dis=(left_dis-140)*kp_dis;
1250   3                               error_dir=0.0;
1251   3                               speed_left=1700-error_dis;
1252   3                               if(speed_left<=1500)
1253   3                               {
1254   4                                       speed_left=1550;
1255   4                               }
1256   3                                speed_right=1300;
1257   3                               adjustDirection_1((int)speed_left,1300);
1258   3                               
1259   3      //                       sprintf(buf1,"左转");
1260   3      //                      speak_len1=strlen(( const char *)buf1);
1261   3      //                      speak_context((u8*)buf1,speak_len1);
1262   3                               
1263   3                       }
1264   2                       else
1265   2                       {
1266   3      /////////////////////////////
1267   3      //小车离中心线小于50mm，大于30mm，有位置环pid，有方向环pid
1268   3      /////////////////////////                       
1269   3                               if(left_dis-140>30)
1270   3                               {
1271   4                                         kp_dis=kp_dis_mid;
1272   4                                         kp_dir=kp_dir_mid;
1273   4                                       error_dis=(left_dis-140)*kp_dis;
1274   4                                       error_dir=(last_dis-left_dis)*kp_dir;
1275   4                                       
1276   4                                       if((last_dis-left_dis)>0)//---------朝左
1277   4                                       {
1278   5                                               //靠近中心线
1279   5                                                if(error_dir>=0.9*error_dis)
1280   5                                               {
1281   6                                                       error_dir=0.9*error_dis;
1282   6                                               }
1283   5                                               speed_left=1700-error_dis+error_dir;
1284   5                                                if(speed_left<=1500)
1285   5                                               {
1286   6                                                       speed_left=1550;
1287   6                                               }
1288   5                                                speed_right=1300;
1289   5                                               adjustDirection_1((int)speed_left,1300);
1290   5      
1291   5                                                
1292   5                                       }
1293   4                                       else       //---------朝右
1294   4                                       {
1295   5                                               //远近中心线
1296   5                                              speed_left=1700-error_dis+error_dir*0.8;
1297   5                                                if(speed_left<=1500)
1298   5                                               {
1299   6                                                       speed_left=1550;
1300   6                                               }
1301   5                                                speed_right=1300;
1302   5                                               adjustDirection_1((int)speed_left,1300);
1303   5                                       }
1304   4      //                               sprintf(buf1,"左转");
1305   4      //                              speak_len1=strlen(( const char *)buf1);
1306   4      //                              speak_context((u8*)buf1,speak_len1);
1307   4                               }
1308   3                               else
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 24  

1309   3                               {
1310   4              
1311   4                                       
1312   4                                       kp_dis=kp_dis_big;
1313   4                                        kp_dir=kp_dir_big;
1314   4                                       error_dis=(left_dis-140)*kp_dis;
1315   4      /////////////////////////////
1316   4      //小车离中心线小于30mm，--10mm，有位置环pid，有方向环pid
1317   4      /////////////////////////
1318   4                                      
1319   4                                              error_dir=(last_dis-left_dis)*kp_dir;
1320   4                                               if((last_dis-left_dis)>0)//---------朝左适当鼓励
1321   4                                               {
1322   5                                                       //靠近中心线
1323   5                                                       
1324   5              
1325   5                                                       //左转是大环境，这里离目标线很近，需要调整车头右拐，防止超调
1326   5                                                       speed_right=1300-error_dis+error_dir*0.6;
1327   5                                                        if(speed_right>=1500)
1328   5                                                       {
1329   6                                                               speed_right=1450;
1330   6                                                       }
1331   5                                                        speed_left=1700;
1332   5                                                       adjustDirection_1(1700,(int)speed_right);
1333   5                                                       
1334   5      //                                               sprintf(buf1,"右转");
1335   5      //                                              speak_len1=strlen(( const char *)buf1);
1336   5      //                                              speak_context((u8*)buf1,speak_len1);
1337   5      
1338   5                                                        
1339   5                                               }
1340   4                                      else if((last_dis-left_dis)<0) //---------朝右
1341   4                                               {
1342   5                                                       //远近中心线
1343   5                                                      speed_left=1700-error_dis+error_dir*0.9;
1344   5                                                        if(speed_left<=1500)
1345   5                                                       {
1346   6                                                               speed_left=1550;
1347   6                                                       }
1348   5                                                        speed_right=1300;
1349   5                                                       adjustDirection_1((int)speed_left,1300);
1350   5      //                                               sprintf(buf1,"左转");
1351   5      //                                              speak_len1=strlen(( const char *)buf1);
1352   5      //                                              speak_context((u8*)buf1,speak_len1);
1353   5                                               }
1354   4                                      
1355   4                                       else //正向
1356   4                                               {
1357   5                                                       //远离中心线
1358   5                                                               
1359   5                                                       speed_left=1700-error_dis;
1360   5                                                       if(speed_left<=1500)
1361   5                                                       {
1362   6                                                               speed_left=1550;
1363   6                                                       }
1364   5                                                        speed_right=1300;
1365   5                                                       adjustDirection_1((int)speed_left,1300);                               
1366   5                                               }
1367   4                               }       
1368   3                       }
1369   2               }
1370   1      }
C51 COMPILER V9.60.7.0   ACTION                                                            11/03/2023 14:00:34 PAGE 25  

1371          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   9038    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    132    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     48       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
